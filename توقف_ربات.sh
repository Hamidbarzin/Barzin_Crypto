#!/bin/bash

# ุงุณฺฉุฑูพุช ุชููู ุฑุจุงุช ุชูฺฏุฑุงู
# ุงู ุงุณฺฉุฑูพุช ุณุฑูุณ ูพุณโุฒููู ุฑุจุงุช ุฑุง ูุชููู ูโฺฉูุฏ

# ูุญู ูพุฑูฺู ุฑุง ุจู ุนููุงู ุฏุงุฑฺฉุชูุฑ ูุนู ุชูุธู ฺฉูุฏ
cd "$(dirname "$0")"

# ุซุจุช ูุงฺฏ ุดุฑูุน
echo "$(date) - ุดุฑูุน ุชููู ุฑุจุงุช ุงุฑุฒ ุฏุฌุชุงู" > ุชููู_ุฑุจุงุช.log

# ุชููู screen ุงฺฏุฑ ูุฌูุฏ ุฏุงุฑุฏ
if command -v screen >/dev/null 2>&1; then
    echo "$(date) - ุชููู screen..." >> ุชููู_ุฑุจุงุช.log
    screen -S crypto_scheduler -X quit >/dev/null 2>&1
    echo "$(date) - screen ุจุง ููููุช ูุชููู ุดุฏ." >> ุชููู_ุฑุจุงุช.log
fi

# ุชููู ูุฑุขูุฏ ุงฺฏุฑ PID ูุฌูุฏ ุฏุงุฑุฏ
if [ -f scheduler.pid ]; then
    echo "$(date) - ุชููู ูุฑุขูุฏ ุจุง ุดูุงุณู $(cat scheduler.pid)..." >> ุชููู_ุฑุจุงุช.log
    if kill -0 $(cat scheduler.pid) >/dev/null 2>&1; then
        kill $(cat scheduler.pid) >/dev/null 2>&1
        echo "$(date) - ูุฑุขูุฏ ุจุง ููููุช ูุชููู ุดุฏ." >> ุชููู_ุฑุจุงุช.log
    else
        echo "$(date) - ูุฑุขูุฏ ูุจูุงู ูุชููู ุดุฏู ุงุณุช." >> ุชููู_ุฑุจุงุช.log
    fi
    rm -f scheduler.pid
else
    echo "$(date) - ูุงู PID ูพุฏุง ูุดุฏ. ุฑุจุงุช ุงุญุชูุงูุงู ุฏุฑ ุญุงู ุงุฌุฑุง ูุณุช." >> ุชููู_ุฑุจุงุช.log
fi

# ุงุฑุณุงู ูพุงู ุชููู ุจู ุชูฺฏุฑุงู
echo "$(date) - ุงุฑุณุงู ูพุงู ุชููู ุจู ุชูฺฏุฑุงู..." >> ุชููู_ุฑุจุงุช.log
python -c "
import sys
import os
from datetime import datetime
sys.path.append(os.getcwd())
try:
    from crypto_bot.telegram_service import send_telegram_message
    message = f\"๐ด ุฑุจุงุช ุงุฑุฒ ุฏุฌุชุงู ูุชููู ุดุฏ\\n\\nุฒูุงู: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\\n\\nุฑุจุงุช ุจุง ุฏุณุชูุฑ ฺฉุงุฑุจุฑ ูุชููู ุดุฏ ู ุฏฺฏุฑ ฺฏุฒุงุฑุดโูุง ุฏูุฑูโุง ุงุฑุณุงู ูุฎูุงูุฏ ุดุฏ.\"
    send_telegram_message(message)
    print('ูพุงู ุชููู ุจุง ููููุช ุงุฑุณุงู ุดุฏ.')
except Exception as e:
    print(f'ุฎุทุง ุฏุฑ ุงุฑุณุงู ูพุงู ุชููู: {str(e)}')
" >> ุชููู_ุฑุจุงุช.log 2>&1

echo "$(date) - ูพุงุงู ุชููู ุฑุจุงุช ุงุฑุฒ ุฏุฌุชุงู" >> ุชููู_ุฑุจุงุช.log
echo ""
echo "ุฑุจุงุช ุงุฑุฒ ุฏุฌุชุงู ุจุง ููููุช ูุชููู ุดุฏ ู ุฏฺฏุฑ ฺฏุฒุงุฑุดโูุง ุฏูุฑูโุง ุงุฑุณุงู ูุฎูุงูุฏ ุดุฏ."
