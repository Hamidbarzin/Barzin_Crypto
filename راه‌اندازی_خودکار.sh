#!/bin/bash

# ุงุณฺฉุฑูพุช ุฑุงูโุงูุฏุงุฒ ุฎูุฏฺฉุงุฑ ุจุฑุง ุงุฌุฑุง ุฑุจุงุช ุฏุฑ ุฒูุงู ุดุฑูุน ุณุณุชู
# ุงู ูุงู ูุณุฎู ูุงุฑุณ startup.sh ุงุณุช

echo "ุดุฑูุน ุฑุงูโุงูุฏุงุฒ ุฎูุฏฺฉุงุฑ ุฑุจุงุช ุชูฺฏุฑุงู ุฏุฑ ุชุงุฑุฎ $(date)" > ุฑุงูโุงูุฏุงุฒ_ุฎูุฏฺฉุงุฑ.log
echo "----------------------------------------" >> ุฑุงูโุงูุฏุงุฒ_ุฎูุฏฺฉุงุฑ.log

# ุจุฑุฑุณ ูุฌูุฏ ูุงูโูุง ูุงุฒู
if [ ! -f "ten_minute_scheduler.py" ]; then
    echo "ุฎุทุง: ูุงู ten_minute_scheduler.py ุงูุช ูุดุฏ!" >> ุฑุงูโุงูุฏุงุฒ_ุฎูุฏฺฉุงุฑ.log
    exit 1
fi

if [ ! -f "enhanced_telegram_reporter.py" ]; then
    echo "ุฎุทุง: ูุงู enhanced_telegram_reporter.py ุงูุช ูุดุฏ!" >> ุฑุงูโุงูุฏุงุฒ_ุฎูุฏฺฉุงุฑ.log
    exit 1
fi

# ุชููู ูุฑ ููููู ุฏุฑ ุญุงู ุงุฌุฑุง
echo "ุฏุฑ ุญุงู ุชููู ูููููโูุง ูุจู..." >> ุฑุงูโุงูุฏุงุฒ_ุฎูุฏฺฉุงุฑ.log
pids=$(ps aux | grep "ten_minute_scheduler.py" | grep -v grep | awk '{print $2}')
if [ -n "$pids" ]; then
    for p in $pids; do
        echo "ุชููู ูุฑุขูุฏ $p..." >> ุฑุงูโุงูุฏุงุฒ_ุฎูุฏฺฉุงุฑ.log
        kill -9 $p 2>/dev/null
    done
    echo "ูุฑุขูุฏูุง ูุจู ูุชููู ุดุฏูุฏ." >> ุฑุงูโุงูุฏุงุฒ_ุฎูุฏฺฉุงุฑ.log
else
    echo "ูฺ ูุฑุขูุฏ ูุจู ุงูุช ูุดุฏ." >> ุฑุงูโุงูุฏุงุฒ_ุฎูุฏฺฉุงุฑ.log
fi

# ุญุฐู ูุงูโูุง PID ูุฏู
rm -f ten_minute_scheduler.pid 2>/dev/null

echo "ุฏุฑ ุญุงู ุฑุงูโุงูุฏุงุฒ ุฑุจุงุช ุงุฑุณุงู ฺฏุฒุงุฑุด..." >> ุฑุงูโุงูุฏุงุฒ_ุฎูุฏฺฉุงุฑ.log

# ุฑุงูโุงูุฏุงุฒ ุงุณฺฉุฑูพุช ุฒูุงูโุจูุฏ
PYTHONUNBUFFERED=1 nohup python ten_minute_scheduler.py > ten_minute_scheduler.log 2>&1 &
echo $! > ten_minute_scheduler.pid

echo "ุฑุจุงุช ุจุง ุดูุงุณู ูุฑุขูุฏ $(cat ten_minute_scheduler.pid) ุฑุงูโุงูุฏุงุฒ ุดุฏ." >> ุฑุงูโุงูุฏุงุฒ_ุฎูุฏฺฉุงุฑ.log
echo "ุจุฑุง ูุดุงูุฏู ูุถุนุช: tail -f ten_minute_scheduler.log" >> ุฑุงูโุงูุฏุงุฒ_ุฎูุฏฺฉุงุฑ.log
echo "ูพุงุงู ุฑุงูโุงูุฏุงุฒ ุฎูุฏฺฉุงุฑ ุฏุฑ ุชุงุฑุฎ $(date)" >> ุฑุงูโุงูุฏุงุฒ_ุฎูุฏฺฉุงุฑ.log
echo "----------------------------------------" >> ุฑุงูโุงูุฏุงุฒ_ุฎูุฏฺฉุงุฑ.log

# ุงุฑุณุงู ฺฉ ูพุงู ุชุงุฏ ุจู ุชูฺฏุฑุงู
echo "ุฏุฑ ุญุงู ุงุฑุณุงู ูพุงู ุงุทูุงุนโุฑุณุงู ุจู ุชูฺฏุฑุงู..." >> ุฑุงูโุงูุฏุงุฒ_ุฎูุฏฺฉุงุฑ.log
python -c "
import os
import sys
from datetime import datetime
try:
    from crypto_bot.telegram_service import send_telegram_message
    chat_id = os.environ.get('DEFAULT_CHAT_ID', '722627622')
    message = f'''๐ค *ุฑุงูโุงูุฏุงุฒ ูุฌุฏุฏ ุฑุจุงุช*
    
ุฑุจุงุช ฺฏุฒุงุฑุดโุฏู ุจุง ููููุช ุฑุงูโุงูุฏุงุฒ ุดุฏ.
ุฒูุงู ุฑุงูโุงูุฏุงุฒ: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}

ฺฏุฒุงุฑุดโูุง ุฏูุฑูโุง ูุฑ ฑฐ ุฏููู ุงุฑุณุงู ุฎูุงููุฏ ุดุฏ.
ูุถุนุช ุณุณุชู ูุฑ ถ ุณุงุนุช ุงุฑุณุงู ูโุดูุฏ.

ุงู ูพุงู ุจู ุตูุฑุช ุฎูุฏฺฉุงุฑ ูพุณ ุงุฒ ุฑุงูโุงูุฏุงุฒ ุณุณุชู ุงุฑุณุงู ุดุฏู ุงุณุช.
    '''
    result = send_telegram_message(chat_id, message)
    print(f'ูุชุฌู ุงุฑุณุงู ูพุงู ุฑุงูโุงูุฏุงุฒ: {result}')
except Exception as e:
    print(f'ุฎุทุง ุฏุฑ ุงุฑุณุงู ูพุงู ุงุทูุงุนโุฑุณุงู: {str(e)}')
" >> ุฑุงูโุงูุฏุงุฒ_ุฎูุฏฺฉุงุฑ.log 2>&1

echo "ุงุณฺฉุฑูพุช ุฑุงูโุงูุฏุงุฒ ุจุง ููููุช ุงุฌุฑุง ุดุฏ."
