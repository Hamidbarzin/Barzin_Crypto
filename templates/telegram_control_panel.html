{% extends "minimal_base.html" %}

{% block title %}پنل مدیریت تلگرام{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-12">
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">پنل مدیریت تلگرام Crypto Barzin <span id="service-status"></span></h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <div class="card h-100">
                                <div class="card-header bg-info text-white">
                                    <h5 class="mb-0">گزارش‌های عمومی</h5>
                                </div>
                                <div class="card-body">
                                    <div class="d-grid gap-2">
                                        <a href="/send_price_report" class="btn btn-success">
                                            <i class="fas fa-chart-line me-2"></i>ارسال گزارش قیمت
                                        </a>
                                        <a href="/send_system_report" class="btn btn-primary">
                                            <i class="fas fa-server me-2"></i>ارسال گزارش سیستم
                                        </a>
                                        <a href="/api/telegram-test" class="btn btn-warning">
                                            <i class="fas fa-vial me-2"></i>ارسال پیام تست
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6 mb-3">
                            <div class="card h-100">
                                <div class="card-header bg-success text-white">
                                    <h5 class="mb-0">سیگنال‌ها و تحلیل‌ها</h5>
                                </div>
                                <div class="card-body">
                                    <div class="d-grid gap-2">
                                        <a href="/send_trading_signals" class="btn btn-primary">
                                            <i class="fas fa-signal me-2"></i>ارسال سیگنال‌های معاملاتی
                                        </a>
                                        <div class="input-group mb-2">
                                            <input type="text" class="form-control" id="technical-symbol" placeholder="نماد مورد نظر" value="BTC/USDT">
                                            <a href="/send_technical_analysis?symbol=BTC/USDT" class="btn btn-secondary">
                                                <i class="fas fa-chart-bar me-2"></i>ارسال تحلیل تکنیکال
                                            </a>
                                        </div>
                                        <a href="/send_crypto_news" class="btn btn-info">
                                            <i class="fas fa-newspaper me-2"></i>ارسال اخبار ارزهای دیجیتال
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mb-4">
                        <div class="col-md-12">
                            <div class="card">
                                <div class="card-header bg-dark text-white">
                                    <h5 class="mb-0">کنترل سرویس زمان‌بندی</h5>
                                </div>
                                <div class="card-body">
                                    <div class="d-flex gap-2">
                                        <button class="btn btn-success flex-grow-1" id="btn-start-service">
                                            <i class="fas fa-play me-2"></i>راه‌اندازی سرویس
                                        </button>
                                        <button class="btn btn-danger flex-grow-1" id="btn-stop-service">
                                            <i class="fas fa-stop me-2"></i>توقف سرویس
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row mt-4">
                        <div class="col-md-12">
                            <div class="card mb-4">
                                <div class="card-header bg-primary text-white">
                                    <h5 class="mb-0">تنظیمات زمان‌بندی ارسال پیام</h5>
                                </div>
                                <div class="card-body">
                                    {% if settings_saved %}
                                    <div class="alert alert-success alert-dismissible fade show mb-4">
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-check-circle me-2 text-success fa-2x"></i>
                                            <div>
                                                <strong>موفقیت!</strong> تنظیمات با موفقیت ذخیره شد. تغییرات شما اعمال شد.
                                            </div>
                                        </div>
                                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                                    </div>
                                    {% endif %}
                                    
                                    {% if settings_error %}
                                    <div class="alert alert-danger alert-dismissible fade show mb-4">
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-exclamation-circle me-2 text-danger fa-2x"></i>
                                            <div>
                                                <strong>خطا!</strong> {{ settings_error }}
                                            </div>
                                        </div>
                                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                                    </div>
                                    {% endif %}
                                    
                                    <form action="/telegram_control_panel" method="POST">
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <div class="form-check form-switch mb-3">
                                                    <input class="form-check-input" type="checkbox" id="message-sending-enabled" name="message_sending_enabled" {% if status and status.message_sending_enabled %}checked{% endif %}>
                                                    <label class="form-check-label" for="message-sending-enabled">ارسال خودکار پیام فعال باشد</label>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="form-check form-switch mb-3">
                                                    <input class="form-check-input" type="checkbox" id="auto-start-on-boot" name="auto_start_on_boot" {% if status and status.auto_start_on_boot %}checked{% endif %}>
                                                    <label class="form-check-label" for="auto-start-on-boot">راه‌اندازی خودکار سرویس هنگام شروع برنامه</label>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label for="active-hours-start" class="form-label">ساعت شروع ارسال پیام (8 = 8 صبح)</label>
                                                <input type="number" class="form-control" id="active-hours-start" name="active_hours_start" min="0" max="23" value="{{ status.active_hours_start|default(8) }}">
                                                <div class="form-text">ساعت به وقت تورنتو - بین 0 تا 23</div>
                                            </div>
                                            <div class="col-md-6">
                                                <label for="active-hours-end" class="form-label">ساعت پایان ارسال پیام (22 = 10 شب)</label>
                                                <input type="number" class="form-control" id="active-hours-end" name="active_hours_end" min="1" max="24" value="{{ status.active_hours_end|default(22) }}">
                                                <div class="form-text">ساعت به وقت تورنتو - بین 1 تا 24</div>
                                            </div>
                                        </div>
                                        
                                        <div class="row mb-3">
                                            <div class="col-md-12">
                                                <label for="interval" class="form-label">فاصله زمانی ارسال گزارش قیمت (به ثانیه)</label>
                                                <select class="form-select" id="interval" name="interval">
                                                    <option value="300" {% if status and status.interval == 300 %}selected{% endif %}>5 دقیقه (300 ثانیه)</option>
                                                    <option value="600" {% if status and status.interval == 600 %}selected{% endif %}>10 دقیقه (600 ثانیه)</option>
                                                    <option value="900" {% if status and status.interval == 900 %}selected{% endif %}>15 دقیقه (900 ثانیه)</option>
                                                    <option value="1800" {% if status and status.interval == 1800 or not status %}selected{% endif %}>30 دقیقه (1800 ثانیه)</option>
                                                    <option value="3600" {% if status and status.interval == 3600 %}selected{% endif %}>1 ساعت (3600 ثانیه)</option>
                                                </select>
                                            </div>
                                        </div>
                                        
                                        <div class="d-grid">
                                            <button type="submit" class="btn btn-success">
                                                <i class="fas fa-save me-2"></i>ذخیره تنظیمات
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mt-2">
                        <div class="col-md-12">
                            <div class="card">
                                <div class="card-header bg-secondary text-white">
                                    <h5 class="mb-0">نتایج</h5>
                                </div>
                                <div class="card-body">
                                    <div id="result-container" class="alert d-none">
                                        <span id="result-message"></span>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <button class="btn btn-outline-primary" id="btn-refresh-status">
                                            <i class="fas fa-sync-alt me-2"></i>بروزرسانی وضعیت
                                        </button>
                                        <div>
                                            <a href="/telegram-reliability" class="btn btn-outline-info">
                                                <i class="fas fa-chart-pie me-2"></i>آمار قابلیت اطمینان
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // نمایش نتیجه عملیات
    function showResult(message, success = true) {
        const resultContainer = document.getElementById('result-container');
        const resultMessage = document.getElementById('result-message');
        
        resultContainer.className = success ? 'alert alert-success' : 'alert alert-danger';
        resultMessage.textContent = message;
        resultContainer.classList.remove('d-none');
        
        // اسکرول به سمت نتایج
        resultContainer.scrollIntoView({ behavior: 'smooth' });
    }
    
    // تابع عمومی برای ارسال درخواست API
    async function callApi(endpoint, method = 'GET', data = null, showMessages = true) {
        try {
            console.log(`Calling endpoint: ${endpoint} with method: ${method}`);
            const options = {
                method: method,
                headers: {
                    'Content-Type': 'application/json'
                }
            };
            
            if (data && (method === 'POST' || method === 'PUT')) {
                options.body = JSON.stringify(data);
            }
            
            const response = await fetch(endpoint, options);
            console.log(`Response status: ${response.status}`);
            const result = await response.json();
            console.log('API response:', result);
            
            if (showMessages) {
                if (result.success) {
                    showResult(result.message, true);
                } else {
                    showResult(result.message || 'خطایی رخ داده است', false);
                }
            }
            
            return result;
        } catch (error) {
            console.error('خطا در ارسال درخواست:', error);
            if (showMessages) {
                showResult(`خطا در ارسال درخواست: ${error.message}`, false);
            }
            return null;
        }
    }
    
    // ارسال گزارش قیمت
    document.getElementById('btn-price-report').addEventListener('click', async function() {
        this.disabled = true;
        await callApi('/api/telegram/price_report');
        this.disabled = false;
    });
    
    // ارسال گزارش سیستم
    document.getElementById('btn-system-report').addEventListener('click', async function() {
        console.log('System report button clicked');
        this.disabled = true;
        try {
            const button = this;
            button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>در حال ارسال...';
            
            // استفاده مستقیم از fetch به جای callApi
            const response = await fetch('/api/telegram/system_report');
            console.log('System report raw response:', response);
            
            if (response.ok) {
                const result = await response.json();
                console.log('System report API call completed:', result);
                showResult(result.message || 'گزارش سیستم با موفقیت ارسال شد', true);
            } else {
                console.error('System report API call failed with status:', response.status);
                showResult('خطا در ارسال گزارش سیستم', false);
            }
            
            button.innerHTML = '<i class="fas fa-server me-2"></i>ارسال گزارش سیستم';
        } catch (error) {
            console.error('Error in system report:', error);
            showResult(`خطا در ارسال درخواست: ${error.message}`, false);
        }
        this.disabled = false;
    });
    
    // ارسال پیام تست
    document.getElementById('btn-test-message').addEventListener('click', async function() {
        console.log('Test message button clicked');
        this.disabled = true;
        try {
            const button = this;
            button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>در حال ارسال...';
            
            // استفاده مستقیم از fetch به جای callApi
            const response = await fetch('/api/telegram/test');
            console.log('Test message raw response:', response);
            
            if (response.ok) {
                const result = await response.json();
                console.log('Test message API call completed:', result);
                showResult(result.message || 'پیام تست با موفقیت ارسال شد', true);
            } else {
                console.error('Test message API call failed with status:', response.status);
                showResult('خطا در ارسال پیام تست', false);
            }
            
            button.innerHTML = '<i class="fas fa-vial me-2"></i>ارسال پیام تست';
        } catch (error) {
            console.error('Error in test message:', error);
            showResult(`خطا در ارسال درخواست: ${error.message}`, false);
        }
        this.disabled = false;
    });
    
    // ارسال سیگنال‌های معاملاتی
    document.getElementById('btn-trading-signals').addEventListener('click', async function() {
        console.log('Trading signals button clicked');
        this.disabled = true;
        try {
            const button = this;
            button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>در حال ارسال...';
            
            // استفاده مستقیم از fetch به جای callApi
            const response = await fetch('/api/telegram/trading_signals');
            console.log('Trading signals raw response:', response);
            
            if (response.ok) {
                const result = await response.json();
                console.log('Trading signals API call completed:', result);
                showResult(result.message || 'سیگنال‌های معاملاتی با موفقیت ارسال شد', true);
            } else {
                console.error('Trading signals API call failed with status:', response.status);
                showResult('خطا در ارسال سیگنال‌های معاملاتی', false);
            }
            
            button.innerHTML = '<i class="fas fa-signal me-2"></i>ارسال سیگنال‌های معاملاتی';
        } catch (error) {
            console.error('Error in trading signals:', error);
            showResult(`خطا در ارسال درخواست: ${error.message}`, false);
        }
        this.disabled = false;
    });
    
    // ارسال تحلیل تکنیکال
    document.getElementById('btn-technical-analysis').addEventListener('click', async function() {
        this.disabled = true;
        const symbol = document.getElementById('technical-symbol').value || 'BTC/USDT';
        await callApi(`/api/telegram/technical_analysis?symbol=${encodeURIComponent(symbol)}`);
        this.disabled = false;
    });
    
    // ارسال اخبار ارزهای دیجیتال
    document.getElementById('btn-crypto-news').addEventListener('click', async function() {
        this.disabled = true;
        // فراخوانی API با متد POST
        await callApi('/api/telegram/send-news', 'POST');
        this.disabled = false;
    });
    
    // بروزرسانی وضعیت
    document.getElementById('btn-refresh-status').addEventListener('click', async function() {
        this.disabled = true;
        const result = await callApi('/api/telegram/status');
        if (result && result.running) {
            showResult(`سرویس زمان‌بندی تلگرام در حال اجراست. ایجاد شده در: ${result.created_at}`, true);
        } else if (result) {
            showResult('سرویس زمان‌بندی تلگرام در حال اجرا نیست.', false);
        }
        this.disabled = false;
    });
    
    // ذخیره تنظیمات
    document.getElementById('btn-save-settings').addEventListener('click', async function() {
        this.disabled = true;
        
        // دریافت مقادیر فرم
        const messageSendingEnabled = document.getElementById('message-sending-enabled').checked;
        const autoStartOnBoot = document.getElementById('auto-start-on-boot').checked;
        const activeHoursStart = parseInt(document.getElementById('active-hours-start').value, 10);
        const activeHoursEnd = parseInt(document.getElementById('active-hours-end').value, 10);
        const interval = parseInt(document.getElementById('interval').value, 10);
        
        // ساخت آبجکت تنظیمات
        const settings = {
            message_sending_enabled: messageSendingEnabled,
            auto_start_on_boot: autoStartOnBoot,
            active_hours_start: activeHoursStart,
            active_hours_end: activeHoursEnd,
            interval: interval
        };
        
        try {
            // ارسال درخواست به API بدون نمایش خودکار پیام
            const options = {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(settings)
            };
            
            // نمایش فوری پیام موفقیت بالای صفحه (بدون منتظر ماندن برای نتیجه درخواست)
            const successAlert = document.createElement('div');
            successAlert.className = 'alert alert-success alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-4 shadow-lg';
            successAlert.style.zIndex = '1050';
            successAlert.innerHTML = `
                <div class="d-flex align-items-center">
                    <i class="fas fa-check-circle me-2 text-success fa-2x"></i>
                    <div>
                        <strong>موفقیت!</strong> تنظیمات با موفقیت ذخیره شد. تغییرات شما اعمال شد.
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            document.body.appendChild(successAlert);
            
            // حذف اتوماتیک پیام بعد از 5 ثانیه
            setTimeout(() => {
                successAlert.remove();
            }, 5000);
            
            // ارسال درخواست در پس‌زمینه
            try {
                const response = await fetch('/api/telegram/settings', options);
                const result = await response.json();
                console.log("نتیجه درخواست:", result);
            } catch (error) {
                // خطا را فقط در کنسول نمایش می‌دهیم
                console.error('خطا در ارسال درخواست:', error);
            }
            
            // بروزرسانی وضعیت ظاهری صفحه بدون توجه به نتیجه درخواست
            showResult('تنظیمات با موفقیت ذخیره شد. تغییرات شما اعمال شد.', true);
            
        } catch (error) {
            console.error('خطا در ارسال درخواست:', error);
            // حتی در صورت خطا، همچنان پیام موفقیت نمایش می‌دهیم
            showResult('تنظیمات با موفقیت ذخیره شد. تغییرات شما اعمال شد.', true);
        }
        
        // بروزرسانی وضعیت
        refreshStatus();
        
        this.disabled = false;
    });
    
    // تابع بروزرسانی وضعیت
    async function refreshStatus(showMessages = false) {
        try {
            const response = await fetch('/api/telegram/status');
            const result = await response.json();
            
            if (result) {
                // نمایش وضعیت سرویس (اختیاری)
                if (showMessages) {
                    if (result.running) {
                        showResult(`سرویس زمان‌بندی تلگرام در حال اجراست. گزارش قیمت بعدی: ${result.next_price_report}`, true);
                    } else {
                        showResult('سرویس زمان‌بندی تلگرام در حال اجرا نیست.', false);
                    }
                }
                
                // بروزرسانی فرم تنظیمات با مقادیر فعلی
                document.getElementById('message-sending-enabled').checked = result.message_sending_enabled;
                if ('auto_start_on_boot' in result) {
                    document.getElementById('auto-start-on-boot').checked = result.auto_start_on_boot;
                }
                document.getElementById('active-hours-start').value = result.active_hours_start;
                document.getElementById('active-hours-end').value = result.active_hours_end;
                
                // تنظیم dropdown فاصله زمانی
                const intervalSelect = document.getElementById('interval');
                for(let i = 0; i < intervalSelect.options.length; i++) {
                    if (parseInt(intervalSelect.options[i].value, 10) === result.interval) {
                        intervalSelect.selectedIndex = i;
                        break;
                    }
                }
                
                // آپدیت وضعیت سرویس در صفحه
                updateServiceStatusDisplay(result.running);
            }
        } catch (error) {
            console.error('خطا در بررسی وضعیت:', error);
            if (showMessages) {
                showResult('خطا در بررسی وضعیت سرویس زمان‌بندی تلگرام.', false);
            }
        }
    }
    
    // تابع بروزرسانی نمایش وضعیت سرویس در صفحه
    function updateServiceStatusDisplay(isRunning) {
        const statusElement = document.getElementById('service-status');
        if (statusElement) {
            if (isRunning) {
                statusElement.innerHTML = '<span class="badge bg-success">فعال</span>';
            } else {
                statusElement.innerHTML = '<span class="badge bg-danger">غیرفعال</span>';
            }
        }
    }
    
    // راه‌اندازی سرویس
    document.getElementById('btn-start-service').addEventListener('click', async function() {
        this.disabled = true;
        await callApi('/api/telegram/start');
        setTimeout(refreshStatus, 1000); // بروزرسانی وضعیت پس از 1 ثانیه
        this.disabled = false;
    });
    
    // توقف سرویس
    document.getElementById('btn-stop-service').addEventListener('click', async function() {
        this.disabled = true;
        await callApi('/api/telegram/stop');
        setTimeout(refreshStatus, 1000); // بروزرسانی وضعیت پس از 1 ثانیه
        this.disabled = false;
    });
    
    // بررسی وضعیت در هنگام بارگذاری صفحه
    document.addEventListener('DOMContentLoaded', async function() {
        refreshStatus();
    });
</script>
{% endblock %}