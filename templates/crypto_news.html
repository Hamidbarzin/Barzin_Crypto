{% extends "minimal_base.html" %}

{% block title %}Cryptocurrency News | Crypto Barzin{% endblock %}

{% block styles %}
<style>
    .news-container {
        margin-top: 20px;
    }
    .news-card {
        margin-bottom: 15px;
        overflow: hidden;
        transition: all 0.3s ease;
        border-radius: 8px;
        border: 1px solid #2b2f36;
        background-color: #181A20;
    }
    .news-card:hover {
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        transform: translateY(-3px);
    }
    .news-image {
        height: 180px;
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
    }
    .news-image-placeholder {
        height: 180px;
        background-color: #2b2f36;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #848E9C;
    }
    .news-date {
        font-size: 0.8rem;
        color: #848E9C;
    }
    .news-title {
        font-size: 1.1rem;
        font-weight: bold;
        margin-bottom: 5px;
        line-height: 1.4;
    }
    .news-source {
        font-size: 0.85rem;
        background-color: #FCD535;
        color: #181A20;
        padding: 2px 8px;
        border-radius: 4px;
        display: inline-block;
        margin-right: 5px;
    }
    .sentiment-card {
        background-color: #181A20;
        border: 1px solid #2b2f36;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 30px;
    }
    .sentiment-score {
        font-size: 2.5rem;
        font-weight: bold;
        text-align: center;
    }
    .sentiment-bullish {
        color: #0ECB81;
    }
    .sentiment-bearish {
        color: #F6465D;
    }
    .sentiment-neutral {
        color: #848E9C;
    }
    .sentiment-label {
        text-align: center;
        font-size: 1.2rem;
        margin-top: 5px;
    }
    .fear-greed-container {
        position: relative;
        height: 10px;
        background-color: #2b2f36;
        border-radius: 5px;
        margin: 15px 0;
        overflow: hidden;
    }
    .fear-greed-indicator {
        position: absolute;
        width: 20px;
        height: 20px;
        background-color: #FCD535;
        border-radius: 50%;
        top: -5px;
        transform: translateX(-50%);
        z-index: 2;
    }
    .fear-greed-scale {
        display: flex;
        justify-content: space-between;
        font-size: 0.85rem;
        color: #848E9C;
    }
    .loading-spinner {
        display: flex;
        justify-content: center;
        padding: 50px 0;
    }
    .sentiment-description {
        text-align: center;
        margin-top: 15px;
        font-style: italic;
        color: #848E9C;
    }
    .news-controls {
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        flex-wrap: wrap;
    }
    .news-actions {
        margin-right: auto;
    }
    .sentiment-title {
        color: #FCD535;
        margin-bottom: 20px;
        text-align: center;
    }
    .sentiment-updated {
        text-align: center;
        font-size: 0.8rem;
        color: #848E9C;
        margin-top: 10px;
    }
    .sentiment-icons {
        font-size: 1.5rem;
        text-align: center;
        margin: 5px 0;
    }
    .telegram-button {
        margin-top: 20px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <h1 class="mt-4 mb-4">اخبار ارزهای دیجیتال</h1>
    
    <div class="news-controls">
        <div class="news-filter">
            <select id="newsSource" class="form-select">
                <option value="all">همه منابع</option>
                <option value="CryptoCompare">CryptoCompare</option>
                <option value="CoinDesk">CoinDesk</option>
                <option value="CoinTelegraph">CoinTelegraph</option>
            </select>
        </div>
        <div class="news-actions">
            <button id="refreshNewsBtn" class="btn btn-primary">
                <i class="fas fa-sync-alt"></i> به‌روزرسانی اخبار
            </button>
            <button id="sendNewsToTelegramBtn" class="btn btn-warning">
                <i class="fab fa-telegram"></i> ارسال به تلگرام
            </button>
        </div>
    </div>
    
    <div class="row">
        <!-- ستون اخبار -->
        <div class="col-lg-8">
            <div id="newsLoading" class="loading-spinner">
                <div class="spinner-border text-warning" role="status">
                    <span class="visually-hidden">در حال بارگذاری...</span>
                </div>
            </div>
            <div id="newsContainer" class="news-container">
                <!-- اخبار اینجا قرار می‌گیرند -->
            </div>
        </div>
        
        <!-- ستون تحلیل احساسات و شاخص ترس و طمع -->
        <div class="col-lg-4">
            <div id="sentimentLoading" class="loading-spinner">
                <div class="spinner-border text-warning" role="status">
                    <span class="visually-hidden">در حال بارگذاری...</span>
                </div>
            </div>
            <div id="sentimentContainer" style="display: none;">
                <div class="sentiment-card">
                    <h3 class="sentiment-title">تحلیل احساسات بازار</h3>
                    
                    <div id="sentimentScoreContainer" class="sentiment-score sentiment-neutral">
                        50
                    </div>
                    
                    <div id="sentimentLabelContainer" class="sentiment-label">
                        خنثی (Neutral)
                    </div>
                    
                    <div id="sentimentIconsContainer" class="sentiment-icons">
                        😐
                    </div>
                    
                    <div class="row mt-4">
                        <div class="col-6">
                            <h5>بیت‌کوین</h5>
                            <div id="bitcoinSentiment">خنثی</div>
                        </div>
                        <div class="col-6">
                            <h5>اتریوم</h5>
                            <div id="ethereumSentiment">خنثی</div>
                        </div>
                    </div>
                    
                    <div id="sentimentUpdatedContainer" class="sentiment-updated">
                        آخرین به‌روزرسانی: {{now.strftime('%Y-%m-%d %H:%M')}}
                    </div>
                </div>
                
                <div class="sentiment-card">
                    <h3 class="sentiment-title">شاخص ترس و طمع</h3>
                    
                    <div id="fearGreedValueContainer" class="sentiment-score">
                        50
                    </div>
                    
                    <div id="fearGreedLabelContainer" class="sentiment-label">
                        خنثی (Neutral)
                    </div>
                    
                    <div class="fear-greed-container">
                        <div id="fearGreedIndicator" class="fear-greed-indicator" style="left: 50%;"></div>
                    </div>
                    
                    <div class="fear-greed-scale">
                        <span>ترس شدید</span>
                        <span>ترس</span>
                        <span>خنثی</span>
                        <span>طمع</span>
                        <span>طمع شدید</span>
                    </div>
                    
                    <div id="fearGreedUpdatedContainer" class="sentiment-updated">
                        آخرین به‌روزرسانی: {{now.strftime('%Y-%m-%d %H:%M')}}
                    </div>
                </div>
                
                <div class="d-grid gap-2 telegram-button">
                    <button id="sendMarketInsightsBtn" class="btn btn-lg btn-warning">
                        <i class="fab fa-telegram"></i> ارسال تحلیل بازار به تلگرام
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- قالب خبر -->
<template id="newsItemTemplate">
    <div class="news-card">
        <div class="row g-0">
            <div class="col-md-4">
                <div class="news-image-placeholder">
                    <i class="fas fa-newspaper fa-3x"></i>
                </div>
            </div>
            <div class="col-md-8">
                <div class="card-body">
                    <h5 class="news-title"></h5>
                    <div class="mb-2">
                        <span class="news-source"></span>
                        <span class="news-date"></span>
                    </div>
                    <p class="card-text"></p>
                    <a href="#" class="btn btn-sm btn-outline-warning mt-2" target="_blank">ادامه مطلب</a>
                </div>
            </div>
        </div>
    </div>
</template>
{% endblock %}

{% block scripts %}
<script>
    $(document).ready(function() {
        // به‌روزرسانی اخبار و تحلیل احساسات در لود صفحه
        fetchNews();
        fetchMarketInsights();
        
        // رویدادهای دکمه‌ها
        $('#refreshNewsBtn').click(function() {
            fetchNews();
        });
        
        $('#sendNewsToTelegramBtn').click(function() {
            sendNewsToTelegram();
        });
        
        $('#sendMarketInsightsBtn').click(function() {
            sendNewsToTelegram();
        });
        
        // فیلتر بر اساس منبع
        $('#newsSource').change(function() {
            filterNewsBySource($(this).val());
        });
    });
    
    // دریافت اخبار
    function fetchNews() {
        $('#newsLoading').show();
        $('#newsContainer').empty();
        
        $.ajax({
            url: '/api/crypto-news',
            method: 'GET',
            success: function(response) {
                $('#newsLoading').hide();
                
                if (response.success && response.news && response.news.length > 0) {
                    renderNews(response.news);
                } else {
                    $('#newsContainer').html('<div class="alert alert-warning">اخباری یافت نشد</div>');
                }
            },
            error: function(xhr, status, error) {
                $('#newsLoading').hide();
                $('#newsContainer').html(`<div class="alert alert-danger">خطا در دریافت اخبار: ${error}</div>`);
                console.error('Error fetching news:', error);
            }
        });
    }
    
    // دریافت بینش‌های بازار
    function fetchMarketInsights() {
        $('#sentimentLoading').show();
        $('#sentimentContainer').hide();
        
        $.ajax({
            url: '/api/market-insights',
            method: 'GET',
            success: function(response) {
                $('#sentimentLoading').hide();
                $('#sentimentContainer').show();
                
                if (response.success && response.data) {
                    renderSentimentData(response.data);
                } else {
                    showSentimentError('اطلاعات تحلیل احساسات در دسترس نیست');
                }
            },
            error: function(xhr, status, error) {
                $('#sentimentLoading').hide();
                showSentimentError(`خطا در دریافت تحلیل احساسات: ${error}`);
                console.error('Error fetching market insights:', error);
            }
        });
    }
    
    // نمایش خطا در بخش تحلیل احساسات
    function showSentimentError(message) {
        $('#sentimentContainer').html(`<div class="alert alert-danger">${message}</div>`);
        $('#sentimentContainer').show();
    }
    
    // نمایش اخبار
    function renderNews(newsItems) {
        const container = $('#newsContainer');
        const template = $('#newsItemTemplate');
        
        newsItems.forEach(item => {
            const newsElement = $(template.html());
            
            // تنظیم عنوان - استفاده از عنوان فارسی در صورت وجود
            const title = item.title_fa || item.title;
            newsElement.find('.news-title').text(title);
            
            // تنظیم منبع
            newsElement.find('.news-source').text(item.source);
            newsElement.attr('data-source', item.source);
            
            // تنظیم تاریخ
            const publishDate = item.published_date || '';
            newsElement.find('.news-date').text(publishDate);
            
            // تنظیم لینک
            const newsUrl = item.url || '#';
            newsElement.find('a').attr('href', newsUrl);
            
            // تنظیم تصویر (اگر موجود باشد)
            if (item.imageurl) {
                newsElement.find('.news-image-placeholder').removeClass('news-image-placeholder').addClass('news-image').css('background-image', `url(${item.imageurl})`);
            }
            
            container.append(newsElement);
        });
    }
    
    // نمایش داده‌های تحلیل احساسات
    function renderSentimentData(data) {
        // تحلیل احساسات
        const sentiment = data.sentiment || {};
        
        // تنظیم امتیاز احساسات
        const sentimentScore = sentiment.sentiment_score || 50;
        $('#sentimentScoreContainer').text(sentimentScore);
        
        // تنظیم وضعیت و رنگ
        let sentimentClass = 'sentiment-neutral';
        let sentimentText = 'خنثی (Neutral)';
        let sentimentEmoji = '😐';
        
        if (sentiment.overall_sentiment === 'bullish') {
            sentimentClass = 'sentiment-bullish';
            sentimentText = 'صعودی (Bullish)';
            sentimentEmoji = '🚀';
        } else if (sentiment.overall_sentiment === 'bearish') {
            sentimentClass = 'sentiment-bearish';
            sentimentText = 'نزولی (Bearish)';
            sentimentEmoji = '🐻';
        }
        
        $('#sentimentScoreContainer').removeClass('sentiment-bullish sentiment-bearish sentiment-neutral').addClass(sentimentClass);
        $('#sentimentLabelContainer').text(sentimentText);
        $('#sentimentIconsContainer').text(sentimentEmoji);
        
        // تنظیم وضعیت بیت‌کوین و اتریوم
        $('#bitcoinSentiment').text(translateSentiment(sentiment.bitcoin_sentiment));
        $('#ethereumSentiment').text(translateSentiment(sentiment.ethereum_sentiment));
        
        // تنظیم تاریخ به‌روزرسانی
        if (sentiment.updated_at) {
            $('#sentimentUpdatedContainer').text(`آخرین به‌روزرسانی: ${sentiment.updated_at}`);
        }
        
        // شاخص ترس و طمع
        const fearGreed = data.fear_greed_index || {};
        const fgValue = fearGreed.value || 50;
        
        // تنظیم مقدار و وضعیت
        $('#fearGreedValueContainer').text(fgValue);
        $('#fearGreedLabelContainer').text(fearGreed.value_classification || 'خنثی (Neutral)');
        
        // تنظیم نشانگر
        const position = fgValue + '%';
        $('#fearGreedIndicator').css('left', position);
        
        // تنظیم تاریخ به‌روزرسانی
        if (fearGreed.date) {
            $('#fearGreedUpdatedContainer').text(`آخرین به‌روزرسانی: ${fearGreed.date}`);
        }
    }
    
    // ترجمه وضعیت احساسات
    function translateSentiment(sentiment) {
        if (!sentiment) return 'نامشخص';
        
        switch(sentiment.toLowerCase()) {
            case 'bullish': return 'صعودی';
            case 'bearish': return 'نزولی';
            case 'neutral': return 'خنثی';
            default: return sentiment;
        }
    }
    
    // فیلتر اخبار بر اساس منبع
    function filterNewsBySource(source) {
        if (source === 'all') {
            $('.news-card').show();
        } else {
            $('.news-card').hide();
            $(`.news-card[data-source="${source}"]`).show();
        }
    }
    
    // ارسال اخبار به تلگرام
    function sendNewsToTelegram() {
        // غیرفعال کردن دکمه
        const button = $('#sendNewsToTelegramBtn');
        button.prop('disabled', true).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> در حال ارسال...');
        
        $.ajax({
            url: '/api/telegram/send-news',
            method: 'POST',
            success: function(response) {
                if (response.success) {
                    showToast('موفقیت', 'اخبار و تحلیل بازار با موفقیت به تلگرام ارسال شد', 'success');
                } else {
                    showToast('خطا', response.message || 'خطا در ارسال اخبار به تلگرام', 'error');
                }
            },
            error: function(xhr, status, error) {
                showToast('خطا', `خطا در ارسال اخبار به تلگرام: ${error}`, 'error');
                console.error('Error sending news to Telegram:', error);
            },
            complete: function() {
                // فعال کردن مجدد دکمه
                button.prop('disabled', false).html('<i class="fab fa-telegram"></i> ارسال به تلگرام');
            }
        });
    }
    
    // نمایش اعلان
    function showToast(title, message, type = 'info') {
        // اگر از کتابخانه‌های اعلان استفاده می‌کنید، از آن‌ها استفاده کنید
        // در غیر این صورت از یک اعلان ساده استفاده می‌کنیم
        alert(`${title}: ${message}`);
    }
</script>
{% endblock %}