{% extends "minimal_base.html" %}

{% block title %}Cryptocurrency News | Crypto Barzin{% endblock %}

{% block styles %}
<style>
    .news-container {
        margin-top: 20px;
    }
    .news-card {
        margin-bottom: 15px;
        overflow: hidden;
        transition: all 0.3s ease;
        border-radius: 8px;
        border: 1px solid #2b2f36;
        background-color: #181A20;
    }
    .news-card:hover {
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        transform: translateY(-3px);
    }
    .news-image {
        height: 180px;
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
    }
    .news-image-placeholder {
        height: 180px;
        background-color: #2b2f36;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #848E9C;
    }
    .news-date {
        font-size: 0.8rem;
        color: #848E9C;
    }
    .news-title {
        font-size: 1.1rem;
        font-weight: bold;
        margin-bottom: 5px;
        line-height: 1.4;
    }
    .news-source {
        font-size: 0.85rem;
        background-color: #FCD535;
        color: #181A20;
        padding: 2px 8px;
        border-radius: 4px;
        display: inline-block;
        margin-right: 5px;
    }
    .sentiment-card {
        background-color: #181A20;
        border: 1px solid #2b2f36;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 30px;
    }
    .sentiment-score {
        font-size: 2.5rem;
        font-weight: bold;
        text-align: center;
    }
    .sentiment-bullish {
        color: #0ECB81;
    }
    .sentiment-bearish {
        color: #F6465D;
    }
    .sentiment-neutral {
        color: #848E9C;
    }
    .sentiment-label {
        text-align: center;
        font-size: 1.2rem;
        margin-top: 5px;
    }
    .fear-greed-container {
        position: relative;
        height: 10px;
        background-color: #2b2f36;
        border-radius: 5px;
        margin: 15px 0;
        overflow: hidden;
    }
    .fear-greed-indicator {
        position: absolute;
        width: 20px;
        height: 20px;
        background-color: #FCD535;
        border-radius: 50%;
        top: -5px;
        transform: translateX(-50%);
        z-index: 2;
    }
    .fear-greed-scale {
        display: flex;
        justify-content: space-between;
        font-size: 0.85rem;
        color: #848E9C;
    }
    .loading-spinner {
        display: flex;
        justify-content: center;
        padding: 50px 0;
    }
    .sentiment-description {
        text-align: center;
        margin-top: 15px;
        font-style: italic;
        color: #848E9C;
    }
    .news-controls {
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        flex-wrap: wrap;
    }
    .news-actions {
        margin-right: auto;
    }
    .sentiment-title {
        color: #FCD535;
        margin-bottom: 20px;
        text-align: center;
    }
    .sentiment-updated {
        text-align: center;
        font-size: 0.8rem;
        color: #848E9C;
        margin-top: 10px;
    }
    .sentiment-icons {
        font-size: 1.5rem;
        text-align: center;
        margin: 5px 0;
    }
    .telegram-button {
        margin-top: 20px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <h1 class="mt-4 mb-4">Cryptocurrency News</h1>
    
    <div class="news-controls">
        <div class="news-filter">
            <select id="newsSource" class="form-select">
                <option value="all">All Sources</option>
                <option value="CryptoCompare">CryptoCompare</option>
                <option value="CoinDesk">CoinDesk</option>
                <option value="CoinTelegraph">CoinTelegraph</option>
                <option value="CMC Markets Canada">CMC Markets Canada</option>
                <option value="NDAX">NDAX</option>
                <option value="Bitbuy">Bitbuy</option>
                <option value="Newton">Newton</option>
                <option value="canadian">All Canadian Sources</option>
            </select>
        </div>
        <div class="news-actions">
            <button id="refreshNewsBtn" class="btn btn-primary">
                <i class="fas fa-sync-alt"></i> Refresh News
            </button>
            <button id="sendNewsToTelegramBtn" class="btn btn-warning">
                <i class="fab fa-telegram"></i> Send to Telegram
            </button>
        </div>
    </div>
    
    <div class="row">
        <!-- News Column -->
        <div class="col-lg-8">
            <div id="newsContainer" class="news-container">
                {% if news_items and news_items|length > 0 %}
                    {% for item in news_items %}
                        <div class="news-card">
                            <div class="row g-0">
                                <div class="col-md-4">
                                    {% if item.imageurl and item.imageurl|length > 0 %}
                                        <div class="news-image" style="background-image: url('{{ item.imageurl }}')"></div>
                                    {% elif item.image_url and item.image_url|length > 0 %}
                                        <div class="news-image" style="background-image: url('{{ item.image_url }}')"></div>
                                    {% else %}
                                        <div class="news-image-placeholder">
                                            <i class="fas fa-newspaper fa-3x"></i>
                                        </div>
                                    {% endif %}
                                </div>
                                <div class="col-md-8">
                                    <div class="card-body">
                                        <h5 class="news-title">{{ item.title or 'Crypto News' }}</h5>
                                        <p class="news-date">{{ item.published_date or '' }}</p>
                                        <span class="news-source">{{ item.source or 'Crypto News' }}</span>
                                        {% if item.url and item.url|length > 0 %}
                                            <a href="{{ item.url }}" target="_blank" class="btn btn-sm btn-outline-warning mt-2">Read More</a>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <div class="alert alert-warning">No news found. Please check back later.</div>
                {% endif %}
            </div>
        </div>
        
        <!-- Market Sentiment and Fear & Greed Index Column -->
        <div class="col-lg-4">
            <div id="sentimentLoading" class="loading-spinner">
                <div class="spinner-border text-warning" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
            <div id="sentimentContainer" style="display: none;">
                <div class="sentiment-card">
                    <h3 class="sentiment-title">Market Sentiment Analysis</h3>
                    
                    <div id="sentimentScoreContainer" class="sentiment-score sentiment-neutral">
                        50
                    </div>
                    
                    <div id="sentimentLabelContainer" class="sentiment-label">
                        Neutral
                    </div>
                    
                    <div id="sentimentIconsContainer" class="sentiment-icons">
                        üòê
                    </div>
                    
                    <div class="row mt-4">
                        <div class="col-6">
                            <h5>Bitcoin</h5>
                            <div id="bitcoinSentiment">Neutral</div>
                        </div>
                        <div class="col-6">
                            <h5>Ethereum</h5>
                            <div id="ethereumSentiment">Neutral</div>
                        </div>
                    </div>
                    
                    <div id="sentimentUpdatedContainer" class="sentiment-updated">
                        Last Updated: {{now.strftime('%Y-%m-%d %H:%M')}}
                    </div>
                </div>
                
                <div class="sentiment-card">
                    <h3 class="sentiment-title">Fear & Greed Index</h3>
                    
                    <div id="fearGreedValueContainer" class="sentiment-score">
                        50
                    </div>
                    
                    <div id="fearGreedLabelContainer" class="sentiment-label">
                        Neutral
                    </div>
                    
                    <div class="fear-greed-container">
                        <div id="fearGreedIndicator" class="fear-greed-indicator" style="left: 50%;"></div>
                    </div>
                    
                    <div class="fear-greed-scale">
                        <span>Extreme Fear</span>
                        <span>Fear</span>
                        <span>Neutral</span>
                        <span>Greed</span>
                        <span>Extreme Greed</span>
                    </div>
                    
                    <div id="fearGreedUpdatedContainer" class="sentiment-updated">
                        Last Updated: {{now.strftime('%Y-%m-%d %H:%M')}}
                    </div>
                </div>
                
                <div class="d-grid gap-2 telegram-button">
                    <button id="sendMarketInsightsBtn" class="btn btn-lg btn-warning">
                        <i class="fab fa-telegram"></i> Send Market Analysis to Telegram
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- News Template -->
<template id="newsItemTemplate">
    <div class="news-card">
        <div class="row g-0">
            <div class="col-md-4">
                <div class="news-image-placeholder">
                    <i class="fas fa-newspaper fa-3x"></i>
                </div>
            </div>
            <div class="col-md-8">
                <div class="card-body">
                    <h5 class="news-title"></h5>
                    <div class="mb-2">
                        <span class="news-source"></span>
                        <span class="news-date"></span>
                    </div>
                    <p class="card-text"></p>
                    <a href="#" class="btn btn-sm btn-outline-warning mt-2" target="_blank">Read More</a>
                </div>
            </div>
        </div>
    </div>
</template>
{% endblock %}

{% block scripts %}
<script>
    $(document).ready(function() {
        // News is now directly rendered from the server
        // Only fetch market sentiment
        fetchMarketInsights();
        
        // Button event handlers
        $('#refreshNewsBtn').click(function() {
            window.location.reload(); // Reload the page instead of using AJAX
        });
        
        $('#sendNewsToTelegramBtn').click(function() {
            sendNewsToTelegram();
        });
        
        $('#sendMarketInsightsBtn').click(function() {
            sendNewsToTelegram();
        });
        
        // Filter by source
        $('#newsSource').change(function() {
            filterNewsBySource($(this).val());
        });
    });
    
    // Fetch news from API
    function fetchNews() {
        $('#newsLoading').show();
        $('#newsContainer').empty();
        
        console.log("Fetching news from API...");
        
        // First get regular crypto news
        $.ajax({
            url: '/api/crypto-news',
            method: 'GET',
            success: function(response) {
                console.log("Received response from crypto-news API:", response);
                let allNews = [];
                
                if (response.success && response.news && response.news.length > 0) {
                    console.log(`Found ${response.news.length} news items`);
                    // Debug the first news item
                    if (response.news.length > 0) {
                        console.log("Sample news item:", response.news[0]);
                    }
                    allNews = allNews.concat(response.news);
                } else {
                    console.warn("No news found in main API response");
                }
                
                // Then get Canadian crypto news
                $.ajax({
                    url: '/api/canadian-crypto-news',
                    method: 'GET',
                    success: function(canadaResponse) {
                        $('#newsLoading').hide();
                        console.log("Received response from canadian-crypto-news API:", canadaResponse);
                        
                        if (canadaResponse.success && canadaResponse.news && canadaResponse.news.length > 0) {
                            console.log(`Found ${canadaResponse.news.length} Canadian news items`);
                            allNews = allNews.concat(canadaResponse.news);
                        } else {
                            console.warn("No Canadian news found");
                        }
                        
                        if (allNews.length > 0) {
                            console.log(`Rendering ${allNews.length} total news items`);
                            // Sort news by date if available
                            allNews.sort((a, b) => {
                                const dateA = a.published_on || 0;
                                const dateB = b.published_on || 0;
                                return dateB - dateA; // Sort in descending order (newest first)
                            });
                            
                            renderNews(allNews);
                        } else {
                            console.warn("No news items to display");
                            $('#newsContainer').html('<div class="alert alert-warning">No news found</div>');
                        }
                    },
                    error: function(xhr, status, error) {
                        // If Canadian news fails, still display regular news
                        $('#newsLoading').hide();
                        console.error("Error fetching Canadian news:", error, xhr.responseText);
                        
                        if (allNews.length > 0) {
                            console.log(`Rendering ${allNews.length} regular news items (Canadian news failed)`);
                            renderNews(allNews);
                        } else {
                            console.warn("No news items to display after Canadian API error");
                            $('#newsContainer').html('<div class="alert alert-warning">No news found</div>');
                        }
                    }
                });
            },
            error: function(xhr, status, error) {
                console.error("Error fetching main news:", error, xhr.responseText);
                
                // Try to get at least Canadian news if regular news fails
                $.ajax({
                    url: '/api/canadian-crypto-news',
                    method: 'GET',
                    success: function(canadaResponse) {
                        $('#newsLoading').hide();
                        console.log("Received fallback response from canadian-crypto-news API:", canadaResponse);
                        
                        if (canadaResponse.success && canadaResponse.news && canadaResponse.news.length > 0) {
                            console.log(`Rendering ${canadaResponse.news.length} Canadian news items as fallback`);
                            renderNews(canadaResponse.news);
                        } else {
                            console.warn("No Canadian news found as fallback");
                            $('#newsContainer').html('<div class="alert alert-warning">No news found</div>');
                        }
                    },
                    error: function(canadaXhr, canadaStatus, canadaError) {
                        $('#newsLoading').hide();
                        console.error("All news sources failed:", error, canadaError);
                        $('#newsContainer').html(`<div class="alert alert-danger">Error retrieving news: Unable to fetch from any source</div>`);
                    }
                });
            }
        });
    }
    
    // Fetch market insights data
    function fetchMarketInsights() {
        $('#sentimentLoading').show();
        $('#sentimentContainer').hide();
        
        $.ajax({
            url: '/api/market-insights',
            method: 'GET',
            success: function(response) {
                $('#sentimentLoading').hide();
                $('#sentimentContainer').show();
                
                if (response.success && response.data) {
                    renderSentimentData(response.data);
                } else {
                    showSentimentError('Market sentiment data is not available');
                }
            },
            error: function(xhr, status, error) {
                $('#sentimentLoading').hide();
                showSentimentError(`Error retrieving market sentiment: ${error}`);
                console.error('Error fetching market insights:', error);
            }
        });
    }
    
    // Display error in sentiment section
    function showSentimentError(message) {
        $('#sentimentContainer').html(`<div class="alert alert-danger">${message}</div>`);
        $('#sentimentContainer').show();
    }
    
    // Render news items
    function renderNews(newsItems) {
        const container = $('#newsContainer');
        const template = $('#newsItemTemplate');
        
        newsItems.forEach(item => {
            const newsElement = $(template.html());
            
            // Extract title - use clean URL if title is generic/empty
            let title = item.title;
            if (!title || title === 'News' || title === 'Market Analysis' || title === 'How to') {
                // Try to extract a more meaningful title from the URL
                const url = item.url || '';
                if (url.includes('/')) {
                    const segments = url.split('/');
                    const lastSegment = segments[segments.length - 1];
                    if (lastSegment && lastSegment !== '') {
                        // Convert slug to title format (replace hyphens with spaces, capitalize words)
                        title = lastSegment.replace(/-/g, ' ')
                            .replace(/\b\w/g, l => l.toUpperCase());
                    }
                }
            }
            
            newsElement.find('.news-title').text(title);
            
            // Set source
            newsElement.find('.news-source').text(item.source || 'Crypto News');
            newsElement.attr('data-source', item.source || 'Unknown');
            
            // Set date
            const publishDate = item.published_date || '';
            newsElement.find('.news-date').text(publishDate);
            
            // Set link
            const newsUrl = item.url || '#';
            newsElement.find('a').attr('href', newsUrl);
            
            // Set image (if available)
            if (item.imageurl && item.imageurl.trim() !== '') {
                newsElement.find('.news-image-placeholder').removeClass('news-image-placeholder').addClass('news-image').css('background-image', `url(${item.imageurl})`);
            } else if (item.image_url && item.image_url.trim() !== '') {
                newsElement.find('.news-image-placeholder').removeClass('news-image-placeholder').addClass('news-image').css('background-image', `url(${item.image_url})`);
            } else {
                // Keep the placeholder image as is
                console.log("Using placeholder image for article:", title);
            }
            
            container.append(newsElement);
        });
    }
    
    // Render sentiment data
    function renderSentimentData(data) {
        // Market sentiment
        const sentiment = data.sentiment || {};
        
        // Set sentiment score
        const sentimentScore = sentiment.sentiment_score || 50;
        $('#sentimentScoreContainer').text(sentimentScore);
        
        // Set status and color
        let sentimentClass = 'sentiment-neutral';
        let sentimentText = 'Neutral';
        let sentimentEmoji = 'üòê';
        
        if (sentiment.overall_sentiment === 'bullish') {
            sentimentClass = 'sentiment-bullish';
            sentimentText = 'Bullish';
            sentimentEmoji = 'üöÄ';
        } else if (sentiment.overall_sentiment === 'bearish') {
            sentimentClass = 'sentiment-bearish';
            sentimentText = 'Bearish';
            sentimentEmoji = 'üêª';
        }
        
        $('#sentimentScoreContainer').removeClass('sentiment-bullish sentiment-bearish sentiment-neutral').addClass(sentimentClass);
        $('#sentimentLabelContainer').text(sentimentText);
        $('#sentimentIconsContainer').text(sentimentEmoji);
        
        // Set Bitcoin and Ethereum status
        $('#bitcoinSentiment').text(translateSentiment(sentiment.bitcoin_sentiment));
        $('#ethereumSentiment').text(translateSentiment(sentiment.ethereum_sentiment));
        
        // Set update date
        if (sentiment.updated_at) {
            $('#sentimentUpdatedContainer').text(`Last Updated: ${sentiment.updated_at}`);
        }
        
        // Fear and Greed Index
        const fearGreed = data.fear_greed_index || {};
        const fgValue = fearGreed.value || 50;
        
        // Set value and status
        $('#fearGreedValueContainer').text(fgValue);
        $('#fearGreedLabelContainer').text(fearGreed.value_classification || 'Neutral');
        
        // Set indicator
        const position = fgValue + '%';
        $('#fearGreedIndicator').css('left', position);
        
        // Set update date
        if (fearGreed.date) {
            $('#fearGreedUpdatedContainer').text(`Last Updated: ${fearGreed.date}`);
        }
    }
    
    // Translate sentiment status
    function translateSentiment(sentiment) {
        if (!sentiment) return 'Unknown';
        
        switch(sentiment.toLowerCase()) {
            case 'bullish': return 'Bullish';
            case 'bearish': return 'Bearish';
            case 'neutral': return 'Neutral';
            default: return sentiment;
        }
    }
    
    // Filter news by source
    function filterNewsBySource(source) {
        if (source === 'all') {
            // Show all news
            $('.news-card').show();
        } else if (source === 'canadian') {
            // Show only Canadian sources
            $('.news-card').hide();
            $('.news-card[data-source="CMC Markets Canada"], .news-card[data-source="NDAX"], .news-card[data-source="Bitbuy"], .news-card[data-source="Newton"]').show();
        } else {
            // Show a specific source
            $('.news-card').hide();
            $(`.news-card[data-source="${source}"]`).show();
        }
    }
    
    // Send news to Telegram
    function sendNewsToTelegram() {
        // Disable button
        const button = $('#sendNewsToTelegramBtn');
        button.prop('disabled', true).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Sending...');
        
        $.ajax({
            url: '/api/telegram/send-news',
            method: 'POST',
            success: function(response) {
                if (response.success) {
                    showToast('Success', 'News and market insights successfully sent to Telegram', 'success');
                } else {
                    showToast('Error', response.message || 'Error sending news to Telegram', 'error');
                }
            },
            error: function(xhr, status, error) {
                showToast('Error', `Error sending news to Telegram: ${error}`, 'error');
                console.error('Error sending news to Telegram:', error);
            },
            complete: function() {
                // Re-enable button
                button.prop('disabled', false).html('<i class="fab fa-telegram"></i> Send to Telegram');
            }
        });
    }
    
    // Show notification
    function showToast(title, message, type = 'info') {
        // If you use a notification library, use it here
        // Otherwise use a simple alert
        alert(`${title}: ${message}`);
    }
</script>
{% endblock %}