{% extends "minimal_base.html" %}

{% block title %}Markets | Barzin Crypto English{% endblock %}

{% block content %}
<!-- Header with creator information -->

<div class="row mb-3">
    <div class="col-md-6">
        <div class="d-flex justify-content-between align-items-center">
            <h1 class="mb-0">Markets</h1>
        </div>
        <p class="text-muted mt-2">Complete list of monitored and analyzed cryptocurrency markets</p>
    </div>
    <div class="col-md-6">
        <div class="input-group mt-3">
            <input type="text" id="crypto-search" class="form-control" placeholder="Search by name or symbol...">
            <button class="btn btn-warning" type="button" id="search-button">
                <i class="fas fa-search"></i> Search
            </button>
        </div>
    </div>
</div>
<div id="dashboard-content">

    <!-- Cryptocurrency Categories -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card crypto-card">
                <div class="card-header bg-dark">
                    <h5 class="mb-3 text-white">Cryptocurrency Categories</h5>
                    <div>
                        <button id="btn-all" class="btn btn-primary me-1 mb-1">All Coins</button>
                        <button id="btn-major" class="btn btn-outline-light me-1 mb-1">Major Coins</button>
                        <button id="btn-stable" class="btn btn-outline-light me-1 mb-1">Stablecoins</button>
                        <button id="btn-promising" class="btn btn-outline-light me-1 mb-1">AI Coins</button>
                        <button id="btn-meme" class="btn btn-outline-light me-1 mb-1">Meme Coins</button>
                        <button id="btn-low-cost" class="btn btn-outline-light me-1 mb-1">Low Cost</button>
                    </div>
                    
                    <script>
                    document.addEventListener('DOMContentLoaded', function() {
                        // Filter function
                        function filterByCategory(category) {
                            console.log(`Filtering by category: ${category}`);
                            
                            // Reset all buttons to outline style
                            document.querySelectorAll('.card-header .btn').forEach(btn => {
                                btn.classList.remove('btn-primary');
                                btn.classList.add('btn-outline-light');
                            });
                            
                            // Highlight the clicked button
                            const clickedBtn = document.getElementById('btn-' + category);
                            if (clickedBtn) {
                                clickedBtn.classList.remove('btn-outline-light');
                                clickedBtn.classList.add('btn-primary');
                            }
                            
                            // Filter the coins
                            if (category === 'all') {
                                // Show all rows
                                document.querySelectorAll('.crypto-row').forEach(row => {
                                    row.style.display = '';
                                });
                            } else {
                                // Hide all rows first
                                document.querySelectorAll('.crypto-row').forEach(row => {
                                    row.style.display = 'none';
                                });
                                
                                // Show only matching rows
                                document.querySelectorAll(`.crypto-row.${category}`).forEach(row => {
                                    row.style.display = '';
                                });
                            }
                        }
                        
                        // Add event listeners to buttons
                        document.getElementById('btn-all').addEventListener('click', function() { filterByCategory('all'); });
                        document.getElementById('btn-major').addEventListener('click', function() { filterByCategory('major'); });
                        document.getElementById('btn-stable').addEventListener('click', function() { filterByCategory('stable'); });
                        document.getElementById('btn-promising').addEventListener('click', function() { filterByCategory('promising'); });
                        document.getElementById('btn-meme').addEventListener('click', function() { filterByCategory('meme'); });
                        document.getElementById('btn-low-cost').addEventListener('click', function() { filterByCategory('low-cost'); });
                    });
                    </script>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead>
                                <tr>
                                    <th scope="col">#</th>
                                    <th scope="col">Coin</th>
                                    <th scope="col">Symbol</th>
                                    <th scope="col">Price (USDT)</th>
                                    <th scope="col">Change (24h)</th>
                                    <th scope="col">Volume (24h)</th>
                                    <th scope="col">Signal</th>
                                    <th scope="col">Analysis</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- List of cryptocurrencies using dynamic data -->
                                {% for coin in cryptocurrencies %}
                                {% if coin.id <= 8 %}
                                <tr class="crypto-row major">
                                {% elif coin.id <= 11 %}
                                <tr class="crypto-row promising">
                                {% elif coin.id <= 19 %}
                                <tr class="crypto-row meme">
                                {% elif coin.id >= 40 and coin.id <= 45 %}
                                <tr class="crypto-row stable">
                                {% elif coin.id >= 22 and coin.id <= 25 %}
                                <tr class="crypto-row low-cost">
                                {% else %}
                                <tr class="crypto-row new">
                                {% endif %}
                                    <td>{{ coin.id }}</td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="icon-circle me-2">
                                                <i class="{{ coin.icon }}"></i>
                                            </div>
                                            <div>{{ coin.name }}</div>
                                        </div>
                                    </td>
                                    <td>{{ coin.symbol }}</td>
                                    <td id="{{ coin.symbol.replace('/', '-') }}-price">{{ coin.price }}</td>
                                    <td id="{{ coin.symbol.replace('/', '-') }}-change" class="{% if coin.change.startswith('+') %}text-success{% else %}text-danger{% endif %}">{{ coin.change }}</td>
                                    <td>{{ coin.volume }}</td>
                                    <td><span class="badge bg-{{ coin.signal_class }}">{{ coin.signal }}</span></td>
                                    <td><a href="/technical_analysis/{{ coin.symbol | replace('/', '-') }}" class="btn btn-sm btn-outline-primary">Technical Analysis</a></td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Technical Analysis for Selected Crypto -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card crypto-card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Technical Analysis <span id="selected-crypto-name">Bitcoin</span></h5>
                    <div class="border rounded p-1 bg-dark">
                        <button onclick="document.getElementById('technical-analysis-content').style.display='block'; document.getElementById('news-analysis-content').style.display='none';" class="btn btn-sm btn-outline-primary mx-1">Technical Analysis</button>
                        <button onclick="document.getElementById('technical-analysis-content').style.display='none'; document.getElementById('news-analysis-content').style.display='block';" class="btn btn-sm btn-primary mx-1">News & Analysis</button>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Technical Analysis Section -->
                    <div id="technical-analysis-content">
                        <!-- Loading status -->
                        <div id="technical-loading" style="display: none;">
                            <div class="text-center my-5">
                                <div class="spinner-border text-warning" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2 text-muted">Loading technical analysis for <span id="selected-crypto-symbol2">BTC/USDT</span>...</p>
                            </div>
                        </div>
                        
                        <!-- Technical Analysis Content -->
                        <div id="technical-content">
                            <div class="row">
                                <div class="col-md-8">
                                    <!-- Chart Placeholder -->
                                    <div class="chart-container" style="height: 300px; background: #1c1c28; border-radius: 8px;">
                                        <div class="d-flex justify-content-center align-items-center h-100">
                                            <p class="text-muted">Price chart for <span id="selected-crypto-symbol">BTC/USDT</span> will load soon</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="indicator-box mb-3">
                                        <div class="indicator-label">RSI (Relative Strength Index)</div>
                                        <div class="progress" style="height: 8px;">
                                            <div class="progress-bar bg-success" role="progressbar" style="width: 65%;" aria-valuenow="65" aria-valuemin="0" aria-valuemax="100"></div>
                                        </div>
                                        <div class="d-flex justify-content-between">
                                            <small class="text-muted">Oversold</small>
                                            <small class="text-muted">Neutral</small>
                                            <small class="text-muted">Overbought</small>
                                        </div>
                                        <div class="indicator-value">65</div>
                                    </div>
                                
                                <div class="indicator-box mb-3">
                                    <div class="indicator-label">MACD</div>
                                    <div class="d-flex justify-content-between">
                                        <div>Signal: <span class="text-info">12.2</span></div>
                                        <div>MACD Line: <span class="text-warning">15.8</span></div>
                                    </div>
                                    <div class="indicator-description">
                                        <span class="text-success">
                                            <i class="fas fa-arrow-up me-1"></i>
                                            Bullish trend (Buy signal)
                                        </span>
                                    </div>
                                </div>
                                
                                <div class="indicator-box">
                                    <div class="indicator-label">Moving Averages</div>
                                    <div class="d-flex justify-content-between mt-2">
                                        <div>MA20: <span class="text-info">63,200</span></div>
                                        <div>MA50: <span class="text-warning">61,500</span></div>
                                    </div>
                                    <div class="indicator-description">
                                        <span class="text-success">
                                            <i class="fas fa-check-circle me-1"></i>
                                            Price above moving averages (Bullish trend)
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- News and Analysis Section -->
                    <div id="news-analysis-content" style="display: block;">
                        <h6 class="border-bottom pb-2 mb-3">Latest news about <span id="selected-crypto-name2">Bitcoin</span></h6>
                        <div class="news-container">
                            <div class="news-item mb-3 p-3 border-start border-4 border-primary">
                                <h6 class="news-title mb-2">Bitcoin Reaches All-Time High Price</h6>
                                <p class="news-excerpt text-muted mb-1">Bitcoin has reached its all-time high price by surpassing $70,000. This event follows increased demand from ETF funds and institutional investors.</p>
                                <div class="d-flex justify-content-between align-items-center">
                                    <small class="news-source">Source: Cryptocurrency News Agency</small>
                                    <small class="news-date">April 8, 2025</small>
                                </div>
                                <div class="news-sentiment mt-2">
                                    <span class="badge bg-success">Market sentiment: Positive</span>
                                </div>
                            </div>
                            
                            <div class="news-item mb-3 p-3 border-start border-4 border-warning">
                                <h6 class="news-title mb-2">Analysts: Potential Short-Term Correction in Bitcoin Price</h6>
                                <p class="news-excerpt text-muted mb-1">Some analysts believe that after the recent growth, Bitcoin may experience a temporary price correction. Technical indicators show the market is in an overbought condition.</p>
                                <div class="d-flex justify-content-between align-items-center">
                                    <small class="news-source">Source: Market Analysts</small>
                                    <small class="news-date">April 7, 2025</small>
                                </div>
                                <div class="news-sentiment mt-2">
                                    <span class="badge bg-warning">Market sentiment: Neutral</span>
                                </div>
                            </div>
                            
                            <div class="news-item mb-3 p-3 border-start border-4 border-info">
                                <h6 class="news-title mb-2">Targeted Trading Strategy: Right Time to Enter the Market</h6>
                                <p class="news-excerpt text-muted mb-1">With Bitcoin's price stabilizing above $65,000, many traders consider this range suitable for market entry. A gradual buying strategy can reduce risk.</p>
                                <div class="d-flex justify-content-between align-items-center">
                                    <small class="news-source">Source: Crypto World</small>
                                    <small class="news-date">April 6, 2025</small>
                                </div>
                                <div class="news-sentiment mt-2">
                                    <span class="badge bg-info">Market sentiment: Cautiously positive</span>
                                </div>
                            </div>
                        </div>
                        
                        <a href="#" class="btn btn-outline-secondary btn-sm mt-2 w-100" id="load-more-news" onclick="loadMoreNews(); return false;">
                            <i class="fas fa-sync me-1"></i> Load More News
                        </a>
                        
<script>
// Function to load more news
function loadMoreNews() {
    const loadMoreButton = document.getElementById('load-more-news');
    const newsContainer = document.querySelector('.news-container');
    
    if (loadMoreButton && newsContainer) {
        // Show loading state
        loadMoreButton.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Loading...';
        
        // Simulate loading delay (in the actual version this would be replaced by an API request)
        setTimeout(() => {
            // Add new news item
            const newNewsItem = document.createElement('div');
            newNewsItem.className = 'news-item mb-3 p-3 border-start border-4 border-success';
            newNewsItem.innerHTML = `
                <h6 class="news-title mb-2">Report: Institutional Investment in Cryptocurrencies is Increasing</h6>
                <p class="news-excerpt text-muted mb-1">Reports indicate that institutional investment in the cryptocurrency market, especially Bitcoin and Ethereum, has increased dramatically. This trend could be a sign of broader adoption of digital currencies.</p>
                <div class="d-flex justify-content-between align-items-center">
                    <small class="news-source">Source: Crypto Financial Analysis</small>
                    <small class="news-date">April 5, 2025</small>
                </div>
                <div class="news-sentiment mt-2">
                    <span class="badge bg-success">Market sentiment: Very positive</span>
                </div>
            `;
            
            newsContainer.appendChild(newNewsItem);
            
            // Restore button to original state
            loadMoreButton.innerHTML = '<i class="fas fa-sync me-1"></i> Load More News';
        }, 1000);
    }
}
</script>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// The filter function is now in the card-header
    
    // Filter the coins
    if (category === 'all') {
        // Show all rows
        document.querySelectorAll('.crypto-row').forEach(row => {
            row.style.display = '';
        });
    } else {
        // Hide all rows first
        document.querySelectorAll('.crypto-row').forEach(row => {
            row.style.display = 'none';
        });
        
        // Show only matching rows
        document.querySelectorAll(`.crypto-row.${category}`).forEach(row => {
            row.style.display = '';
        });
    }
}

document.addEventListener('DOMContentLoaded', function() {
    
    // Price formatting function
    function formatPrice(price) {
        if (price === null || price === undefined || isNaN(price)) {
            return '--';
        }
        
        // If price is large (no decimal)
        if (price >= 1000) {
            return price.toLocaleString('en-US', {maximumFractionDigits: 0});
        }
        
        // If price is small (more decimal places needed)
        if (price < 0.01) {
            return price.toLocaleString('en-US', {minimumFractionDigits: 6, maximumFractionDigits: 6});
        }
        
        // Default: 2 decimal places
        return price.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
    }
    
    // Function to get technical analysis from API
    function loadTechnicalData(symbol) {
        // Show loading status
        const loadingEl = document.getElementById('technical-loading');
        const contentEl = document.getElementById('technical-content');
        
        if (loadingEl && contentEl) {
            loadingEl.style.display = 'block';
            contentEl.style.display = 'none';
        }
        
        // API request
        console.log("Loading technical data for:", symbol);
        fetch(`/api/technical/${symbol}/1d`)
            .then(response => response.json())
            .then(data => {
                console.log("Technical analysis data received:", data);
                if (data.success && data.data) {
                    const analysis = data.data;
                    
                    // Update RSI
                    if (analysis.rsi !== undefined) {
                        console.log("RSI value:", analysis.rsi);
                        // Use more specific selectors
                        const rsiEl = document.querySelector('#technical-content .indicator-box:nth-child(1) .indicator-value');
                        const rsiProgressEl = document.querySelector('#technical-content .indicator-box:nth-child(1) .progress-bar');
                        console.log("RSI elements found:", rsiEl, rsiProgressEl);
                        
                        if (rsiEl) {
                            rsiEl.textContent = analysis.rsi.toFixed(1);
                        }
                        
                        if (rsiProgressEl) {
                            rsiProgressEl.style.width = `${analysis.rsi}%`;
                            
                            // Change color based on value
                            rsiProgressEl.classList.remove('bg-success', 'bg-danger', 'bg-warning');
                            if (analysis.rsi < 30) {
                                rsiProgressEl.classList.add('bg-danger');
                            } else if (analysis.rsi > 70) {
                                rsiProgressEl.classList.add('bg-success');
                            } else {
                                rsiProgressEl.classList.add('bg-warning');
                            }
                        }
                    }
                    
                    // Update MACD
                    if (analysis.macd !== undefined && analysis.macd_signal !== undefined) {
                        console.log("MACD values:", analysis.macd, analysis.macd_signal);
                        const macdEl = document.querySelector('#technical-content .indicator-box:nth-child(2) .text-warning');
                        const signalEl = document.querySelector('#technical-content .indicator-box:nth-child(2) .text-info');
                        const macdDescEl = document.querySelector('#technical-content .indicator-box:nth-child(2) .indicator-description span');
                        console.log("MACD elements found:", macdEl, signalEl, macdDescEl);
                        
                        if (macdEl) {
                            macdEl.textContent = analysis.macd.toFixed(2);
                        }
                        
                        if (signalEl) {
                            signalEl.textContent = analysis.macd_signal.toFixed(2);
                        }
                        
                        if (macdDescEl) {
                            if (analysis.macd > analysis.macd_signal) {
                                macdDescEl.innerHTML = '<i class="fas fa-arrow-up me-1"></i> Bullish trend (Buy signal)';
                                macdDescEl.className = 'text-success';
                            } else {
                                macdDescEl.innerHTML = '<i class="fas fa-arrow-down me-1"></i> Bearish trend (Sell signal)';
                                macdDescEl.className = 'text-danger';
                            }
                        }
                    }
                    
                    // Update Moving Averages
                    if (analysis.ma20 !== undefined && analysis.ma50 !== undefined) {
                        console.log("MA values:", analysis.ma20, analysis.ma50);
                        const ma20El = document.querySelector('#technical-content .indicator-box:nth-child(3) .text-info');
                        const ma50El = document.querySelector('#technical-content .indicator-box:nth-child(3) .text-warning');
                        const maDescEl = document.querySelector('#technical-content .indicator-box:nth-child(3) .indicator-description span');
                        console.log("MA elements found:", ma20El, ma50El, maDescEl);
                        
                        if (ma20El) {
                            ma20El.textContent = formatPrice(analysis.ma20);
                        }
                        
                        if (ma50El) {
                            ma50El.textContent = formatPrice(analysis.ma50);
                        }
                        
                        if (maDescEl && analysis.current_price !== undefined) {
                            if (analysis.current_price > analysis.ma20 && analysis.ma20 > analysis.ma50) {
                                maDescEl.innerHTML = '<i class="fas fa-check-circle me-1"></i> Price above moving averages (Bullish trend)';
                                maDescEl.className = 'text-success';
                            } else if (analysis.current_price < analysis.ma20 && analysis.ma20 < analysis.ma50) {
                                maDescEl.innerHTML = '<i class="fas fa-times-circle me-1"></i> Price below moving averages (Bearish trend)';
                                maDescEl.className = 'text-danger';
                            } else {
                                maDescEl.innerHTML = '<i class="fas fa-minus-circle me-1"></i> Price between moving averages (Neutral trend)';
                                maDescEl.className = 'text-warning';
                            }
                        }
                    }
                    
                    // Show results and hide loading state
                    if (loadingEl && contentEl) {
                        loadingEl.style.display = 'none';
                        contentEl.style.display = 'block';
                    }
                } else {
                    console.error('Error loading technical data:', data.message || 'Unknown error');
                    
                    // Hide loading and show error message
                    if (loadingEl && contentEl) {
                        loadingEl.style.display = 'none';
                        contentEl.style.display = 'block';
                        contentEl.innerHTML = '<div class="alert alert-danger">Error loading technical analysis data</div>';
                    }
                }
            })
            .catch(error => {
                console.error('Error loading technical data:', error);
                
                // Hide loading and show error message
                if (loadingEl && contentEl) {
                    loadingEl.style.display = 'none';
                    contentEl.style.display = 'block';
                    contentEl.innerHTML = '<div class="alert alert-danger">Error connecting to server</div>';
                }
            });
    }
    
    // Initial setup called on page load
    function setupInitialView() {
        // Show all rows by default
        const allRows = document.querySelectorAll('.crypto-row');
        console.log('Total rows:', allRows.length);
        
        allRows.forEach(row => {
            row.style.display = 'table-row';
        });
    }
    
    // Call the setup function
    setupInitialView();
    
    // Analysis buttons in the cryptocurrencies table
    const tableAnalysisButtons = document.querySelectorAll('td .analysis-button');
    
    // Add click event for showing technical analysis
    tableAnalysisButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            
            // Get cryptocurrency info from the clicked row
            const row = this.closest('tr');
            const cryptoNameElement = row.querySelector('.d-flex > div:nth-child(2)');
            const cryptoSymbolElement = row.querySelector('td:nth-child(3)');
            
            if (cryptoNameElement && cryptoSymbolElement) {
                const cryptoName = cryptoNameElement.textContent;
                const cryptoSymbol = cryptoSymbolElement.textContent;
                
                // Go to dedicated technical analysis page
                console.log("Redirecting to technical analysis page for", cryptoSymbol);
                const cleanSymbol = cryptoSymbol.trim();
                console.log("Clean symbol:", cleanSymbol);
                window.location.href = `/technical_analysis/${cleanSymbol}`;
                
                // No need for the rest of the code as we're redirecting
                return;
                
                /* Old code - no longer used as we're redirecting to a dedicated page
                // Update analysis section
                const nameElement = document.getElementById('selected-crypto-name');
                const symbolElement = document.getElementById('selected-crypto-symbol');
                const nameElement2 = document.getElementById('selected-crypto-name2');
                
                if (nameElement && symbolElement) {
                    nameElement.textContent = cryptoName;
                    symbolElement.textContent = cryptoSymbol;
                    
                    if (nameElement2) {
                        nameElement2.textContent = cryptoName;
                    }
                    
                    // Request technical analysis data for selected cryptocurrency
                    loadTechnicalData(cryptoSymbol);
                }
                
                // Show technical analysis section (instead of news)
                document.getElementById('technical-analysis-content').style.display = 'block';
                document.getElementById('news-analysis-content').style.display = 'none';
                
                // Scroll to analysis section
                const analysisSection = document.querySelector('.card-header');
                if (analysisSection && analysisSection.textContent.includes('Technical Analysis')) {
                    analysisSection.scrollIntoView({
                        behavior: 'smooth'
                    });
                } else {
                    // If analysis section not found, scroll to end of page
                    window.scrollTo({
                        top: document.body.scrollHeight,
                        behavior: 'smooth'
                    });
                }
                */
            }
        });
    });
    
    // Setup tabs for technical analysis / news
    function setupTabs() {
        // Function to show technical analysis
        function showTechnical() {
            const technicalContent = document.getElementById('technical-analysis-content');
            const newsContent = document.getElementById('news-analysis-content');
            const techButton = document.getElementById('show-technical');
            const newsButton = document.getElementById('show-news');
            
            if (technicalContent && newsContent && techButton && newsButton) {
                technicalContent.style.display = 'block';
                newsContent.style.display = 'none';
                
                techButton.classList.add('btn-primary');
                techButton.classList.remove('btn-outline-primary');
                
                newsButton.classList.add('btn-outline-primary');
                newsButton.classList.remove('btn-primary');
                
                console.log('Showing technical analysis');
            }
        }
        
        // Function to show news
        function showNews() {
            const technicalContent = document.getElementById('technical-analysis-content');
            const newsContent = document.getElementById('news-analysis-content');
            const techButton = document.getElementById('show-technical');
            const newsButton = document.getElementById('show-news');
            
            if (technicalContent && newsContent && techButton && newsButton) {
                technicalContent.style.display = 'none';
                newsContent.style.display = 'block';
                
                techButton.classList.add('btn-outline-primary');
                techButton.classList.remove('btn-primary');
                
                newsButton.classList.add('btn-primary');
                newsButton.classList.remove('btn-outline-primary');
                
                // Update cryptocurrency name in news section
                const cryptoName = document.getElementById('selected-crypto-name').textContent;
                const cryptoName2 = document.getElementById('selected-crypto-name2');
                if (cryptoName2) {
                    cryptoName2.textContent = cryptoName;
                }
                
                console.log('Showing news and analysis');
            }
        }
        
        // Define functions at global scope
        window.showTechnical = showTechnical;
        window.showNews = showNews;
        
        // Add event listeners to buttons
        const techButton = document.getElementById('show-technical');
        const newsButton = document.getElementById('show-news');
        
        if (techButton) {
            techButton.addEventListener('click', showTechnical);
        }
        
        if (newsButton) {
            newsButton.addEventListener('click', showNews);
        }
    }
    
    // Update cryptocurrency prices (API-based) with optimized batch requests
    function updatePrices() {
        // Track when last update happened to avoid too frequent calls
        const now = Date.now();
        const lastUpdate = window.lastPriceUpdate || 0;
        
        // Don't update more frequently than every 10 seconds
        if (now - lastUpdate < 10000) {
            console.log("Skipping price update - too soon since last update");
            return;
        }
        
        window.lastPriceUpdate = now;
        
        // Get only visible elements to reduce API load
        const visibleElements = Array.from(document.querySelectorAll('[id$="-price"]')).filter(el => {
            // Check if the element or its parent row is visible
            let current = el;
            while (current) {
                const style = window.getComputedStyle(current);
                if (style.display === 'none') return false;
                current = current.parentElement;
                // Stop at the table
                if (current && current.tagName === 'TABLE') break;
            }
            return true;
        });
        
        // Don't update if no elements are visible
        if (visibleElements.length === 0) {
            console.log("No visible price elements found, skipping update");
            return;
        }
        
        console.log(`Updating ${visibleElements.length} visible price elements`);
        
        // Limit to 4 concurrent updates to avoid overwhelming the API
        const maxConcurrent = 4;
        const chunks = [];
        
        // Split visible elements into chunks
        for (let i = 0; i < visibleElements.length; i += maxConcurrent) {
            chunks.push(visibleElements.slice(i, i + maxConcurrent));
        }
        
        // Process chunks sequentially with delay between them
        let chunkIndex = 0;
        
        function processNextChunk() {
            if (chunkIndex >= chunks.length) return;
            
            const currentChunk = chunks[chunkIndex++];
            console.log(`Processing price update chunk ${chunkIndex} of ${chunks.length}`);
            
            // Process each element in the current chunk
            currentChunk.forEach(el => {
                const domId = el.id;
                const symbol = domId.replace('-price', '');
                if (symbol) {
                    fetch(`/api/price/${symbol}`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.success && data.data) {
                                // Update price
                                el.textContent = formatPrice(data.data.price);
                                
                                // Update percentage change (if element exists)
                                const changeEl = document.getElementById(`${symbol}-change`);
                                if (changeEl && data.data.change_24h !== undefined) {
                                    const newChange = data.data.change_24h;
                                    changeEl.textContent = (newChange >= 0 ? '+' : '') + newChange.toFixed(2) + '%';
                                    
                                    // Update colors
                                    if (newChange >= 0) {
                                        changeEl.className = 'text-success';
                                    } else {
                                        changeEl.className = 'text-danger';
                                    }
                                }
                            }
                        })
                        .catch(error => {
                            console.error(`Error fetching price for ${symbol}:`, error);
                        });
                }
            });
            
            // Process next chunk with delay
            if (chunkIndex < chunks.length) {
                setTimeout(processNextChunk, 2000); // 2 second delay between chunks
            }
        }
        
        // Start processing chunks
        processNextChunk();
    }
    
    // Update prices with less frequency to reduce API calls (30 seconds)
    setInterval(updatePrices, 30000);
    
    // Search functionality
    function setupSearch() {
        console.log("Setting up search functionality...");
        const searchInput = document.getElementById('crypto-search');
        const searchButton = document.getElementById('search-button');
        const cryptoRows = document.querySelectorAll('.crypto-row');
        
        console.log("Search input:", searchInput);
        console.log("Search button:", searchButton);
        console.log("Number of crypto rows:", cryptoRows.length);
        
        function performSearch() {
            console.log("Performing search...");
            const searchTerm = searchInput.value.toLowerCase().trim();
            console.log("Search term:", searchTerm);
            
            // If search term is empty, show all
            if (searchTerm === '') {
                console.log("Search term is empty, showing all rows");
                cryptoRows.forEach(row => {
                    row.style.display = '';
                });
                return;
            }
            
            let matchCount = 0;
            
            // Filter rows
            cryptoRows.forEach(row => {
                try {
                    // More robust selection with error handling
                    let coinName = "";
                    let coinSymbol = "";
                    
                    const nameCell = row.querySelector('td:nth-child(2)');
                    const symbolCell = row.querySelector('td:nth-child(3)');
                    
                    if (nameCell) coinName = nameCell.textContent.toLowerCase();
                    if (symbolCell) coinSymbol = symbolCell.textContent.toLowerCase();
                    
                    console.log(`Row data: Name=${coinName}, Symbol=${coinSymbol}`);
                    
                    if (coinName.includes(searchTerm) || coinSymbol.includes(searchTerm)) {
                        row.style.display = '';
                        matchCount++;
                    } else {
                        row.style.display = 'none';
                    }
                } catch (err) {
                    console.error("Error processing row:", err);
                    // If we encounter an error, show the row anyway
                    row.style.display = '';
                }
            });
            
            console.log(`Search complete. Found ${matchCount} matches.`);
        }
        
        // Add event listeners
        if (searchButton) {
            console.log("Adding click event listener to search button");
            searchButton.addEventListener('click', performSearch);
        }
        
        // Add keypress event for Enter key
        if (searchInput) {
            console.log("Adding keypress event listener to search input");
            searchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    console.log("Enter key pressed, performing search");
                    performSearch();
                }
            });
            
            // Also add input event for real-time filtering
            searchInput.addEventListener('input', function() {
                console.log("Input changed, performing search");
                performSearch();
            });
        }
    }
    
    // Execute main functions
    setupTabs();
    setupSearch();
    setTimeout(updatePrices, 1000);
});
</script>

{% endblock %}