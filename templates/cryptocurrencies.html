{% extends "minimal_base.html" %}

{% block title %}ارزهای دیجیتال | ربات هوشمند ارز دیجیتال{% endblock %}

{% block content %}
<div id="dashboard-content">
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="mb-3">ارزهای دیجیتال</h1>
            <p class="text-muted">لیست کامل ارزهای دیجیتال تحت نظارت و تحلیل ربات</p>
        </div>
    </div>

    <!-- Cryptocurrency Categories -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card crypto-card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">دسته‌بندی ارزها</h5>
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-sm btn-warning active" data-crypto-category="all">همه ارزها</button>
                        <button type="button" class="btn btn-sm btn-outline-warning" data-crypto-category="major">ارزهای مهم بازار</button>
                        <button type="button" class="btn btn-sm btn-outline-warning" data-crypto-category="promising">ارزهای هوش مصنوعی</button>
                        <button type="button" class="btn btn-sm btn-outline-warning" data-crypto-category="new">ارزهای لایر 1 و 2</button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead>
                                <tr>
                                    <th scope="col">#</th>
                                    <th scope="col">ارز</th>
                                    <th scope="col">نماد</th>
                                    <th scope="col">قیمت (USDT)</th>
                                    <th scope="col">تغییر (24h)</th>
                                    <th scope="col">حجم (24h)</th>
                                    <th scope="col">سیگنال</th>
                                    <th scope="col">تحلیل</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- لیست ارزهای دیجیتال با استفاده از داده‌های دینامیک -->
                                {% for coin in cryptocurrencies %}
                                {% if coin.id <= 7 %}
                                <tr class="crypto-row major">
                                {% elif coin.id <= 13 %}
                                <tr class="crypto-row promising">
                                {% else %}
                                <tr class="crypto-row new">
                                {% endif %}
                                    <td>{{ coin.id }}</td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="icon-circle me-2">
                                                <i class="{{ coin.icon }}"></i>
                                            </div>
                                            <div>{{ coin.name }}</div>
                                        </div>
                                    </td>
                                    <td>{{ coin.symbol }}</td>
                                    <td id="{{ coin.symbol.replace('/', '-') }}-price">{{ coin.price }}</td>
                                    <td id="{{ coin.symbol.replace('/', '-') }}-change" class="{% if coin.change.startswith('+') %}text-success{% else %}text-danger{% endif %}">{{ coin.change }}</td>
                                    <td>{{ coin.volume }}</td>
                                    <td><span class="badge bg-{{ coin.signal_class }}">{{ coin.signal }}</span></td>
                                    <td><a href="#" class="btn btn-sm btn-outline-primary">تحلیل کامل</a></td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Technical Analysis for Selected Crypto -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card crypto-card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">تحلیل تکنیکال <span id="selected-crypto-name">بیت‌کوین</span></h5>
                    <div class="btn-group">
                        <button class="btn btn-sm btn-outline-primary active" id="tab-technical">تحلیل فنی</button>
                        <button class="btn btn-sm btn-outline-primary" id="tab-news">اخبار و تحلیل‌ها</button>
                    </div>
                </div>
                <div class="card-body">
                    <!-- بخش تحلیل تکنیکال -->
                    <div id="technical-analysis-content">
                        <div class="row">
                            <div class="col-md-8">
                                <!-- Chart Placeholder -->
                                <div class="chart-container" style="height: 300px; background: #1c1c28; border-radius: 8px;">
                                    <div class="d-flex justify-content-center align-items-center h-100">
                                        <p class="text-muted">نمودار قیمت <span id="selected-crypto-symbol">BTC/USDT</span> به زودی بارگذاری خواهد شد</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="indicator-box mb-3">
                                    <div class="indicator-label">RSI (شاخص قدرت نسبی)</div>
                                    <div class="progress" style="height: 8px;">
                                        <div class="progress-bar bg-success" role="progressbar" style="width: 65%;" aria-valuenow="65" aria-valuemin="0" aria-valuemax="100"></div>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <small class="text-muted">اشباع فروش</small>
                                        <small class="text-muted">خنثی</small>
                                        <small class="text-muted">اشباع خرید</small>
                                    </div>
                                    <div class="indicator-value">65</div>
                                </div>
                                
                                <div class="indicator-box mb-3">
                                    <div class="indicator-label">MACD</div>
                                    <div class="d-flex justify-content-between">
                                        <div>سیگنال: <span class="text-info">12.2</span></div>
                                        <div>خط MACD: <span class="text-warning">15.8</span></div>
                                    </div>
                                    <div class="indicator-description">
                                        <span class="text-success">
                                            <i class="fas fa-arrow-up me-1"></i>
                                            روند صعودی (سیگنال خرید)
                                        </span>
                                    </div>
                                </div>
                                
                                <div class="indicator-box">
                                    <div class="indicator-label">میانگین‌های متحرک</div>
                                    <div class="d-flex justify-content-between mt-2">
                                        <div>MA20: <span class="text-info">63,200</span></div>
                                        <div>MA50: <span class="text-warning">61,500</span></div>
                                    </div>
                                    <div class="indicator-description">
                                        <span class="text-success">
                                            <i class="fas fa-check-circle me-1"></i>
                                            قیمت بالای میانگین‌های متحرک (روند صعودی)
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- بخش اخبار و تحلیل‌ها -->
                    <div id="news-analysis-content" style="display: none;">
                        <h6 class="border-bottom pb-2 mb-3">آخرین اخبار مرتبط با <span id="selected-crypto-name2">بیت‌کوین</span></h6>
                        <div class="news-container">
                            <div class="news-item mb-3 p-3 border-start border-4 border-primary">
                                <h6 class="news-title mb-2">بیت‌کوین به بالاترین قیمت تاریخ خود رسید</h6>
                                <p class="news-excerpt text-muted mb-1">ارز دیجیتال بیت‌کوین با عبور از مرز ۷۰ هزار دلار به بالاترین قیمت تاریخ خود دست یافت. این اتفاق در پی افزایش تقاضا از سوی صندوق‌های ETF رخ داده است.</p>
                                <div class="d-flex justify-content-between align-items-center">
                                    <small class="news-source">منبع: خبرگزاری ارز دیجیتال</small>
                                    <small class="news-date">۸ آوریل ۲۰۲۵</small>
                                </div>
                                <div class="news-sentiment mt-2">
                                    <span class="badge bg-success">احساس بازار: مثبت</span>
                                </div>
                            </div>
                            
                            <div class="news-item mb-3 p-3 border-start border-4 border-warning">
                                <h6 class="news-title mb-2">تحلیل‌گران: احتمال اصلاح کوتاه‌مدت در قیمت بیت‌کوین</h6>
                                <p class="news-excerpt text-muted mb-1">برخی تحلیل‌گران معتقدند پس از رشد اخیر، بیت‌کوین ممکن است یک اصلاح قیمت موقت را تجربه کند. شاخص‌های تکنیکال نشان می‌دهند بازار در وضعیت اشباع خرید قرار دارد.</p>
                                <div class="d-flex justify-content-between align-items-center">
                                    <small class="news-source">منبع: تحلیل‌گران بازار</small>
                                    <small class="news-date">۷ آوریل ۲۰۲۵</small>
                                </div>
                                <div class="news-sentiment mt-2">
                                    <span class="badge bg-warning">احساس بازار: خنثی</span>
                                </div>
                            </div>
                            
                            <div class="news-item mb-3 p-3 border-start border-4 border-info">
                                <h6 class="news-title mb-2">استراتژی معامله هدفمند: زمان مناسب برای ورود به بازار</h6>
                                <p class="news-excerpt text-muted mb-1">با توجه به تثبیت قیمت بیت‌کوین در بالای سطح ۶۵ هزار دلار، بسیاری از معامله‌گران این محدوده را برای ورود به بازار مناسب می‌دانند. استراتژی خرید تدریجی می‌تواند ریسک را کاهش دهد.</p>
                                <div class="d-flex justify-content-between align-items-center">
                                    <small class="news-source">منبع: دنیای رمزارز</small>
                                    <small class="news-date">۶ آوریل ۲۰۲۵</small>
                                </div>
                                <div class="news-sentiment mt-2">
                                    <span class="badge bg-info">احساس بازار: محتاطانه مثبت</span>
                                </div>
                            </div>
                        </div>
                        
                        <a href="#" class="btn btn-outline-secondary btn-sm mt-2 w-100" id="load-more-news">
                            <i class="fas fa-sync me-1"></i> بارگذاری اخبار بیشتر
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // روش ساده برای فیلتر کردن ارزها
    function setupFilterButtons() {
        // انتخاب دکمه‌ها و سطرهای جدول
        const allButton = document.querySelector('[data-crypto-category="all"]');
        const majorButton = document.querySelector('[data-crypto-category="major"]');
        const promisingButton = document.querySelector('[data-crypto-category="promising"]');
        const newButton = document.querySelector('[data-crypto-category="new"]');
        
        const allRows = document.querySelectorAll('.crypto-row');
        const majorRows = document.querySelectorAll('.crypto-row.major');
        const promisingRows = document.querySelectorAll('.crypto-row.promising');
        const newRows = document.querySelectorAll('.crypto-row.new');
        
        console.log('تعداد کل سطرها:', allRows.length);
        console.log('سطرهای ارزهای اصلی:', majorRows.length);
        console.log('سطرهای ارزهای با پتانسیل:', promisingRows.length);
        console.log('سطرهای ارزهای جدید:', newRows.length);
        
        // تابع نمایش دادن یا مخفی کردن سطرها
        function showRows(rowsToShow) {
            // همه سطرها را مخفی کن
            allRows.forEach(row => {
                row.style.display = 'none';
            });
            
            // فقط سطرهای انتخاب شده را نمایش بده
            rowsToShow.forEach(row => {
                row.style.display = '';
            });
        }
        
        // تابع به روزرسانی وضعیت دکمه‌ها
        function updateButtonStates(activeButton) {
            [allButton, majorButton, promisingButton, newButton].forEach(button => {
                button.classList.remove('active');
                button.classList.remove('btn-warning');
                button.classList.add('btn-outline-warning');
            });
            
            activeButton.classList.add('active');
            activeButton.classList.remove('btn-outline-warning');
            activeButton.classList.add('btn-warning');
        }
        
        // اضافه کردن رویداد کلیک برای هر دکمه
        if (allButton) {
            allButton.addEventListener('click', function() {
                updateButtonStates(this);
                showRows(allRows);
            });
        }
        
        if (majorButton) {
            majorButton.addEventListener('click', function() {
                updateButtonStates(this);
                showRows(majorRows);
            });
        }
        
        if (promisingButton) {
            promisingButton.addEventListener('click', function() {
                updateButtonStates(this);
                showRows(promisingRows);
            });
        }
        
        if (newButton) {
            newButton.addEventListener('click', function() {
                updateButtonStates(this);
                showRows(newRows);
            });
        }
    }
    
    // فراخوانی تابع تنظیم دکمه‌های فیلتر
    setupFilterButtons();
    
    // دکمه‌های تحلیل
    const analysisButtons = document.querySelectorAll('.btn-outline-primary');
    
    // اضافه کردن رویداد کلیک برای نمایش تحلیل فنی
    analysisButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            
            // دریافت اطلاعات ارز از سطر کلیک شده
            const row = this.closest('tr');
            const cryptoNameElement = row.querySelector('.d-flex > div:nth-child(2)');
            const cryptoSymbolElement = row.querySelector('td:nth-child(3)');
            
            if (cryptoNameElement && cryptoSymbolElement) {
                const cryptoName = cryptoNameElement.textContent;
                const cryptoSymbol = cryptoSymbolElement.textContent;
                
                // به روزرسانی بخش تحلیل
                const nameElement = document.getElementById('selected-crypto-name');
                const symbolElement = document.getElementById('selected-crypto-symbol');
                
                if (nameElement && symbolElement) {
                    nameElement.textContent = cryptoName;
                    symbolElement.textContent = cryptoSymbol;
                }
                
                // اسکرول به بخش تحلیل
                const analysisSection = document.querySelector('.card-header');
                if (analysisSection && analysisSection.textContent.includes('تحلیل تکنیکال')) {
                    analysisSection.scrollIntoView({
                        behavior: 'smooth'
                    });
                } else {
                    // اگر بخش تحلیل پیدا نشد، به انتهای صفحه اسکرول کن
                    window.scrollTo({
                        top: document.body.scrollHeight,
                        behavior: 'smooth'
                    });
                }
            }
        });
    });
    
    // تنظیم دکمه‌های زبانه برای تحلیل فنی / اخبار
    function setupTabs() {
        const tabTechnical = document.getElementById('tab-technical');
        const tabNews = document.getElementById('tab-news');
        const technicalContent = document.getElementById('technical-analysis-content');
        const newsContent = document.getElementById('news-analysis-content');
        
        if (tabTechnical && tabNews && technicalContent && newsContent) {
            tabTechnical.addEventListener('click', function() {
                // فعال‌سازی دکمه تحلیل فنی
                tabTechnical.classList.add('active');
                tabNews.classList.remove('active');
                
                // نمایش محتوای تحلیل فنی و مخفی کردن اخبار
                technicalContent.style.display = 'block';
                newsContent.style.display = 'none';
            });
            
            tabNews.addEventListener('click', function() {
                // فعال‌سازی دکمه اخبار
                tabNews.classList.add('active');
                tabTechnical.classList.remove('active');
                
                // نمایش محتوای اخبار و مخفی کردن تحلیل فنی
                newsContent.style.display = 'block';
                technicalContent.style.display = 'none';
                
                // به‌روزرسانی نام رمزارز در بخش اخبار
                const cryptoName = document.getElementById('selected-crypto-name').textContent;
                const cryptoName2 = document.getElementById('selected-crypto-name2');
                if (cryptoName2) {
                    cryptoName2.textContent = cryptoName;
                }
            });
            
            // دکمه بارگذاری اخبار بیشتر
            const loadMoreButton = document.getElementById('load-more-news');
            if (loadMoreButton) {
                loadMoreButton.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // شبیه‌سازی بارگذاری اخبار بیشتر
                    loadMoreButton.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> در حال بارگذاری...';
                    
                    // شبیه‌سازی تأخیر در بارگذاری
                    setTimeout(() => {
                        // افزودن یک خبر جدید
                        const newsContainer = document.querySelector('.news-container');
                        const newNewsItem = document.createElement('div');
                        newNewsItem.className = 'news-item mb-3 p-3 border-start border-4 border-success';
                        newNewsItem.innerHTML = `
                            <h6 class="news-title mb-2">گزارش: سرمایه‌گذاری نهادی در رمزارزها افزایش یافته است</h6>
                            <p class="news-excerpt text-muted mb-1">گزارش‌ها حاکی از آن است که سرمایه‌گذاری نهادی در بازار رمزارزها، خصوصاً بیت‌کوین و اتریوم به شدت افزایش یافته است. این روند می‌تواند نشانه‌ای از پذیرش گسترده‌تر ارزهای دیجیتال باشد.</p>
                            <div class="d-flex justify-content-between align-items-center">
                                <small class="news-source">منبع: تحلیل مالی کریپتو</small>
                                <small class="news-date">۵ آوریل ۲۰۲۵</small>
                            </div>
                            <div class="news-sentiment mt-2">
                                <span class="badge bg-success">احساس بازار: بسیار مثبت</span>
                            </div>
                        `;
                        
                        if (newsContainer) {
                            newsContainer.appendChild(newNewsItem);
                        }
                        
                        // بازگرداندن دکمه به حالت اصلی
                        loadMoreButton.innerHTML = '<i class="fas fa-sync me-1"></i> بارگذاری اخبار بیشتر';
                    }, 1500);
                });
            }
        }
    }
    
    // شبیه‌سازی به‌روزرسانی قیمت‌ها (در حالت واقعی با API جایگزین می‌شود)
    function updatePrices() {
        const cryptoPriceElements = document.querySelectorAll('[id$="-price"]');
        const cryptoChangeElements = document.querySelectorAll('[id$="-change"]');
        
        cryptoPriceElements.forEach(el => {
            // اطمینان از اینکه محتوا یک عدد معتبر است
            const currentText = el.textContent.trim().replace(/,/g, '');
            if (!isNaN(parseFloat(currentText))) {
                const currentPrice = parseFloat(currentText);
                const change = (Math.random() - 0.5) * 0.001; // تغییر کوچک تصادفی
                const newPrice = currentPrice * (1 + change);
                el.textContent = newPrice.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            }
        });
        
        cryptoChangeElements.forEach(el => {
            // اطمینان از اینکه محتوا یک عدد معتبر است
            const currentText = el.textContent.trim().replace(/%/g, '').replace(/\+/g, '');
            if (!isNaN(parseFloat(currentText))) {
                const currentChange = parseFloat(currentText);
                const fluctuation = (Math.random() - 0.5) * 0.1; 
                const newChange = currentChange + fluctuation;
                
                el.textContent = (newChange >= 0 ? '+' : '') + newChange.toFixed(2) + '%';
                
                // به‌روزرسانی رنگ‌ها
                if (newChange >= 0) {
                    el.className = 'text-success';
                } else {
                    el.className = 'text-danger';
                }
            }
        });
    }
    
    // به‌روزرسانی قیمت‌ها هر 5 ثانیه
    setInterval(updatePrices, 5000);
    
    // اجرای توابع اصلی
    setupTabs();
    setTimeout(updatePrices, 1000);
});
</script>
{% endblock %}