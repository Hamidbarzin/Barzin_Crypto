{% extends "minimal_base.html" %}

{% block title %}Markets | Barzin Crypto English{% endblock %}

{% block content %}
<!-- Header with creator information -->

<div class="row mb-3">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <h1 class="mb-0">Markets</h1>
        </div>
        <p class="text-muted mt-2">Complete list of monitored and analyzed cryptocurrency markets</p>
    </div>
</div>
<div id="dashboard-content">

    <!-- Cryptocurrency Categories -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card crypto-card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Market Categories</h5>
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-sm btn-warning active" data-crypto-category="all">All Coins</button>
                        <button type="button" class="btn btn-sm btn-outline-warning" data-crypto-category="major">Major Coins</button>
                        <button type="button" class="btn btn-sm btn-outline-warning" data-crypto-category="promising">AI Coins</button>
                        <button type="button" class="btn btn-sm btn-outline-warning" data-crypto-category="new">Layer 1 & 2</button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead>
                                <tr>
                                    <th scope="col">#</th>
                                    <th scope="col">Coin</th>
                                    <th scope="col">Symbol</th>
                                    <th scope="col">Price (USDT)</th>
                                    <th scope="col">Change (24h)</th>
                                    <th scope="col">Volume (24h)</th>
                                    <th scope="col">Signal</th>
                                    <th scope="col">Analysis</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- List of cryptocurrencies using dynamic data -->
                                {% for coin in cryptocurrencies %}
                                {% if coin.id <= 7 %}
                                <tr class="crypto-row major">
                                {% elif coin.id <= 13 %}
                                <tr class="crypto-row promising">
                                {% else %}
                                <tr class="crypto-row new">
                                {% endif %}
                                    <td>{{ coin.id }}</td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="icon-circle me-2">
                                                <i class="{{ coin.icon }}"></i>
                                            </div>
                                            <div>{{ coin.name }}</div>
                                        </div>
                                    </td>
                                    <td>{{ coin.symbol }}</td>
                                    <td id="{{ coin.symbol.replace('/', '-') }}-price">{{ coin.price }}</td>
                                    <td id="{{ coin.symbol.replace('/', '-') }}-change" class="{% if coin.change.startswith('+') %}text-success{% else %}text-danger{% endif %}">{{ coin.change }}</td>
                                    <td>{{ coin.volume }}</td>
                                    <td><span class="badge bg-{{ coin.signal_class }}">{{ coin.signal }}</span></td>
                                    <td><a href="#" class="btn btn-sm btn-outline-primary analysis-button">Technical Analysis</a></td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Technical Analysis for Selected Crypto -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card crypto-card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Technical Analysis <span id="selected-crypto-name">Bitcoin</span></h5>
                    <div class="border rounded p-1 bg-dark">
                        <button onclick="document.getElementById('technical-analysis-content').style.display='block'; document.getElementById('news-analysis-content').style.display='none';" class="btn btn-sm btn-outline-primary mx-1">Technical Analysis</button>
                        <button onclick="document.getElementById('technical-analysis-content').style.display='none'; document.getElementById('news-analysis-content').style.display='block';" class="btn btn-sm btn-primary mx-1">News & Analysis</button>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Technical Analysis Section -->
                    <div id="technical-analysis-content">
                        <!-- Loading status -->
                        <div id="technical-loading" style="display: none;">
                            <div class="text-center my-5">
                                <div class="spinner-border text-warning" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2 text-muted">Loading technical analysis for <span id="selected-crypto-symbol2">BTC/USDT</span>...</p>
                            </div>
                        </div>
                        
                        <!-- Technical Analysis Content -->
                        <div id="technical-content">
                            <div class="row">
                                <div class="col-md-8">
                                    <!-- Chart Placeholder -->
                                    <div class="chart-container" style="height: 300px; background: #1c1c28; border-radius: 8px;">
                                        <div class="d-flex justify-content-center align-items-center h-100">
                                            <p class="text-muted">Price chart for <span id="selected-crypto-symbol">BTC/USDT</span> will load soon</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="indicator-box mb-3">
                                        <div class="indicator-label">RSI (Relative Strength Index)</div>
                                        <div class="progress" style="height: 8px;">
                                            <div class="progress-bar bg-success" role="progressbar" style="width: 65%;" aria-valuenow="65" aria-valuemin="0" aria-valuemax="100"></div>
                                        </div>
                                        <div class="d-flex justify-content-between">
                                            <small class="text-muted">Oversold</small>
                                            <small class="text-muted">Neutral</small>
                                            <small class="text-muted">Overbought</small>
                                        </div>
                                        <div class="indicator-value">65</div>
                                    </div>
                                
                                <div class="indicator-box mb-3">
                                    <div class="indicator-label">MACD</div>
                                    <div class="d-flex justify-content-between">
                                        <div>Signal: <span class="text-info">12.2</span></div>
                                        <div>MACD Line: <span class="text-warning">15.8</span></div>
                                    </div>
                                    <div class="indicator-description">
                                        <span class="text-success">
                                            <i class="fas fa-arrow-up me-1"></i>
                                            Bullish trend (Buy signal)
                                        </span>
                                    </div>
                                </div>
                                
                                <div class="indicator-box">
                                    <div class="indicator-label">Moving Averages</div>
                                    <div class="d-flex justify-content-between mt-2">
                                        <div>MA20: <span class="text-info">63,200</span></div>
                                        <div>MA50: <span class="text-warning">61,500</span></div>
                                    </div>
                                    <div class="indicator-description">
                                        <span class="text-success">
                                            <i class="fas fa-check-circle me-1"></i>
                                            Price above moving averages (Bullish trend)
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- News and Analysis Section -->
                    <div id="news-analysis-content" style="display: block;">
                        <h6 class="border-bottom pb-2 mb-3">Latest news about <span id="selected-crypto-name2">Bitcoin</span></h6>
                        <div class="news-container">
                            <div class="news-item mb-3 p-3 border-start border-4 border-primary">
                                <h6 class="news-title mb-2">Bitcoin Reaches All-Time High Price</h6>
                                <p class="news-excerpt text-muted mb-1">Bitcoin has reached its all-time high price by surpassing $70,000. This event follows increased demand from ETF funds and institutional investors.</p>
                                <div class="d-flex justify-content-between align-items-center">
                                    <small class="news-source">Source: Cryptocurrency News Agency</small>
                                    <small class="news-date">April 8, 2025</small>
                                </div>
                                <div class="news-sentiment mt-2">
                                    <span class="badge bg-success">Market sentiment: Positive</span>
                                </div>
                            </div>
                            
                            <div class="news-item mb-3 p-3 border-start border-4 border-warning">
                                <h6 class="news-title mb-2">Analysts: Potential Short-Term Correction in Bitcoin Price</h6>
                                <p class="news-excerpt text-muted mb-1">Some analysts believe that after the recent growth, Bitcoin may experience a temporary price correction. Technical indicators show the market is in an overbought condition.</p>
                                <div class="d-flex justify-content-between align-items-center">
                                    <small class="news-source">Source: Market Analysts</small>
                                    <small class="news-date">April 7, 2025</small>
                                </div>
                                <div class="news-sentiment mt-2">
                                    <span class="badge bg-warning">Market sentiment: Neutral</span>
                                </div>
                            </div>
                            
                            <div class="news-item mb-3 p-3 border-start border-4 border-info">
                                <h6 class="news-title mb-2">Targeted Trading Strategy: Right Time to Enter the Market</h6>
                                <p class="news-excerpt text-muted mb-1">With Bitcoin's price stabilizing above $65,000, many traders consider this range suitable for market entry. A gradual buying strategy can reduce risk.</p>
                                <div class="d-flex justify-content-between align-items-center">
                                    <small class="news-source">Source: Crypto World</small>
                                    <small class="news-date">April 6, 2025</small>
                                </div>
                                <div class="news-sentiment mt-2">
                                    <span class="badge bg-info">Market sentiment: Cautiously positive</span>
                                </div>
                            </div>
                        </div>
                        
                        <a href="#" class="btn btn-outline-secondary btn-sm mt-2 w-100" id="load-more-news" onclick="loadMoreNews(); return false;">
                            <i class="fas fa-sync me-1"></i> Load More News
                        </a>
                        
<script>
// Function to load more news
function loadMoreNews() {
    const loadMoreButton = document.getElementById('load-more-news');
    const newsContainer = document.querySelector('.news-container');
    
    if (loadMoreButton && newsContainer) {
        // Show loading state
        loadMoreButton.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Loading...';
        
        // Simulate loading delay (in the actual version this would be replaced by an API request)
        setTimeout(() => {
            // Add new news item
            const newNewsItem = document.createElement('div');
            newNewsItem.className = 'news-item mb-3 p-3 border-start border-4 border-success';
            newNewsItem.innerHTML = `
                <h6 class="news-title mb-2">Report: Institutional Investment in Cryptocurrencies is Increasing</h6>
                <p class="news-excerpt text-muted mb-1">Reports indicate that institutional investment in the cryptocurrency market, especially Bitcoin and Ethereum, has increased dramatically. This trend could be a sign of broader adoption of digital currencies.</p>
                <div class="d-flex justify-content-between align-items-center">
                    <small class="news-source">Source: Crypto Financial Analysis</small>
                    <small class="news-date">April 5, 2025</small>
                </div>
                <div class="news-sentiment mt-2">
                    <span class="badge bg-success">Market sentiment: Very positive</span>
                </div>
            `;
            
            newsContainer.appendChild(newNewsItem);
            
            // Restore button to original state
            loadMoreButton.innerHTML = '<i class="fas fa-sync me-1"></i> Load More News';
        }, 1000);
    }
}
</script>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Price formatting function
    function formatPrice(price) {
        if (price === null || price === undefined || isNaN(price)) {
            return '--';
        }
        
        // If price is large (no decimal)
        if (price >= 1000) {
            return price.toLocaleString('en-US', {maximumFractionDigits: 0});
        }
        
        // If price is small (more decimal places needed)
        if (price < 0.01) {
            return price.toLocaleString('en-US', {minimumFractionDigits: 6, maximumFractionDigits: 6});
        }
        
        // Default: 2 decimal places
        return price.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
    }
    
    // Function to get technical analysis from API
    function loadTechnicalData(symbol) {
        // Show loading status
        const loadingEl = document.getElementById('technical-loading');
        const contentEl = document.getElementById('technical-content');
        
        if (loadingEl && contentEl) {
            loadingEl.style.display = 'block';
            contentEl.style.display = 'none';
        }
        
        // API request
        fetch(`/api/technical/${symbol}/1d`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.data) {
                    const analysis = data.data;
                    
                    // Update RSI
                    if (analysis.rsi !== undefined) {
                        const rsiEl = document.querySelector('.indicator-box:nth-child(1) .indicator-value');
                        const rsiProgressEl = document.querySelector('.indicator-box:nth-child(1) .progress-bar');
                        
                        if (rsiEl) {
                            rsiEl.textContent = analysis.rsi.toFixed(1);
                        }
                        
                        if (rsiProgressEl) {
                            rsiProgressEl.style.width = `${analysis.rsi}%`;
                            
                            // Change color based on value
                            rsiProgressEl.classList.remove('bg-success', 'bg-danger', 'bg-warning');
                            if (analysis.rsi < 30) {
                                rsiProgressEl.classList.add('bg-danger');
                            } else if (analysis.rsi > 70) {
                                rsiProgressEl.classList.add('bg-success');
                            } else {
                                rsiProgressEl.classList.add('bg-warning');
                            }
                        }
                    }
                    
                    // Update MACD
                    if (analysis.macd !== undefined && analysis.macd_signal !== undefined) {
                        const macdEl = document.querySelector('.indicator-box:nth-child(2) .text-warning');
                        const signalEl = document.querySelector('.indicator-box:nth-child(2) .text-info');
                        const macdDescEl = document.querySelector('.indicator-box:nth-child(2) .indicator-description span');
                        
                        if (macdEl) {
                            macdEl.textContent = analysis.macd.toFixed(2);
                        }
                        
                        if (signalEl) {
                            signalEl.textContent = analysis.macd_signal.toFixed(2);
                        }
                        
                        if (macdDescEl) {
                            if (analysis.macd > analysis.macd_signal) {
                                macdDescEl.innerHTML = '<i class="fas fa-arrow-up me-1"></i> Bullish trend (Buy signal)';
                                macdDescEl.className = 'text-success';
                            } else {
                                macdDescEl.innerHTML = '<i class="fas fa-arrow-down me-1"></i> Bearish trend (Sell signal)';
                                macdDescEl.className = 'text-danger';
                            }
                        }
                    }
                    
                    // Update Moving Averages
                    if (analysis.ma20 !== undefined && analysis.ma50 !== undefined) {
                        const ma20El = document.querySelector('.indicator-box:nth-child(3) .text-info');
                        const ma50El = document.querySelector('.indicator-box:nth-child(3) .text-warning');
                        const maDescEl = document.querySelector('.indicator-box:nth-child(3) .indicator-description span');
                        
                        if (ma20El) {
                            ma20El.textContent = formatPrice(analysis.ma20);
                        }
                        
                        if (ma50El) {
                            ma50El.textContent = formatPrice(analysis.ma50);
                        }
                        
                        if (maDescEl && analysis.current_price !== undefined) {
                            if (analysis.current_price > analysis.ma20 && analysis.ma20 > analysis.ma50) {
                                maDescEl.innerHTML = '<i class="fas fa-check-circle me-1"></i> Price above moving averages (Bullish trend)';
                                maDescEl.className = 'text-success';
                            } else if (analysis.current_price < analysis.ma20 && analysis.ma20 < analysis.ma50) {
                                maDescEl.innerHTML = '<i class="fas fa-times-circle me-1"></i> Price below moving averages (Bearish trend)';
                                maDescEl.className = 'text-danger';
                            } else {
                                maDescEl.innerHTML = '<i class="fas fa-minus-circle me-1"></i> Price between moving averages (Neutral trend)';
                                maDescEl.className = 'text-warning';
                            }
                        }
                    }
                    
                    // Show results and hide loading state
                    if (loadingEl && contentEl) {
                        loadingEl.style.display = 'none';
                        contentEl.style.display = 'block';
                    }
                } else {
                    console.error('Error loading technical data:', data.message || 'Unknown error');
                    
                    // Hide loading and show error message
                    if (loadingEl && contentEl) {
                        loadingEl.style.display = 'none';
                        contentEl.style.display = 'block';
                        contentEl.innerHTML = '<div class="alert alert-danger">Error loading technical analysis data</div>';
                    }
                }
            })
            .catch(error => {
                console.error('Error loading technical data:', error);
                
                // Hide loading and show error message
                if (loadingEl && contentEl) {
                    loadingEl.style.display = 'none';
                    contentEl.style.display = 'block';
                    contentEl.innerHTML = '<div class="alert alert-danger">Error connecting to server</div>';
                }
            });
    }
    
    // Simple method for filtering cryptocurrencies
    function setupFilterButtons() {
        // Select buttons and table rows
        const allButton = document.querySelector('[data-crypto-category="all"]');
        const majorButton = document.querySelector('[data-crypto-category="major"]');
        const promisingButton = document.querySelector('[data-crypto-category="promising"]');
        const newButton = document.querySelector('[data-crypto-category="new"]');
        
        const allRows = document.querySelectorAll('.crypto-row');
        const majorRows = document.querySelectorAll('.crypto-row.major');
        const promisingRows = document.querySelectorAll('.crypto-row.promising');
        const newRows = document.querySelectorAll('.crypto-row.new');
        
        console.log('Total rows:', allRows.length);
        console.log('Major coin rows:', majorRows.length);
        console.log('Promising coin rows:', promisingRows.length);
        console.log('New coin rows:', newRows.length);
        
        // Function to show or hide rows
        function showRows(rowsToShow) {
            // Hide all rows
            allRows.forEach(row => {
                row.style.display = 'none';
            });
            
            // Show only selected rows
            rowsToShow.forEach(row => {
                row.style.display = '';
            });
        }
        
        // Function to update button states
        function updateButtonStates(activeButton) {
            [allButton, majorButton, promisingButton, newButton].forEach(button => {
                button.classList.remove('active');
                button.classList.remove('btn-warning');
                button.classList.add('btn-outline-warning');
            });
            
            activeButton.classList.add('active');
            activeButton.classList.remove('btn-outline-warning');
            activeButton.classList.add('btn-warning');
        }
        
        // Add click event for each button
        if (allButton) {
            allButton.addEventListener('click', function() {
                updateButtonStates(this);
                showRows(allRows);
            });
        }
        
        if (majorButton) {
            majorButton.addEventListener('click', function() {
                updateButtonStates(this);
                showRows(majorRows);
            });
        }
        
        if (promisingButton) {
            promisingButton.addEventListener('click', function() {
                updateButtonStates(this);
                showRows(promisingRows);
            });
        }
        
        if (newButton) {
            newButton.addEventListener('click', function() {
                updateButtonStates(this);
                showRows(newRows);
            });
        }
    }
    
    // Call the filter buttons setup function
    setupFilterButtons();
    
    // Analysis buttons in the cryptocurrencies table
    const tableAnalysisButtons = document.querySelectorAll('td .analysis-button');
    
    // Add click event for showing technical analysis
    tableAnalysisButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            
            // Get cryptocurrency info from the clicked row
            const row = this.closest('tr');
            const cryptoNameElement = row.querySelector('.d-flex > div:nth-child(2)');
            const cryptoSymbolElement = row.querySelector('td:nth-child(3)');
            
            if (cryptoNameElement && cryptoSymbolElement) {
                const cryptoName = cryptoNameElement.textContent;
                const cryptoSymbol = cryptoSymbolElement.textContent;
                
                // Update analysis section
                const nameElement = document.getElementById('selected-crypto-name');
                const symbolElement = document.getElementById('selected-crypto-symbol');
                const nameElement2 = document.getElementById('selected-crypto-name2');
                
                if (nameElement && symbolElement) {
                    nameElement.textContent = cryptoName;
                    symbolElement.textContent = cryptoSymbol;
                    
                    if (nameElement2) {
                        nameElement2.textContent = cryptoName;
                    }
                    
                    // Request technical analysis data for selected cryptocurrency
                    loadTechnicalData(cryptoSymbol);
                }
                
                // Show technical analysis section (instead of news)
                document.getElementById('technical-analysis-content').style.display = 'none';
                document.getElementById('news-analysis-content').style.display = 'block';
                
                // Scroll to analysis section
                const analysisSection = document.querySelector('.card-header');
                if (analysisSection && analysisSection.textContent.includes('Technical Analysis')) {
                    analysisSection.scrollIntoView({
                        behavior: 'smooth'
                    });
                } else {
                    // If analysis section not found, scroll to end of page
                    window.scrollTo({
                        top: document.body.scrollHeight,
                        behavior: 'smooth'
                    });
                }
            }
        });
    });
    
    // Setup tabs for technical analysis / news
    function setupTabs() {
        // Function to show technical analysis
        function showTechnical() {
            const technicalContent = document.getElementById('technical-analysis-content');
            const newsContent = document.getElementById('news-analysis-content');
            const techButton = document.getElementById('show-technical');
            const newsButton = document.getElementById('show-news');
            
            if (technicalContent && newsContent && techButton && newsButton) {
                technicalContent.style.display = 'block';
                newsContent.style.display = 'none';
                
                techButton.classList.add('btn-primary');
                techButton.classList.remove('btn-outline-primary');
                
                newsButton.classList.add('btn-outline-primary');
                newsButton.classList.remove('btn-primary');
                
                console.log('Showing technical analysis');
            }
        }
        
        // Function to show news
        function showNews() {
            const technicalContent = document.getElementById('technical-analysis-content');
            const newsContent = document.getElementById('news-analysis-content');
            const techButton = document.getElementById('show-technical');
            const newsButton = document.getElementById('show-news');
            
            if (technicalContent && newsContent && techButton && newsButton) {
                technicalContent.style.display = 'none';
                newsContent.style.display = 'block';
                
                techButton.classList.add('btn-outline-primary');
                techButton.classList.remove('btn-primary');
                
                newsButton.classList.add('btn-primary');
                newsButton.classList.remove('btn-outline-primary');
                
                // Update cryptocurrency name in news section
                const cryptoName = document.getElementById('selected-crypto-name').textContent;
                const cryptoName2 = document.getElementById('selected-crypto-name2');
                if (cryptoName2) {
                    cryptoName2.textContent = cryptoName;
                }
                
                console.log('Showing news and analysis');
            }
        }
        
        // Define functions at global scope
        window.showTechnical = showTechnical;
        window.showNews = showNews;
        
        // Add event listeners to buttons
        const techButton = document.getElementById('show-technical');
        const newsButton = document.getElementById('show-news');
        
        if (techButton) {
            techButton.addEventListener('click', showTechnical);
        }
        
        if (newsButton) {
            newsButton.addEventListener('click', showNews);
        }
    }
    
    // Update cryptocurrency prices (API-based)
    function updatePrices() {
        const cryptoPriceElements = document.querySelectorAll('[id$="-price"]');
        const cryptoChangeElements = document.querySelectorAll('[id$="-change"]');
        
        // Update prices using API
        cryptoPriceElements.forEach(el => {
            const domId = el.id;
            const symbol = domId.replace('-price', '');
            if (symbol) {
                fetch(`/api/price/${symbol}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success && data.data) {
                            // Update price
                            el.textContent = formatPrice(data.data.price);
                            
                            // Update percentage change (if element exists)
                            const changeEl = document.getElementById(`${symbol}-change`);
                            if (changeEl && data.data.change_24h !== undefined) {
                                const newChange = data.data.change_24h;
                                changeEl.textContent = (newChange >= 0 ? '+' : '') + newChange.toFixed(2) + '%';
                                
                                // Update colors
                                if (newChange >= 0) {
                                    changeEl.className = 'text-success';
                                } else {
                                    changeEl.className = 'text-danger';
                                }
                            }
                        }
                    })
                    .catch(error => {
                        console.error(`Error fetching price for ${symbol}:`, error);
                    });
            }
        });
    }
    
    // Update prices every 5 seconds
    setInterval(updatePrices, 5000);
    
    // Execute main functions
    setupTabs();
    setTimeout(updatePrices, 1000);
});
</script>

{% endblock %}