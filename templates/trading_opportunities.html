{% extends "base.html" %}

{% block title %}فرصت‌های معاملاتی و نوسانات بازار{% endblock %}

{% block extra_css %}
<style>
    .opportunity-card {
        border-radius: 10px;
        margin-bottom: 20px;
        transition: transform 0.3s;
        border: none;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .opportunity-card:hover {
        transform: translateY(-5px);
    }
    
    .opportunity-card.buy {
        border-left: 5px solid #4CAF50;
    }
    
    .opportunity-card.sell {
        border-left: 5px solid #F44336;
    }
    
    .opportunity-card.neutral {
        border-left: 5px solid #FF9800;
    }
    
    .opportunity-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .badge-buy {
        background-color: #4CAF50;
    }
    
    .badge-sell {
        background-color: #F44336;
    }
    
    .badge-neutral {
        background-color: #FF9800;
    }
    
    .strength-meter {
        height: 8px;
        border-radius: 4px;
        margin: 10px 0;
        background-color: #e9ecef;
    }
    
    .strength-value {
        height: 100%;
        border-radius: 4px;
    }
    
    .strength-buy {
        background-color: #4CAF50;
    }
    
    .strength-sell {
        background-color: #F44336;
    }
    
    .factor-bar {
        height: 6px;
        border-radius: 3px;
        margin: 5px 0;
        background-color: #e9ecef;
        position: relative;
    }
    
    .factor-value {
        height: 100%;
        border-radius: 3px;
        position: absolute;
        left: 50%;
        transform: translateX(-50%);
    }
    
    .factor-value.positive {
        background-color: #4CAF50;
    }
    
    .factor-value.negative {
        background-color: #F44336;
    }
    
    .factor-value.neutral {
        background-color: #FF9800;
    }
    
    .volatility-card {
        border-radius: 10px;
        margin-bottom: 20px;
        transition: transform 0.3s;
        border: none;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        border-left: 5px solid #2196F3;
    }
    
    .volatility-card:hover {
        transform: translateY(-5px);
    }
    
    .trend-card {
        border-radius: 10px;
        transition: transform 0.3s;
        border: none;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .trend-card.up {
        border-left: 5px solid #4CAF50;
    }
    
    .trend-card.down {
        border-left: 5px solid #F44336;
    }
    
    .trend-card.neutral {
        border-left: 5px solid #FF9800;
    }
    
    .refresh-button {
        position: fixed;
        bottom: 30px;
        right: 30px;
        z-index: 999;
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background-color: #FFC107;
        color: #212529;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 24px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        transition: transform 0.3s, background-color 0.3s;
    }
    
    .refresh-button:hover {
        transform: rotate(180deg);
        background-color: #FFD54F;
    }
    
    .loading {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        z-index: 9999;
        justify-content: center;
        align-items: center;
    }
    
    .loading-spinner {
        width: 50px;
        height: 50px;
        border: 5px solid #f3f3f3;
        border-top: 5px solid #FFC107;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block content %}
<div class="loading" id="loading">
    <div class="loading-spinner"></div>
</div>

<div class="row">
    <div class="col-md-8">
        <h1 class="mb-4">فرصت‌های معاملاتی و نوسانات بازار</h1>
    </div>
    <div class="col-md-4 text-end">
        <select class="form-select mb-4" id="sensitivitySelect">
            <option value="low">حساسیت کم</option>
            <option value="medium" selected>حساسیت متوسط</option>
            <option value="high">حساسیت زیاد</option>
        </select>
    </div>
</div>

<div class="row">
    <div class="col-md-7">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-exchange-alt me-2"></i> فرصت‌های خرید و فروش</h5>
            </div>
            <div class="card-body">
                <div id="opportunities-container"></div>
                <div id="no-opportunities" class="alert alert-info d-none">
                    هیچ فرصت معاملاتی با تنظیمات فعلی شناسایی نشد.
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-5">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i> نوسانات اخیر بازار</h5>
            </div>
            <div class="card-body">
                <div class="d-flex align-items-center mb-3">
                    <span class="me-2">بازه زمانی:</span>
                    <select class="form-select" id="timeframeSelect">
                        <option value="5m">۵ دقیقه</option>
                        <option value="15m">۱۵ دقیقه</option>
                        <option value="1h" selected>۱ ساعت</option>
                        <option value="4h">۴ ساعت</option>
                        <option value="1d">روزانه</option>
                    </select>
                </div>
                <div id="volatility-container"></div>
                <div id="no-volatility" class="alert alert-info d-none">
                    هیچ نوسان قابل توجهی در بازه زمانی انتخاب شده شناسایی نشد.
                </div>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-globe me-2"></i> روند کلی بازار</h5>
            </div>
            <div class="card-body" id="market-trend">
                <div class="text-center p-4">
                    <div class="spinner-border text-warning" role="status">
                        <span class="visually-hidden">در حال بارگذاری...</span>
                    </div>
                    <p class="mt-2">در حال تحلیل روند بازار...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<a href="#" class="refresh-button" id="refreshButton" title="به‌روزرسانی داده‌ها">
    <i class="fas fa-sync-alt"></i>
</a>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const opportunitiesContainer = document.getElementById('opportunities-container');
        const noOpportunities = document.getElementById('no-opportunities');
        const volatilityContainer = document.getElementById('volatility-container');
        const noVolatility = document.getElementById('no-volatility');
        const marketTrend = document.getElementById('market-trend');
        const technicalAnalysisContainer = document.getElementById('technical-analysis-container');
        const noTechnicalAnalysis = document.getElementById('no-technical-analysis');
        const refreshButton = document.getElementById('refreshButton');
        const sensitivitySelect = document.getElementById('sensitivitySelect');
        const timeframeSelect = document.getElementById('timeframeSelect');
        const symbolSelect = document.getElementById('symbolSelect');
        const loading = document.getElementById('loading');
        
        // Load initial data
        loadData();
        
        refreshButton.addEventListener('click', function(e) {
            e.preventDefault();
            loadData();
        });
        
        sensitivitySelect.addEventListener('change', loadOpportunities);
        timeframeSelect.addEventListener('change', loadVolatility);
        
        if (symbolSelect) {
            symbolSelect.addEventListener('change', loadTechnicalAnalysis);
        }
        
        function loadData() {
            loading.style.display = 'flex';
            
            Promise.all([
                loadOpportunities(),
                loadVolatility(),
                loadMarketTrend(),
                loadTechnicalAnalysis()
            ]).then(() => {
                loading.style.display = 'none';
            }).catch(error => {
                console.error('Error loading data:', error);
                loading.style.display = 'none';
            });
        }
        
        function loadOpportunities() {
            const sensitivity = sensitivitySelect.value;
            
            return fetch(`/api/opportunities?sensitivity=${sensitivity}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.data && data.data.length > 0) {
                        opportunitiesContainer.innerHTML = '';
                        noOpportunities.classList.add('d-none');
                        
                        data.data.forEach(opportunity => {
                            const card = createOpportunityCard(opportunity);
                            opportunitiesContainer.appendChild(card);
                        });
                    } else {
                        opportunitiesContainer.innerHTML = '';
                        noOpportunities.classList.remove('d-none');
                    }
                })
                .catch(error => {
                    console.error('Error fetching opportunities:', error);
                    opportunitiesContainer.innerHTML = '<div class="alert alert-danger">خطا در بارگذاری داده‌ها</div>';
                });
        }
        
        function loadVolatility() {
            const timeframe = timeframeSelect.value;
            
            return fetch(`/api/volatility?timeframe=${timeframe}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.data && data.data.length > 0) {
                        volatilityContainer.innerHTML = '';
                        noVolatility.classList.add('d-none');
                        
                        data.data.forEach(volatility => {
                            const card = createVolatilityCard(volatility);
                            volatilityContainer.appendChild(card);
                        });
                    } else {
                        volatilityContainer.innerHTML = '';
                        noVolatility.classList.remove('d-none');
                    }
                })
                .catch(error => {
                    console.error('Error fetching volatility:', error);
                    volatilityContainer.innerHTML = '<div class="alert alert-danger">خطا در بارگذاری داده‌ها</div>';
                });
        }
        
        function loadMarketTrend() {
            return fetch('/api/market-trend')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.data) {
                        const trend = data.data;
                        const trendClass = trend.trend === 'صعودی' ? 'up' : trend.trend === 'نزولی' ? 'down' : 'neutral';
                        const trendIcon = trend.trend === 'صعودی' ? 'fa-arrow-up' : trend.trend === 'نزولی' ? 'fa-arrow-down' : 'fa-minus';
                        const trendColor = trend.trend === 'صعودی' ? 'text-success' : trend.trend === 'نزولی' ? 'text-danger' : 'text-warning';
                        
                        marketTrend.innerHTML = `
                            <div class="trend-card ${trendClass} p-3">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h5 class="mb-0">روند کلی: <span class="${trendColor}"><i class="fas ${trendIcon} me-1"></i> ${trend.trend}</span></h5>
                                    <span class="badge bg-dark">${trend.confidence}% اطمینان</span>
                                </div>
                                <p>${trend.description}</p>
                                <h6 class="mt-3 mb-2">ارزهای تحت تأثیر:</h6>
                                <div class="d-flex flex-wrap">
                                    ${trend.affected_coins.map(coin => `<span class="badge bg-secondary me-1 mb-1">${coin}</span>`).join('')}
                                </div>
                            </div>
                        `;
                    } else {
                        marketTrend.innerHTML = '<div class="alert alert-warning">اطلاعات روند بازار در دسترس نیست</div>';
                    }
                })
                .catch(error => {
                    console.error('Error fetching market trend:', error);
                    marketTrend.innerHTML = '<div class="alert alert-danger">خطا در بارگذاری داده‌ها</div>';
                });
        }
        
        function createOpportunityCard(opportunity) {
            const cardType = opportunity.action.toLowerCase().includes('خرید') ? 'buy' : 
                            opportunity.action.toLowerCase().includes('فروش') ? 'sell' : 'neutral';
            
            const strengthValue = Math.abs(opportunity.strength * 100);
            const strengthWidth = Math.min(Math.max(strengthValue, 10), 100);
            
            const div = document.createElement('div');
            div.className = `opportunity-card ${cardType} p-3`;
            div.innerHTML = `
                <div class="opportunity-header">
                    <h5 class="mb-0">${opportunity.symbol}</h5>
                    <span class="badge badge-${cardType}">${opportunity.action}</span>
                </div>
                <div class="mt-2">
                    <div class="d-flex justify-content-between">
                        <small>قدرت سیگنال</small>
                        <small>${strengthValue.toFixed(0)}%</small>
                    </div>
                    <div class="strength-meter">
                        <div class="strength-value strength-${cardType}" style="width: ${strengthWidth}%"></div>
                    </div>
                </div>
                <div class="mt-3">
                    <p><strong>قیمت فعلی:</strong> ${opportunity.price.toLocaleString()} دلار</p>
                    <p><strong>دلیل:</strong> ${opportunity.reason}</p>
                </div>
                <div class="mt-3">
                    <h6 class="mb-2">عوامل تأثیرگذار:</h6>
                    <div class="row">
                        ${Object.entries(opportunity.factors).map(([factor, value]) => {
                            const factorWidth = Math.abs(value * 100);
                            const factorClass = value > 0.1 ? 'positive' : value < -0.1 ? 'negative' : 'neutral';
                            
                            return `
                                <div class="col-6 mb-2">
                                    <div class="d-flex justify-content-between">
                                        <small>${translateFactor(factor)}</small>
                                        <small>${(value * 100).toFixed(0)}%</small>
                                    </div>
                                    <div class="factor-bar">
                                        <div class="factor-value ${factorClass}" style="width: ${factorWidth}%"></div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
            return div;
        }
        
        function createVolatilityCard(volatility) {
            const isPositive = volatility.change_percent > 0;
            const icon = isPositive ? 'fa-arrow-up' : 'fa-arrow-down';
            const colorClass = isPositive ? 'text-success' : 'text-danger';
            
            const div = document.createElement('div');
            div.className = 'volatility-card p-3 mb-3';
            div.innerHTML = `
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">${volatility.symbol}</h5>
                    <span class="${colorClass}"><i class="fas ${icon} me-1"></i> ${Math.abs(volatility.change_percent).toFixed(2)}%</span>
                </div>
                <p class="mt-2 mb-1">قیمت فعلی: ${volatility.price.toLocaleString()} دلار</p>
                <p class="mb-1 text-muted">بازه زمانی: ${translateTimeframe(volatility.timeframe)}</p>
                <p class="mb-0 text-muted small">${volatility.time}</p>
            `;
            return div;
        }
        
        function translateFactor(factor) {
            const translations = {
                'trend': 'روند',
                'rsi': 'شاخص RSI',
                'macd': 'شاخص MACD',
                'bollinger': 'باندهای بولینگر',
                'momentum': 'مومنتوم',
                'volatility': 'نوسان',
                'swing_trade': 'معاملات نوسانی',
                'news': 'اخبار'
            };
            
            return translations[factor] || factor;
        }
        
        function translateTimeframe(timeframe) {
            const translations = {
                '5m': '۵ دقیقه',
                '15m': '۱۵ دقیقه',
                '1h': '۱ ساعت',
                '4h': '۴ ساعت',
                '1d': 'روزانه'
            };
            
            return translations[timeframe] || timeframe;
        }
        
        function loadTechnicalAnalysis() {
            if (!technicalAnalysisContainer) {
                return Promise.resolve();
            }
            
            const symbol = symbolSelect ? symbolSelect.value : 'BTC/USDT';
            const timeframe = timeframeSelect.value;
            
            return fetch(`/api/technical?symbol=${symbol}&timeframe=${timeframe}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.data) {
                        const analysis = data.data;
                        noTechnicalAnalysis.classList.add('d-none');
                        
                        let signalClass, signalIcon, signalColor;
                        if (analysis.signal.includes('خرید قوی')) {
                            signalClass = 'success';
                            signalIcon = 'fa-arrow-up';
                            signalColor = 'text-success';
                        } else if (analysis.signal.includes('خرید')) {
                            signalClass = 'success';
                            signalIcon = 'fa-arrow-up';
                            signalColor = 'text-success';
                        } else if (analysis.signal.includes('فروش قوی')) {
                            signalClass = 'danger';
                            signalIcon = 'fa-arrow-down';
                            signalColor = 'text-danger';
                        } else if (analysis.signal.includes('فروش')) {
                            signalClass = 'danger';
                            signalIcon = 'fa-arrow-down';
                            signalColor = 'text-danger';
                        } else {
                            signalClass = 'warning';
                            signalIcon = 'fa-minus';
                            signalColor = 'text-warning';
                        }
                        
                        technicalAnalysisContainer.innerHTML = `
                            <div class="card p-3 mb-3 border-${signalClass}">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h5 class="mb-0">${analysis.symbol}</h5>
                                    <span class="badge bg-${signalClass}">
                                        <i class="fas ${signalIcon} me-1"></i> ${analysis.signal}
                                    </span>
                                </div>
                                
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <h6 class="mb-2">اندیکاتورهای قیمت</h6>
                                        <div class="table-responsive">
                                            <table class="table table-sm">
                                                <tbody>
                                                    ${analysis.ma20 ? `
                                                    <tr>
                                                        <td>MA 20:</td>
                                                        <td class="text-end">${analysis.ma20.toFixed(2)}</td>
                                                    </tr>` : ''}
                                                    ${analysis.ma50 ? `
                                                    <tr>
                                                        <td>MA 50:</td>
                                                        <td class="text-end">${analysis.ma50.toFixed(2)}</td>
                                                    </tr>` : ''}
                                                    ${analysis.ma200 ? `
                                                    <tr>
                                                        <td>MA 200:</td>
                                                        <td class="text-end">${analysis.ma200.toFixed(2)}</td>
                                                    </tr>` : ''}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <h6 class="mb-2">اندیکاتورهای مومنتوم</h6>
                                        <div class="table-responsive">
                                            <table class="table table-sm">
                                                <tbody>
                                                    ${analysis.rsi ? `
                                                    <tr>
                                                        <td>RSI:</td>
                                                        <td class="text-end">${analysis.rsi.toFixed(2)}</td>
                                                    </tr>` : ''}
                                                    ${analysis.macd ? `
                                                    <tr>
                                                        <td>MACD:</td>
                                                        <td class="text-end">${analysis.macd.toFixed(2)}</td>
                                                    </tr>` : ''}
                                                    ${analysis.macd_signal ? `
                                                    <tr>
                                                        <td>MACD Signal:</td>
                                                        <td class="text-end">${analysis.macd_signal.toFixed(2)}</td>
                                                    </tr>` : ''}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6 class="mb-2">باندهای بولینگر</h6>
                                        <div class="table-responsive">
                                            <table class="table table-sm">
                                                <tbody>
                                                    ${analysis.bb_upper ? `
                                                    <tr>
                                                        <td>باند بالایی:</td>
                                                        <td class="text-end">${analysis.bb_upper.toFixed(2)}</td>
                                                    </tr>` : ''}
                                                    ${analysis.bb_middle ? `
                                                    <tr>
                                                        <td>باند میانی:</td>
                                                        <td class="text-end">${analysis.bb_middle.toFixed(2)}</td>
                                                    </tr>` : ''}
                                                    ${analysis.bb_lower ? `
                                                    <tr>
                                                        <td>باند پایینی:</td>
                                                        <td class="text-end">${analysis.bb_lower.toFixed(2)}</td>
                                                    </tr>` : ''}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <h6 class="mb-2">اطلاعات بیشتر</h6>
                                        <div class="table-responsive">
                                            <table class="table table-sm">
                                                <tbody>
                                                    ${analysis.stoch_k ? `
                                                    <tr>
                                                        <td>Stochastic K:</td>
                                                        <td class="text-end">${analysis.stoch_k.toFixed(2)}</td>
                                                    </tr>` : ''}
                                                    ${analysis.stoch_d ? `
                                                    <tr>
                                                        <td>Stochastic D:</td>
                                                        <td class="text-end">${analysis.stoch_d.toFixed(2)}</td>
                                                    </tr>` : ''}
                                                    ${analysis.price_trend_10d ? `
                                                    <tr>
                                                        <td>روند 10 روزه:</td>
                                                        <td class="text-end">${analysis.price_trend_10d.toFixed(2)}%</td>
                                                    </tr>` : ''}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="text-muted small mt-2">
                                    بروزرسانی: ${analysis.timestamp}
                                </div>
                            </div>
                        `;
                    } else {
                        noTechnicalAnalysis.classList.remove('d-none');
                    }
                })
                .catch(error => {
                    console.error('Error fetching technical analysis:', error);
                    if (technicalAnalysisContainer) {
                        technicalAnalysisContainer.innerHTML = '<div class="alert alert-danger">خطا در بارگذاری تحلیل تکنیکال</div>';
                    }
                });
        }
        
        // Auto-refresh every 5 minutes
        setInterval(loadData, 5 * 60 * 1000);
    });
</script>
{% endblock %}