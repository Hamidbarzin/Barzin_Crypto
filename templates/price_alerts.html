{% extends 'minimal_base.html' %}

{% block title %}Price Alerts - Crypto Barzin{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-header bg-dark text-warning">
                    <h5 class="mb-0"><i class="fas fa-bell"></i> Price Alerts</h5>
                </div>
                <div class="card-body">
                    <p>When you set price alerts, you'll be notified via Telegram when the price of your selected cryptocurrency reaches your specified threshold.</p>
                    
                    <form id="price-alert-form" class="mb-4">
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="symbolSelect" class="form-label">Cryptocurrency</label>
                                <select class="form-select" id="symbolSelect" required>
                                    <option value="" selected disabled>Select coin...</option>
                                    <option value="BTC/USDT">Bitcoin (BTC)</option>
                                    <option value="ETH/USDT">Ethereum (ETH)</option>
                                    <option value="BNB/USDT">Binance Coin (BNB)</option>
                                    <option value="SOL/USDT">Solana (SOL)</option>
                                    <option value="XRP/USDT">Ripple (XRP)</option>
                                    <option value="ADA/USDT">Cardano (ADA)</option>
                                    <option value="DOGE/USDT">Dogecoin (DOGE)</option>
                                </select>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="priceInput" class="form-label">Price (USDT)</label>
                                <input type="number" step="0.0001" min="0" class="form-control" id="priceInput" required>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="alertTypeSelect" class="form-label">Alert Type</label>
                                <select class="form-select" id="alertTypeSelect" required>
                                    <option value="above">Above price</option>
                                    <option value="below">Below price</option>
                                </select>
                            </div>
                            <div class="col-md-2 mb-3 d-flex align-items-end">
                                <button type="submit" class="btn btn-warning w-100">Add Alert</button>
                            </div>
                        </div>
                    </form>
                    
                    <div class="alert alert-warning d-none" id="alertMessage" role="alert"></div>
                    
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th scope="col">Coin</th>
                                    <th scope="col">Target Price (USDT)</th>
                                    <th scope="col">Alert Type</th>
                                    <th scope="col">Status</th>
                                    <th scope="col">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="alertsTableBody">
                                <tr>
                                    <td colspan="5" class="text-center">Loading alerts...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <div class="card shadow-sm border-0">
                <div class="card-header bg-dark text-warning">
                    <h5 class="mb-0"><i class="fas fa-info-circle"></i> Usage Guide</h5>
                </div>
                <div class="card-body">
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item">To get notified when price increases, select the "Above price" alert type.</li>
                        <li class="list-group-item">To get notified when price decreases, select the "Below price" alert type.</li>
                        <li class="list-group-item">After an alert is triggered, it will only be reactivated when the price returns to an appropriate range.</li>
                        <li class="list-group-item">For example, after an "Above 60,000" alert is triggered, it will only be reactivated when the price drops below 59,400 and then rises above 60,000 again.</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Load existing price alerts
        loadPriceAlerts();
        
        // Add price alert form handling
        document.getElementById('price-alert-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const symbol = document.getElementById('symbolSelect').value;
            const price = parseFloat(document.getElementById('priceInput').value);
            const alertType = document.getElementById('alertTypeSelect').value;
            
            if (!symbol || isNaN(price) || price <= 0) {
                showAlert('Please fill in all fields correctly.', 'danger');
                return;
            }
            
            addPriceAlert(symbol, price, alertType);
        });
    });
    
    function loadPriceAlerts() {
        fetch('/api/price-alerts')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayPriceAlerts(data.alerts);
                } else {
                    showAlert('Error loading price alerts.', 'danger');
                }
            })
            .catch(error => {
                console.error('Error loading price alerts:', error);
                showAlert('Error loading price alerts: ' + error.message, 'danger');
            });
    }
    
    function displayPriceAlerts(alerts) {
        const tableBody = document.getElementById('alertsTableBody');
        tableBody.innerHTML = '';
        
        let alertCount = 0;
        
        // Display alerts for each coin
        for (const symbol in alerts) {
            const symbolAlerts = alerts[symbol];
            
            for (const alert of symbolAlerts) {
                alertCount++;
                
                const row = document.createElement('tr');
                
                // Row color based on alert status
                if (alert.triggered) {
                    row.className = 'table-warning';
                }
                
                // Coin symbol
                const symbolCell = document.createElement('td');
                symbolCell.textContent = symbol;
                row.appendChild(symbolCell);
                
                // Target price
                const priceCell = document.createElement('td');
                priceCell.textContent = formatPrice(alert.price);
                row.appendChild(priceCell);
                
                // Alert type
                const typeCell = document.createElement('td');
                typeCell.innerHTML = alert.type === 'above' ? 
                    '<span class="badge bg-success">Above</span>' : 
                    '<span class="badge bg-danger">Below</span>';
                row.appendChild(typeCell);
                
                // Status
                const statusCell = document.createElement('td');
                statusCell.innerHTML = alert.triggered ? 
                    '<span class="badge bg-warning text-dark">Triggered</span>' : 
                    '<span class="badge bg-secondary">Waiting</span>';
                row.appendChild(statusCell);
                
                // Actions
                const actionsCell = document.createElement('td');
                const deleteButton = document.createElement('button');
                deleteButton.className = 'btn btn-sm btn-danger';
                deleteButton.innerHTML = '<i class="fas fa-trash"></i> Delete';
                deleteButton.addEventListener('click', function() {
                    removePriceAlert(symbol, alert.price, alert.type);
                });
                actionsCell.appendChild(deleteButton);
                row.appendChild(actionsCell);
                
                tableBody.appendChild(row);
            }
        }
        
        // If no alerts exist
        if (alertCount === 0) {
            const row = document.createElement('tr');
            const cell = document.createElement('td');
            cell.colSpan = 5;
            cell.className = 'text-center';
            cell.textContent = 'No price alerts have been set.';
            row.appendChild(cell);
            tableBody.appendChild(row);
        }
    }
    
    function addPriceAlert(symbol, price, alertType) {
        const data = {
            symbol: symbol,
            price: price,
            type: alertType
        };
        
        fetch('/api/price-alerts/set', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert(data.message, 'success');
                    loadPriceAlerts(); // Reload alerts
                    // Clear form
                    document.getElementById('priceInput').value = '';
                } else {
                    showAlert(data.message, 'danger');
                }
            })
            .catch(error => {
                console.error('Error adding price alert:', error);
                showAlert('Error adding price alert: ' + error.message, 'danger');
            });
    }
    
    function removePriceAlert(symbol, price, alertType) {
        if (!confirm('Are you sure you want to delete this price alert?')) {
            return;
        }
        
        const data = {
            symbol: symbol,
            price: price,
            type: alertType
        };
        
        fetch('/api/price-alerts/remove', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert(data.message, 'success');
                    loadPriceAlerts(); // Reload alerts
                } else {
                    showAlert(data.message, 'danger');
                }
            })
            .catch(error => {
                console.error('Error removing price alert:', error);
                showAlert('Error removing price alert: ' + error.message, 'danger');
            });
    }
    
    function showAlert(message, type) {
        const alertElement = document.getElementById('alertMessage');
        alertElement.textContent = message;
        alertElement.className = `alert alert-${type}`;
        alertElement.classList.remove('d-none');
        
        // Hide message after 5 seconds
        setTimeout(() => {
            alertElement.classList.add('d-none');
        }, 5000);
    }
    
    function formatPrice(price) {
        if (price >= 1000) {
            return price.toLocaleString('en-US', {maximumFractionDigits: 0});
        } else if (price >= 1) {
            return price.toLocaleString('en-US', {maximumFractionDigits: 2});
        } else {
            return price.toLocaleString('en-US', {maximumFractionDigits: 6});
        }
    }
</script>
{% endblock %}