{% extends 'minimal_base.html' %}

{% block title %}هشدارهای قیمت - کریپتو برزین{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-header bg-dark text-warning">
                    <h5 class="mb-0"><i class="fas fa-bell"></i> هشدارهای قیمت</h5>
                </div>
                <div class="card-body">
                    <p>با تنظیم هشدارهای قیمت، هنگامی که قیمت ارز مورد نظر به محدوده مشخص شده برسد، به شما از طریق تلگرام اطلاع‌رسانی می‌شود.</p>
                    
                    <form id="price-alert-form" class="mb-4">
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="symbolSelect" class="form-label">ارز دیجیتال</label>
                                <select class="form-select" id="symbolSelect" required>
                                    <option value="" selected disabled>انتخاب ارز...</option>
                                    <option value="BTC/USDT">بیت‌کوین (BTC)</option>
                                    <option value="ETH/USDT">اتریوم (ETH)</option>
                                    <option value="BNB/USDT">بایننس کوین (BNB)</option>
                                    <option value="SOL/USDT">سولانا (SOL)</option>
                                    <option value="XRP/USDT">ریپل (XRP)</option>
                                    <option value="ADA/USDT">کاردانو (ADA)</option>
                                    <option value="DOGE/USDT">دوج‌کوین (DOGE)</option>
                                </select>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="priceInput" class="form-label">قیمت (USDT)</label>
                                <input type="number" step="0.0001" min="0" class="form-control" id="priceInput" required>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="alertTypeSelect" class="form-label">نوع هشدار</label>
                                <select class="form-select" id="alertTypeSelect" required>
                                    <option value="above">بالاتر از قیمت</option>
                                    <option value="below">پایین‌تر از قیمت</option>
                                </select>
                            </div>
                            <div class="col-md-2 mb-3 d-flex align-items-end">
                                <button type="submit" class="btn btn-warning w-100">افزودن هشدار</button>
                            </div>
                        </div>
                    </form>
                    
                    <div class="alert alert-warning d-none" id="alertMessage" role="alert"></div>
                    
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th scope="col">ارز</th>
                                    <th scope="col">قیمت هدف (USDT)</th>
                                    <th scope="col">نوع هشدار</th>
                                    <th scope="col">وضعیت</th>
                                    <th scope="col">عملیات</th>
                                </tr>
                            </thead>
                            <tbody id="alertsTableBody">
                                <tr>
                                    <td colspan="5" class="text-center">در حال بارگذاری هشدارها...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <div class="card shadow-sm border-0">
                <div class="card-header bg-dark text-warning">
                    <h5 class="mb-0"><i class="fas fa-info-circle"></i> راهنمای استفاده</h5>
                </div>
                <div class="card-body">
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item">برای دریافت هشدار در صورت افزایش قیمت، نوع هشدار را «بالاتر از قیمت» انتخاب کنید.</li>
                        <li class="list-group-item">برای دریافت هشدار در صورت کاهش قیمت، نوع هشدار را «پایین‌تر از قیمت» انتخاب کنید.</li>
                        <li class="list-group-item">هر هشدار پس از فعال شدن، تنها زمانی دوباره فعال می‌شود که قیمت به محدوده مناسب بازگردد.</li>
                        <li class="list-group-item">برای مثال، هشدار «بالاتر از ۶۰,۰۰۰» پس از فعال شدن، تنها وقتی دوباره فعال می‌شود که قیمت به زیر ۵۹,۴۰۰ برسد و سپس دوباره به بالای ۶۰,۰۰۰ برگردد.</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // بارگذاری هشدارهای قیمت موجود
        loadPriceAlerts();
        
        // فرم افزودن هشدار قیمت
        document.getElementById('price-alert-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const symbol = document.getElementById('symbolSelect').value;
            const price = parseFloat(document.getElementById('priceInput').value);
            const alertType = document.getElementById('alertTypeSelect').value;
            
            if (!symbol || isNaN(price) || price <= 0) {
                showAlert('لطفاً همه فیلدها را به درستی پر کنید.', 'danger');
                return;
            }
            
            addPriceAlert(symbol, price, alertType);
        });
    });
    
    function loadPriceAlerts() {
        fetch('/api/price-alerts')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayPriceAlerts(data.alerts);
                } else {
                    showAlert('خطا در بارگذاری هشدارهای قیمت.', 'danger');
                }
            })
            .catch(error => {
                console.error('Error loading price alerts:', error);
                showAlert('خطا در بارگذاری هشدارهای قیمت: ' + error.message, 'danger');
            });
    }
    
    function displayPriceAlerts(alerts) {
        const tableBody = document.getElementById('alertsTableBody');
        tableBody.innerHTML = '';
        
        let alertCount = 0;
        
        // برای هر ارز، هشدارهای آن را نمایش می‌دهیم
        for (const symbol in alerts) {
            const symbolAlerts = alerts[symbol];
            
            for (const alert of symbolAlerts) {
                alertCount++;
                
                const row = document.createElement('tr');
                
                // رنگ‌بندی سطر بر اساس نوع هشدار
                if (alert.triggered) {
                    row.className = 'table-warning';
                }
                
                // ارز
                const symbolCell = document.createElement('td');
                symbolCell.textContent = symbol;
                row.appendChild(symbolCell);
                
                // قیمت هدف
                const priceCell = document.createElement('td');
                priceCell.textContent = formatPrice(alert.price);
                row.appendChild(priceCell);
                
                // نوع هشدار
                const typeCell = document.createElement('td');
                typeCell.innerHTML = alert.type === 'above' ? 
                    '<span class="badge bg-success">بالاتر از</span>' : 
                    '<span class="badge bg-danger">پایین‌تر از</span>';
                row.appendChild(typeCell);
                
                // وضعیت
                const statusCell = document.createElement('td');
                statusCell.innerHTML = alert.triggered ? 
                    '<span class="badge bg-warning text-dark">فعال شده</span>' : 
                    '<span class="badge bg-secondary">منتظر</span>';
                row.appendChild(statusCell);
                
                // عملیات
                const actionsCell = document.createElement('td');
                const deleteButton = document.createElement('button');
                deleteButton.className = 'btn btn-sm btn-danger';
                deleteButton.innerHTML = '<i class="fas fa-trash"></i> حذف';
                deleteButton.addEventListener('click', function() {
                    removePriceAlert(symbol, alert.price, alert.type);
                });
                actionsCell.appendChild(deleteButton);
                row.appendChild(actionsCell);
                
                tableBody.appendChild(row);
            }
        }
        
        // اگر هیچ هشداری نباشد
        if (alertCount === 0) {
            const row = document.createElement('tr');
            const cell = document.createElement('td');
            cell.colSpan = 5;
            cell.className = 'text-center';
            cell.textContent = 'هیچ هشدار قیمتی تنظیم نشده است.';
            row.appendChild(cell);
            tableBody.appendChild(row);
        }
    }
    
    function addPriceAlert(symbol, price, alertType) {
        const data = {
            symbol: symbol,
            price: price,
            type: alertType
        };
        
        fetch('/api/price-alerts/set', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert(data.message, 'success');
                    loadPriceAlerts(); // بارگذاری مجدد هشدارها
                    // پاک کردن فرم
                    document.getElementById('priceInput').value = '';
                } else {
                    showAlert(data.message, 'danger');
                }
            })
            .catch(error => {
                console.error('Error adding price alert:', error);
                showAlert('خطا در افزودن هشدار قیمت: ' + error.message, 'danger');
            });
    }
    
    function removePriceAlert(symbol, price, alertType) {
        if (!confirm('آیا از حذف این هشدار قیمت اطمینان دارید؟')) {
            return;
        }
        
        const data = {
            symbol: symbol,
            price: price,
            type: alertType
        };
        
        fetch('/api/price-alerts/remove', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert(data.message, 'success');
                    loadPriceAlerts(); // بارگذاری مجدد هشدارها
                } else {
                    showAlert(data.message, 'danger');
                }
            })
            .catch(error => {
                console.error('Error removing price alert:', error);
                showAlert('خطا در حذف هشدار قیمت: ' + error.message, 'danger');
            });
    }
    
    function showAlert(message, type) {
        const alertElement = document.getElementById('alertMessage');
        alertElement.textContent = message;
        alertElement.className = `alert alert-${type}`;
        alertElement.classList.remove('d-none');
        
        // پنهان کردن پیام پس از 5 ثانیه
        setTimeout(() => {
            alertElement.classList.add('d-none');
        }, 5000);
    }
    
    function formatPrice(price) {
        if (price >= 1000) {
            return price.toLocaleString('en-US', {maximumFractionDigits: 0});
        } else if (price >= 1) {
            return price.toLocaleString('en-US', {maximumFractionDigits: 2});
        } else {
            return price.toLocaleString('en-US', {maximumFractionDigits: 6});
        }
    }
</script>
{% endblock %}