{% extends "minimal_base.html" %}

{% block title %}{{ ui_text('dashboard', 'داشبورد') }} | {{ ui_text('title', 'برزین کریپتو') }}{% endblock %}

{% block head %}
{{ super() }}
<script src="{{ url_for('static', filename='js/cryptocurrency-updates.js') }}"></script>
<script src="{{ url_for('static', filename='js/vercel-realtime.js') }}"></script>
<script>
// اسکریپت مستقیم برای به‌روزرسانی قیمت‌ها با استفاده از درخواست‌های API مستقیم
document.addEventListener('DOMContentLoaded', function() {
    console.log("Directly updating special coins from HTML...");
    
    // آرایه‌های سکه‌های مختلف
    const memeCoins = ['DOGE', 'SHIB', 'PEPE', 'FLOKI', 'WIF', 'MEME'];
    const aiCoins = ['RNDR', 'FET', 'OCEAN', 'AGIX'];
    const lowCostCoins = ['VET', 'XDC', 'HBAR', 'XLM', 'JASMY'];
    
    // تابع قالب‌بندی قیمت بر اساس بزرگی اعداد
    function formatDirectPrice(price) {
        price = parseFloat(price);
        if (price >= 1000) {
            return price.toLocaleString('en-US', {maximumFractionDigits: 0});
        } else if (price >= 1) {
            return price.toLocaleString('en-US', {maximumFractionDigits: 2});
        } else if (price >= 0.01) {
            return price.toLocaleString('en-US', {maximumFractionDigits: 4});
        } else {
            return price.toLocaleString('en-US', {maximumFractionDigits: 8});
        }
    }
    
    // تابع به‌روزرسانی قیمت هر سکه
    function updateDirectCoin(coin) {
        console.log(`Directly fetching ${coin} price...`);
        
        fetch(`/api/price/${coin.toLowerCase()}`)
            .then(response => response.json())
            .then(data => {
                console.log(`Direct API response for ${coin}:`, data);
                if (data.success && data.data && data.data.price) {
                    const price = parseFloat(data.data.price);
                    
                    // آپدیت قیمت
                    const priceElement = document.getElementById(`${coin}-USDT-price`);
                    if (priceElement) {
                        priceElement.textContent = formatDirectPrice(price);
                        console.log(`Successfully updated ${coin} price element to ${price}`);
                    }
                    
                    // آپدیت درصد تغییرات
                    const changeElement = document.getElementById(`${coin}-USDT-change`);
                    if (changeElement && data.data.change_24h) {
                        const change = parseFloat(data.data.change_24h);
                        const sign = change >= 0 ? '+' : '';
                        changeElement.textContent = `${sign}${change.toFixed(2)}%`;
                        
                        if (change >= 0) {
                            changeElement.classList.add('positive-change');
                            changeElement.classList.remove('negative-change');
                        } else {
                            changeElement.classList.add('negative-change');
                            changeElement.classList.remove('positive-change');
                        }
                    }
                }
            })
            .catch(error => console.error(`Error fetching ${coin}:`, error));
    }
    
    // به‌روزرسانی همه سکه‌ها با تاخیر
    function updateAllCoins() {
        const allCoins = [...memeCoins, ...aiCoins, ...lowCostCoins];
        
        // به‌روزرسانی هر سکه با تاخیر 500 میلی‌ثانیه
        allCoins.forEach((coin, index) => {
            setTimeout(() => {
                updateDirectCoin(coin);
            }, index * 500);
        });
    }
    
    // اجرای اولیه
    updateAllCoins();
    
    // به‌روزرسانی هر 60 ثانیه
    setInterval(updateAllCoins, 60000);
});
</script>
{% endblock %}

{% block content %}

<div id="dashboard-content">
    <div class="row mb-5">
        <div class="col-12 text-center py-5">
            <div class="mt-4 mb-5">
                <img src="{{ url_for('static', filename='images/crypto/bitcoin-coins.png') }}" alt="Bitcoin Coins" style="max-width: 100%; height: auto; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3);" class="mb-4">
            </div>
        </div>
    </div>
    
    <!-- Real-time Status and Controls -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <h4 class="mb-0 me-3">{{ ui_text('popular', 'Popular') }}</h4>
                    <div class="connection-status" id="connectionStatus">
                        <i class="fas fa-circle text-warning me-1"></i>در حال اتصال...
                    </div>
                </div>
                <div class="d-flex align-items-center">
                    <button class="btn btn-sm btn-outline-primary me-2" id="refreshBtn">
                        <i class="fas fa-sync-alt me-1"></i>به‌روزرسانی
                    </button>
                    <button class="btn btn-sm btn-success me-2" id="assistantToggle">
                        <i class="fas fa-robot me-1"></i>دستیار هوشمند
                    </button>
                    <a href="/cryptocurrencies" class="text-decoration-none text-muted">{{ ui_text('see_listing', 'View All') }}</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Crypto Price Cards (Binance Style) -->
    <div class="row mb-5" id="price-section">
        <!-- Main Coins - Table Format like Binance -->
        <div class="col-lg-12">
            <div class="table-responsive">
                <table class="table table-dark table-hover">
                    <thead>
                        <tr>
                            <th scope="col">{{ ui_text('name', 'Name') }}</th>
                            <th scope="col">{{ ui_text('last_price', 'Last Price') }}</th>
                            <th scope="col">{{ ui_text('24h_change', '24h Change') }}</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="icon-circle me-2">
                                        <i class="fab fa-bitcoin text-warning"></i>
                                    </div>
                                    <div>
                                        <h6 class="mb-0">{{ ui_text('bitcoin', 'Bitcoin') }}</h6>
                                        <small class="text-muted">BTC/USDT</small>
                                    </div>
                                </div>
                            </td>
                            <td><h6 class="mb-0" id="BTC-USDT-price">--</h6></td>
                            <td><h6 class="mb-0" id="BTC-USDT-change">--</h6></td>
                        </tr>
                        <tr>
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="icon-circle me-2">
                                        <i class="fab fa-ethereum text-primary"></i>
                                    </div>
                                    <div>
                                        <h6 class="mb-0">{{ ui_text('ethereum', 'Ethereum') }}</h6>
                                        <small class="text-muted">ETH/USDT</small>
                                    </div>
                                </div>
                            </td>
                            <td><h6 class="mb-0" id="ETH-USDT-price">--</h6></td>
                            <td><h6 class="mb-0" id="ETH-USDT-change">--</h6></td>
                        </tr>
                        <tr>
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="icon-circle me-2">
                                        <i class="fas fa-sun text-success"></i>
                                    </div>
                                    <div>
                                        <h6 class="mb-0">{{ ui_text('coins.sol', 'Solana') }}</h6>
                                        <small class="text-muted">SOL/USDT</small>
                                    </div>
                                </div>
                            </td>
                            <td><h6 class="mb-0" id="SOL-USDT-price">--</h6></td>
                            <td><h6 class="mb-0" id="SOL-USDT-change">--</h6></td>
                        </tr>
                        <tr>
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="icon-circle me-2">
                                        <i class="fas fa-chart-line text-info"></i>
                                    </div>
                                    <div>
                                        <h6 class="mb-0">{{ ui_text('ripple', 'Ripple') }}</h6>
                                        <small class="text-muted">XRP/USDT</small>
                                    </div>
                                </div>
                            </td>
                            <td><h6 class="mb-0" id="XRP-USDT-price">--</h6></td>
                            <td><h6 class="mb-0" id="XRP-USDT-change">--</h6></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Section for Meme Coins removed at user's request -->
    
    <!-- Section for AI Coins removed at user's request -->
    
    <!-- Section for Low-Cost Growth Coins removed at user's request -->

    <!-- Crypto Quiz Section -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="mb-0">{{ ui_text('crypto_quiz', 'Cryptocurrency Quiz') }}</h4>
                <a href="/crypto-quiz" class="text-decoration-none text-muted">{{ ui_text('view_all_quizzes', 'View All') }}</a>
            </div>
            <div class="card crypto-card">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <h5 class="card-title">{{ ui_text('test_your_knowledge', 'Test Your Knowledge') }}</h5>
                            <p class="card-text">{{ ui_text('quiz_description', 'Enhance your cryptocurrency knowledge by taking our interactive quiz. Earn points, unlock badges, and climb the leaderboard!') }}</p>
                            <div class="mt-3">
                                <a href="/crypto-quiz" class="btn btn-warning">
                                    <i class="fas fa-graduation-cap me-2"></i>{{ ui_text('start_quiz', 'Start Quiz') }}
                                </a>
                            </div>
                        </div>
                        <div class="col-md-4 text-center">
                            <div class="quiz-icon">
                                <i class="fas fa-trophy fa-5x text-warning"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Binance Style Section Switcher -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="d-flex border-bottom border-secondary mb-3">
                <button class="btn btn-link text-decoration-none px-3 py-2 active text-warning border-bottom border-warning" id="technical-btn" onclick="switchSection('technical')">
                    <i class="fas fa-chart-bar me-1"></i> {{ ui_text('technical_analysis', 'Technical Analysis') }}
                </button>
                <button class="btn btn-link text-decoration-none px-3 py-2 text-muted" id="signals-btn" onclick="switchSection('signals')">
                    <i class="fas fa-signal me-1"></i> {{ ui_text('trading_signals', 'Trading Signals') }}
                </button>
                <button class="btn btn-link text-decoration-none px-3 py-2 text-muted" id="news-btn" onclick="switchSection('news')">
                    <i class="fas fa-newspaper me-1"></i> {{ ui_text('news', 'News') }}
                </button>
            </div>
        </div>
    </div>
            
    <!-- مدیریت نمایش بخش‌های ارزهای دیجیتال - بخش‌ها به شکل استاتیک تعریف شده‌اند -->
    <!-- Meme coins section removed as requested -->
    
    <!-- Section for AI Coins removed at user's request -->
    
    <!-- Low-cost growth coins section removed as requested -->
    
    <!-- تابع قالب‌بندی قیمت و تغییرات -->
    <script>
        function formatPrice(price) {
            // قالب‌بندی بر اساس بزرگی قیمت
            if (price >= 1000) {
                return price.toLocaleString('en-US', {maximumFractionDigits: 0});
            } else if (price >= 1) {
                return price.toLocaleString('en-US', {maximumFractionDigits: 2});
            } else if (price >= 0.01) {
                return price.toLocaleString('en-US', {maximumFractionDigits: 4});
            } else {
                return price.toLocaleString('en-US', {maximumFractionDigits: 8});
            }
        }
        
        function formatChange(change) {
            const sign = change >= 0 ? '+' : '';
            return `${sign}${change.toFixed(2)}%`;
        }
        
        // AI coins functions removed as requested
        
        // Binance Style Tab Switching
        function switchSection(sectionName) {
            // Hide all sections
            document.querySelectorAll('.tab-pane').forEach(pane => {
                pane.style.display = 'none';
            });
            
            // Remove active class from all buttons
            document.querySelectorAll('.btn-link').forEach(btn => {
                btn.classList.remove('active', 'text-warning', 'border-bottom', 'border-warning');
                btn.classList.add('text-muted');
            });
            
            // Show selected section
            const selectedPane = document.getElementById(sectionName + '-pane');
            if (selectedPane) {
                selectedPane.style.display = 'block';
            }
            
            // Set active class to selected button
            const selectedBtn = document.getElementById(sectionName + '-btn');
            if (selectedBtn) {
                selectedBtn.classList.remove('text-muted');
                selectedBtn.classList.add('active', 'text-warning', 'border-bottom', 'border-warning');
            }
        }
    </script>
    
    <!-- Section Content Container -->
    <div class="sections-container">
                <!-- Technical Analysis Tab -->
                <div class="tab-pane active" id="technical-pane" role="tabpanel" aria-labelledby="technical-tab">
                    <div class="card crypto-card">
                        <div class="card-header d-flex justify-content-between align-items-center border-0 bg-transparent">
                            <h5 class="mb-0">{{ ui_text('technical_analysis_bitcoin', 'Bitcoin Technical Analysis (Hourly Timeframe)') }}</h5>
                            <div class="binance-tabs">
                                <a href="#" class="binance-tab-item active">BTC</a>
                                <a href="#" class="binance-tab-item">ETH</a>
                                <a href="#" class="binance-tab-item">SOL</a>
                                <a href="#" class="binance-tab-item">XRP</a>
                            </div>
                        </div>
                        <div class="card-body">
                            <!-- Loading Spinner -->
                            <div id="technical-loading" class="text-center py-5">
                                <span class="loader"></span>
                                <p class="mt-3 text-muted">{{ ui_text('loading_technical_analysis', 'Loading technical analysis...') }}</p>
                            </div>
                            
                            <!-- Technical Analysis Content -->
                            <div id="technical-content" style="display: none;">
                                <!-- Chart Container -->
                                <div class="chart-container mb-4">
                                    <canvas id="priceChart"></canvas>
                                </div>
                                
                                <div class="row">
                                    <div class="col-lg-6">
                                        <div class="card mb-3 stat-card">
                                            <div class="card-body">
                                                <h5 class="card-title mb-3">Technical Indicators</h5>
                                                <div class="table-responsive">
                                                    <table class="table table-sm">
                                                        <tbody>
                                                            <tr>
                                                                <td><strong>RSI</strong> <small class="text-muted">(14)</small></td>
                                                                <td><span id="rsi-value">--</span></td>
                                                            </tr>
                                                            <tr>
                                                                <td><strong>MACD</strong></td>
                                                                <td><span id="macd-value">--</span></td>
                                                            </tr>
                                                            <tr>
                                                                <td><strong>Moving Average</strong></td>
                                                                <td><span id="ma-value">--</span></td>
                                                            </tr>
                                                            <tr class="table-active">
                                                                <td><strong>Overall Signal</strong></td>
                                                                <td><strong id="overall-signal">--</strong></td>
                                                            </tr>
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-lg-6">
                                        <div class="card mb-3 stat-card">
                                            <div class="card-body">
                                                <h5 class="card-title mb-3">Support & Resistance Levels</h5>
                                                <div class="table-responsive">
                                                    <table class="table table-sm">
                                                        <tbody>
                                                            <tr>
                                                                <td><strong>Resistance 2</strong></td>
                                                                <td>68,500</td>
                                                            </tr>
                                                            <tr>
                                                                <td><strong>Resistance 1</strong></td>
                                                                <td>66,800</td>
                                                            </tr>
                                                            <tr class="table-active">
                                                                <td><strong>Current Price</strong></td>
                                                                <td>65,120</td>
                                                            </tr>
                                                            <tr>
                                                                <td><strong>Support 1</strong></td>
                                                                <td>64,500</td>
                                                            </tr>
                                                            <tr>
                                                                <td><strong>Support 2</strong></td>
                                                                <td>63,200</td>
                                                            </tr>
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="card mb-3 stat-card">
                                    <div class="card-body">
                                        <h5 class="card-title mb-3">Analysis Commentary</h5>
                                        <p>Bitcoin is currently in an uptrend. The RSI indicator suggests overbought conditions, but MACD continues to show a bullish signal. Moving averages provide solid support at the $64,500 level.</p>
                                        <p>It is recommended that traders wait for more confirmation signals or wait for a correction toward support levels.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Trading Signals Tab -->
                <div class="tab-pane" id="signals-pane" role="tabpanel" aria-labelledby="signals-tab" style="display: none;">
                    <!-- Loading Spinner -->
                    <div id="signals-loading" style="display: none;" class="text-center py-5">
                        <span class="loader"></span>
                        <p class="mt-3 text-muted">{{ ui_text('loading_trading_signals', 'Loading trading signals...') }}</p>
                    </div>
                    
                    <!-- Signals Container -->
                    <div id="signals-container" class="row">
                        <!-- BTC Signal Card -->
                        <div class="col-md-6 mb-4">
                            <div class="card crypto-card h-100">
                                <div class="card-header">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div class="d-flex align-items-center">
                                            <div class="icon-circle me-2">
                                                <i class="fab fa-bitcoin text-warning"></i>
                                            </div>
                                            <h5 class="mb-0">{{ ui_text('bitcoin', 'Bitcoin') }} (BTC/USDT)</h5>
                                        </div>
                                        <span class="badge bg-success">{{ ui_text('buy', 'خرید') }}</span>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <div class="d-flex justify-content-between mb-1">
                                            <span class="text-muted">{{ ui_text('current_price', 'قیمت فعلی') }}:</span>
                                            <span id="btc-signal-price" class="fw-bold">۶۵,۱۲۰ USDT</span>
                                        </div>
                                        <div class="d-flex justify-content-between mb-1">
                                            <span class="text-muted">{{ ui_text('suggested_volume', 'حجم پیشنهادی') }}:</span>
                                            <span class="fw-bold">۰.۵ BTC</span>
                                        </div>
                                        <div class="d-flex justify-content-between mb-1">
                                            <span class="text-muted">{{ ui_text('take_profit', 'حد سود') }}:</span>
                                            <span class="text-success">۶۸,۵۰۰ USDT (+۵.۲٪)</span>
                                        </div>
                                        <div class="d-flex justify-content-between">
                                            <span class="text-muted">{{ ui_text('stop_loss', 'حد ضرر') }}:</span>
                                            <span class="text-danger">۶۲,۸۰۰ USDT (-۳.۶٪)</span>
                                        </div>
                                    </div>
                                    <p class="signal-description">
                                        {{ ui_text('btc_buy_signal', 'Bitcoin has recently completed a bullish triangle pattern and appears ready to continue its upward trend. The RSI indicator is in the neutral zone and MACD shows a buy signal.') }}
                                    </p>
                                    <div class="text-center mt-3">
                                        <button class="btn btn-sm btn-outline-warning me-2">{{ ui_text("share", "اشتراک‌گذاری") }} <i class="fas fa-share-alt ms-1"></i></button>
                                        <button class="btn btn-sm btn-primary me-2">{{ ui_text("buy", "خرید") }} <i class="fas fa-arrow-right ms-1"></i></button>
                                        <button class="btn btn-sm btn-info ai-advice-btn" data-symbol="BTC-USDT">
                                            <i class="fas fa-robot me-1"></i>مشاوره هوشمند
                                        </button>
                                    </div>
                                </div>
                                <div class="card-footer text-muted">
                                    <small>ایجاد شده: امروز ۱۵:۴۵ | اعتبار: ۲۴ ساعت</small>
                                </div>
                            </div>
                        </div>
                        
                        <!-- ETH Signal Card -->
                        <div class="col-md-6 mb-4">
                            <div class="card crypto-card h-100">
                                <div class="card-header">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div class="d-flex align-items-center">
                                            <div class="icon-circle me-2">
                                                <i class="fab fa-ethereum text-primary"></i>
                                            </div>
                                            <h5 class="mb-0">{{ ui_text('ethereum', 'Ethereum') }} (ETH/USDT)</h5>
                                        </div>
                                        <span class="badge bg-danger">{{ ui_text('sell', 'فروش') }}</span>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <div class="d-flex justify-content-between mb-1">
                                            <span class="text-muted">{{ ui_text('current_price', 'قیمت فعلی') }}:</span>
                                            <span id="eth-signal-price" class="fw-bold">۳,۴۵۰ USDT</span>
                                        </div>
                                        <div class="d-flex justify-content-between mb-1">
                                            <span class="text-muted">{{ ui_text('suggested_volume', 'حجم پیشنهادی') }}:</span>
                                            <span class="fw-bold">۲ ETH</span>
                                        </div>
                                        <div class="d-flex justify-content-between mb-1">
                                            <span class="text-muted">{{ ui_text('take_profit', 'حد سود') }}:</span>
                                            <span class="text-success">۳,۲۳۰ USDT (+۶.۴٪)</span>
                                        </div>
                                        <div class="d-flex justify-content-between">
                                            <span class="text-muted">{{ ui_text('stop_loss', 'حد ضرر') }}:</span>
                                            <span class="text-danger">۳,۵۸۰ USDT (-۳.۸٪)</span>
                                        </div>
                                    </div>
                                    <p class="signal-description">
                                        {{ ui_text('eth_sell_signal', 'Ethereum is positioned near a key resistance level and technical indicators show overbought conditions. RSI is above 70 and a negative divergence pattern is observed with MACD. A price correction is likely.') }}
                                    </p>
                                    <div class="text-center mt-3">
                                        <button class="btn btn-sm btn-outline-warning me-2">{{ ui_text("share", "اشتراک‌گذاری") }} <i class="fas fa-share-alt ms-1"></i></button>
                                        <button class="btn btn-sm btn-danger me-2">{{ ui_text("sell", "فروش") }} <i class="fas fa-arrow-left ms-1"></i></button>
                                        <button class="btn btn-sm btn-info ai-advice-btn" data-symbol="ETH-USDT">
                                            <i class="fas fa-robot me-1"></i>مشاوره هوشمند
                                        </button>
                                    </div>
                                </div>
                                <div class="card-footer text-muted">
                                    <small>{{ ui_text('signal_validity', 'ایجاد شده: امروز {time} | اعتبار: {hours} ساعت').format(time='۱۶:۳۰', hours='۱۲') }}</small>
                                </div>
                            </div>
                        </div>
                        
                        <!-- SOL Signal Card -->
                        <div class="col-md-6 mb-4">
                            <div class="card crypto-card h-100">
                                <div class="card-header">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div class="d-flex align-items-center">
                                            <div class="icon-circle me-2">
                                                <i class="fas fa-sun text-info"></i>
                                            </div>
                                            <h5 class="mb-0">{{ ui_text('solana', 'Solana') }} (SOL/USDT)</h5>
                                        </div>
                                        <span class="badge bg-success">{{ ui_text('buy', 'خرید') }}</span>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <div class="d-flex justify-content-between mb-1">
                                            <span class="text-muted">{{ ui_text('current_price', 'قیمت فعلی') }}:</span>
                                            <span class="fw-bold">۱۵۲ USDT</span>
                                        </div>
                                        <div class="d-flex justify-content-between mb-1">
                                            <span class="text-muted">{{ ui_text('suggested_volume', 'حجم پیشنهادی') }}:</span>
                                            <span class="fw-bold">۱۰ SOL</span>
                                        </div>
                                        <div class="d-flex justify-content-between mb-1">
                                            <span class="text-muted">{{ ui_text('take_profit', 'حد سود') }}:</span>
                                            <span class="text-success">۱۷۵ USDT (+۱۵.۱٪)</span>
                                        </div>
                                        <div class="d-flex justify-content-between">
                                            <span class="text-muted">{{ ui_text('stop_loss', 'حد ضرر') }}:</span>
                                            <span class="text-danger">۱۳۹ USDT (-۸.۶٪)</span>
                                        </div>
                                    </div>
                                    <p class="signal-description">
                                        {{ ui_text('sol_buy_signal', 'Solana is breaking a key resistance pattern and moving with high trading volume. Moving averages show strong support with significant growth potential.') }}
                                    </p>
                                    <div class="text-center mt-3">
                                        <button class="btn btn-sm btn-outline-warning me-2">{{ ui_text("share", "اشتراک‌گذاری") }} <i class="fas fa-share-alt ms-1"></i></button>
                                        <button class="btn btn-sm btn-primary me-2">{{ ui_text("buy", "خرید") }} <i class="fas fa-arrow-right ms-1"></i></button>
                                        <button class="btn btn-sm btn-info ai-advice-btn" data-symbol="SOL-USDT">
                                            <i class="fas fa-robot me-1"></i>مشاوره هوشمند
                                        </button>
                                    </div>
                                </div>
                                <div class="card-footer text-muted">
                                    <small>{{ ui_text('signal_validity', 'ایجاد شده: امروز {time} | اعتبار: {hours} ساعت').format(time='۱۴:۲۰', hours='۴۸') }}</small>
                                </div>
                            </div>
                        </div>
                        
                        <!-- BNB Signal Card -->
                        <div class="col-md-6 mb-4">
                            <div class="card crypto-card h-100">
                                <div class="card-header">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div class="d-flex align-items-center">
                                            <div class="icon-circle me-2">
                                                <i class="fas fa-coins text-warning"></i>
                                            </div>
                                            <h5 class="mb-0">{{ ui_text('binance_coin', 'Binance Coin') }} (BNB/USDT)</h5>
                                        </div>
                                        <span class="badge bg-warning">{{ ui_text('wait', 'انتظار') }}</span>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <div class="d-flex justify-content-between mb-1">
                                            <span class="text-muted">{{ ui_text('current_price', 'قیمت فعلی') }}:</span>
                                            <span class="fw-bold">۵۶۰ USDT</span>
                                        </div>
                                        <div class="d-flex justify-content-between mb-1">
                                            <span class="text-muted">{{ ui_text('monitoring_level', 'سطح نظارت') }}:</span>
                                            <span class="fw-bold">۵۸۰ USDT</span>
                                        </div>
                                        <div class="d-flex justify-content-between mb-1">
                                            <span class="text-muted">{{ ui_text('price_target_bullish', 'هدف قیمتی (صعودی)') }}:</span>
                                            <span class="text-success">۶۱۵ USDT</span>
                                        </div>
                                        <div class="d-flex justify-content-between">
                                            <span class="text-muted">{{ ui_text('price_target_bearish', 'هدف قیمتی (نزولی)') }}:</span>
                                            <span class="text-danger">۵۲۰ USDT</span>
                                        </div>
                                    </div>
                                    <p class="signal-description">
                                        {{ ui_text('bnb_wait_signal', 'Binance Coin is trading in a narrow price range. If the resistance level at $580 breaks, a buy signal will be activated. It is recommended not to trade until this level breaks.') }}
                                    </p>
                                    <div class="text-center mt-3">
                                        <button class="btn btn-sm btn-outline-warning me-2">{{ ui_text("share", "اشتراک‌گذاری") }} <i class="fas fa-share-alt ms-1"></i></button>
                                        <button class="btn btn-sm btn-secondary me-2">{{ ui_text("set_alert", "تنظیم هشدار") }} <i class="fas fa-bell ms-1"></i></button>
                                        <button class="btn btn-sm btn-info ai-advice-btn" data-symbol="BNB-USDT">
                                            <i class="fas fa-robot me-1"></i>مشاوره هوشمند
                                        </button>
                                    </div>
                                </div>
                                <div class="card-footer text-muted">
                                    <small>{{ ui_text('signal_validity', 'ایجاد شده: امروز {time} | اعتبار: {hours} ساعت').format(time='۱۷:۱۰', hours='۲۴') }}</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- News Tab -->
                <div class="tab-pane" id="news-pane" role="tabpanel" aria-labelledby="news-tab" style="display: none;">
                    <!-- Loading Spinner -->
                    <div id="news-loading" class="text-center py-5">
                        <span class="loader"></span>
                        <p class="mt-3 text-muted">{{ ui_text('loading_news', 'Loading news...') }}</p>
                    </div>
                    
                    <!-- News Container -->
                    <div id="news-container"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // توجه: عملیات به‌روزرسانی قیمت ارزها به فایل مستقل cryptocurrency-updates.js منتقل شده است
    
        // تابع تغییر بخش
        window.switchSection = function(sectionName) {
            console.log('Switching to section:', sectionName);
            
            // غیرفعال کردن همه دکمه‌ها
            document.querySelectorAll('.btn').forEach(btn => {
                if (btn.id.includes('-btn')) {
                    btn.classList.remove('btn-primary');
                    btn.classList.remove('active');
                    btn.classList.add('btn-outline-primary');
                }
            });
            
            // فعال کردن دکمه انتخاب شده
            const activeBtn = document.getElementById(sectionName + '-btn');
            if (activeBtn) {
                activeBtn.classList.remove('btn-outline-primary');
                activeBtn.classList.add('btn-primary');
                activeBtn.classList.add('active');
            }
            
            // مخفی کردن همه بخش‌ها
            document.querySelectorAll('.tab-pane').forEach(section => {
                section.style.display = 'none';
            });
            
            // نمایش بخش مورد نظر
            const targetPane = document.getElementById(sectionName + '-pane');
            if (targetPane) {
                targetPane.style.display = 'block';
                
                // به‌روزرسانی قیمت‌ها در بخش سیگنال‌ها
                if (sectionName === 'signals') {
                    updateSignalPrices();
                }
            }
        };
        
        // به‌روزرسانی قیمت‌های واقعی در کارت‌های سیگنال
        function updateSignalPrices() {
            try {
                console.log('Updating signal prices');
                
                // دریافت قیمت بیت‌کوین با استفاده از ID استاندارد جدید
                const btcPrice = document.getElementById('BTC-USDT-price')?.textContent;
                if (btcPrice && btcPrice !== '--') {
                    const btcSignalPrice = document.getElementById('btc-signal-price');
                    if (btcSignalPrice) {
                        console.log('Updating BTC price to:', btcPrice);
                        btcSignalPrice.textContent = btcPrice + ' USDT';
                    }
                }
                
                // دریافت قیمت اتریوم با استفاده از ID استاندارد جدید
                const ethPrice = document.getElementById('ETH-USDT-price')?.textContent;
                if (ethPrice && ethPrice !== '--') {
                    const ethSignalPrice = document.getElementById('eth-signal-price');
                    if (ethSignalPrice) {
                        console.log('Updating ETH price to:', ethPrice);
                        ethSignalPrice.textContent = ethPrice + ' USDT';
                    }
                }
            } catch (error) {
                console.error('Error updating signal prices:', error);
            }
        }
        
        // دکمه‌های اضافی مشاهده مستقیم بخش سیگنال‌ها که در گوشه‌ی سمت چپ هدر بودند حذف شدند
        
        // افزودن توابع دسترسی سریع
        window.showSignalsDirectly = function() {
            document.getElementById('signals-pane').style.display = 'block';
            document.getElementById('technical-pane').style.display = 'none';
            document.getElementById('news-pane').style.display = 'none';
            updateSignalPrices();
        };
        
        window.showTechnicalDirectly = function() {
            document.getElementById('signals-pane').style.display = 'none';
            document.getElementById('technical-pane').style.display = 'block';
            document.getElementById('news-pane').style.display = 'none';
        };
        
        // تنظیم وضعیت اولیه بخش‌ها
        document.getElementById('technical-pane').style.display = 'block';
        document.getElementById('signals-pane').style.display = 'none';
        document.getElementById('news-pane').style.display = 'none';
        
        // به‌روزرسانی خودکار قیمت‌ها هر ۳۰ ثانیه
        setInterval(updateSignalPrices, 30000);
        
        // تابع برای ایجاد نمودار قیمت
        function createPriceChart(coinSymbol = 'BTC') {
            const ctx = document.getElementById('priceChart').getContext('2d');
            
            // داده‌های نمونه برای نمودار
            const labels = [];
            const prices = [];
            
            // ایجاد داده‌های تصادفی برای ۳۰ روز گذشته
            const today = new Date();
            let basePrice = 0;
            
            // تنظیم قیمت پایه بر اساس ارز
            switch(coinSymbol) {
                case 'BTC': basePrice = 65000; break;
                case 'ETH': basePrice = 3400; break;
                case 'SOL': basePrice = 150; break;
                case 'XRP': basePrice = 0.5; break;
                default: basePrice = 65000;
            }
            
            // ایجاد ۳۰ روز داده
            for (let i = 30; i >= 0; i--) {
                const date = new Date();
                date.setDate(today.getDate() - i);
                labels.push(date.toLocaleDateString('fa-IR'));
                
                // ایجاد قیمت با نوسان تصادفی حول قیمت پایه
                const randomFactor = 0.05; // ۵٪ نوسان
                const change = (Math.random() - 0.5) * randomFactor * basePrice;
                basePrice += change;
                if (basePrice < 0) basePrice = Math.abs(basePrice); // جلوگیری از قیمت منفی
                
                prices.push(basePrice);
            }
            
            // تنظیم رنگ‌ها
            const borderColor = coinSymbol === 'BTC' ? '#F7931A' : 
                               coinSymbol === 'ETH' ? '#627EEA' : 
                               coinSymbol === 'SOL' ? '#00FFB3' : '#0066FF';
                               
            const backgroundColor = coinSymbol === 'BTC' ? 'rgba(247, 147, 26, 0.1)' : 
                                  coinSymbol === 'ETH' ? 'rgba(98, 126, 234, 0.1)' : 
                                  coinSymbol === 'SOL' ? 'rgba(0, 255, 179, 0.1)' : 'rgba(0, 102, 255, 0.1)';
            
            // ایجاد نمودار
            try {
                if (window.priceChart instanceof Chart) {
                    window.priceChart.destroy();
                }
            } catch (error) {
                console.log('خطا در حذف نمودار قبلی:', error);
            }
            
            window.priceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: `${coinSymbol}/USDT Price`,
                        data: prices,
                        borderColor: borderColor,
                        backgroundColor: backgroundColor,
                        borderWidth: 2,
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            titleFont: {
                                family: 'Vazirmatn'
                            },
                            bodyFont: {
                                family: 'Vazirmatn'
                            },
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += new Intl.NumberFormat('en-US', { 
                                            minimumFractionDigits: 2,
                                            maximumFractionDigits: 2 
                                        }).format(context.parsed.y);
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            ticks: {
                                callback: function(value) {
                                    return new Intl.NumberFormat('en-US', { 
                                        minimumFractionDigits: 0,
                                        maximumFractionDigits: 0
                                    }).format(value);
                                }
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
            
            return window.priceChart;
        }
    
        // ایجاد نمودار قیمت اولیه (بیت‌کوین)
        setTimeout(() => {
            createPriceChart('BTC');
        }, 1500);
    
        // تنظیم رویدادهای کلیک روی تب‌های ارزی در تحلیل تکنیکال
        document.querySelectorAll('.btn-group[role="group"] button').forEach(button => {
            button.addEventListener('click', function() {
                // برداشتن وضعیت فعال از همه دکمه‌ها
                document.querySelectorAll('.btn-group[role="group"] button').forEach(btn => {
                    btn.classList.remove('active');
                    btn.classList.remove('btn-secondary');
                    btn.classList.add('btn-outline-secondary');
                });
                
                // فعال کردن دکمه انتخاب شده
                this.classList.remove('btn-outline-secondary');
                this.classList.add('btn-secondary');
                this.classList.add('active');
                
                // تغییر محتوای نمودار و عنوان بر اساس ارز انتخاب شده
                const coinText = this.textContent.trim();
                const titleElement = document.querySelector('#technical-pane .card-header h5');
                
                // به‌روزرسانی نمودار قیمت
                createPriceChart(coinText);
                
                if (titleElement) {
                    let coinName = 'Bitcoin';
                    if (coinText === 'ETH') coinName = 'Ethereum';
                    if (coinText === 'SOL') coinName = 'Solana';
                    if (coinText === 'XRP') coinName = 'Ripple';
                    
                    titleElement.textContent = `${coinName} Technical Analysis (Hourly Timeframe)`;
                }
            });
        });
    });
</script>

<!-- اسکریپت دیباگ ساده برای نمایش المان‌ها -->
<script>
    // تابع دیباگ - فورا اجرا می‌شود
    (function() {
        // اجرای با تاخیر برای اطمینان از بارگذاری کامل صفحه
        setTimeout(function() {
            console.log("Running debug script...");
            
            // بررسی المان‌های قیمت ارزهای رمزنگاری - حذف ارزهای هوش مصنوعی
            const elements = [
                'BTC-USDT-price', 'ETH-USDT-price', 'SOL-USDT-price', 'XRP-USDT-price'
            ];
            
            // بررسی وجود و محتوای هر المان
            elements.forEach(id => {
                const elem = document.getElementById(id);
                if (elem) {
                    console.log(`✓ Element ${id} found!`);
                    console.log(`  Content: "${elem.textContent}"`);
                    console.log(`  Is visible: ${window.getComputedStyle(elem).display !== 'none'}`);
                    console.log(`  Class list: ${elem.className}`);
                    // تست مستقیم تغییر محتوا
                    // کد تست حذف شد - مقدار‌های واقعی از API ها استفاده می‌شوند
                    console.log(`  ${id} ready for update from API`);
                    
                } else {
                    console.error(`✗ Element ${id} NOT found!`);
                }
            });
            
            // لاگ کردن ساختار DOM برای بخش میم کوین‌ها
            const memeSection = document.querySelector('h4.text-primary');
            if (memeSection) {
                console.log("✓ Found meme coins section:");
                console.log("  ", memeSection.textContent);
            } else {
                console.error("✗ Meme coins section not found!");
            }
            
            // تست تغییر مستقیم با querySelector
            const dogeElem = document.querySelector('[id="DOGE-USDT-price"]');
            if (dogeElem) {
                // تست قبلی حذف شد
                console.log("✓ DOGE price element found, waiting for update");
            }
            
            // تست برای اطمینان از اینکه ID‌ها درست هستند
            const allElements = document.querySelectorAll('[id$="-USDT-price"]');
            console.log(`Found ${allElements.length} elements with -USDT-price pattern:`);
            allElements.forEach(el => {
                console.log(`  ID: ${el.id}, Content: "${el.textContent}"`);
                // پس‌زمینه‌ها را تنظیم نمی‌کنیم تا از حالت اصلی تم استفاده شود
            });
        }, 1000);
    })();
</script>

<!-- اسکریپت اضافی برای به‌روزرسانی قیمت‌ها -->
<script>
    // اجرای این اسکریپت بعد از بارگذاری کامل صفحه
    window.addEventListener('load', function() {
        console.log("Window fully loaded - applying direct price updates");
        
        // آرایه‌های سکه‌ها
        const mainCoins = [
            {symbol: 'BTC', id: 'bitcoin'}, 
            {symbol: 'ETH', id: 'ethereum'}, 
            {symbol: 'SOL', id: 'solana'}, 
            {symbol: 'XRP', id: 'ripple'}
        ];
        const memeCoins = [
            {symbol: 'DOGE', id: 'dogecoin'}, 
            {symbol: 'SHIB', id: 'shiba-inu'}, 
            {symbol: 'PEPE', id: 'pepe'}, 
            {symbol: 'FLOKI', id: 'floki'}, 
            {symbol: 'WIF', id: 'dogwifhat'}, 
            {symbol: 'MEME', id: 'meme-token'}
        ];
        // ارزهای هوش مصنوعی حذف شده‌اند
        const aiCoins = [];
        const lowCostCoins = [
            {symbol: 'VET', id: 'vechain'}, 
            {symbol: 'XDC', id: 'xdc-network'}, 
            {symbol: 'HBAR', id: 'hedera-hashgraph'}, 
            {symbol: 'XLM', id: 'stellar'}, 
            {symbol: 'JASMY', id: 'jasmy'}
        ];
        
        // تابع به‌روزرسانی یک سکه
        function updateCoinPriceDirectly(coinData) {
            const coinSymbol = coinData.symbol;
            console.log(`Direct price update for ${coinSymbol}`);
            
            // دریافت المان‌های مربوطه
            const priceElement = document.getElementById(`${coinSymbol}-USDT-price`);
            const changeElement = document.getElementById(`${coinSymbol}-USDT-change`);
            
            if (!priceElement) {
                console.error(`Price element not found for ${coinSymbol}`);
                return;
            }
            
            fetch(`/api/price/${coinData.id.toLowerCase()}`)
                .then(response => response.json())
                .then(data => {
                    console.log(`API response for ${coinSymbol}:`, data);
                    
                    if (data.success && data.data && data.data.price) {
                        // به‌روزرسانی قیمت
                        const price = parseFloat(data.data.price);
                        priceElement.textContent = formatDirectPrice(price);
                        console.log(`Direct price updated for ${coinSymbol}: ${price}`);
                        
                        // به‌روزرسانی تغییرات
                        if (changeElement && data.data.change_24h) {
                            const change = parseFloat(data.data.change_24h);
                            const sign = change >= 0 ? '+' : '';
                            changeElement.textContent = `${sign}${change.toFixed(2)}%`;
                            
                            if (change >= 0) {
                                changeElement.classList.add('positive-change');
                                changeElement.classList.remove('negative-change');
                            } else {
                                changeElement.classList.add('negative-change');
                                changeElement.classList.remove('positive-change');
                            }
                        }
                    }
                })
                .catch(error => {
                    console.error(`Error updating ${coinSymbol}:`, error);
                    
                    // در صورت خطا، استفاده از API مستقیم CryptoCompare
                    fetch(`/api/price/${coinSymbol.toLowerCase()}`)
                        .then(response => response.json())
                        .then(data => {
                            console.log(`Fallback API response for ${coinSymbol}:`, data);
                            
                            if (data.success && data.data && data.data.price) {
                                // به‌روزرسانی قیمت
                                const price = parseFloat(data.data.price);
                                priceElement.textContent = formatDirectPrice(price);
                                console.log(`Fallback price updated for ${coinSymbol}: ${price}`);
                                
                                // به‌روزرسانی تغییرات
                                if (changeElement && data.data.change_24h) {
                                    const change = parseFloat(data.data.change_24h);
                                    const sign = change >= 0 ? '+' : '';
                                    changeElement.textContent = `${sign}${change.toFixed(2)}%`;
                                    
                                    if (change >= 0) {
                                        changeElement.classList.add('positive-change');
                                        changeElement.classList.remove('negative-change');
                                    } else {
                                        changeElement.classList.add('negative-change');
                                        changeElement.classList.remove('positive-change');
                                    }
                                }
                            }
                        })
                        .catch(fallbackError => {
                            console.error(`Fallback error updating ${coinSymbol}:`, fallbackError);
                        });
                });
        }
        
        // تابع قالب‌بندی قیمت
        function formatDirectPrice(price) {
            if (price >= 1000) {
                return price.toLocaleString('en-US', {maximumFractionDigits: 0});
            } else if (price >= 1) {
                return price.toLocaleString('en-US', {maximumFractionDigits: 2});
            } else if (price >= 0.01) {
                return price.toLocaleString('en-US', {maximumFractionDigits: 4});
            } else {
                return price.toLocaleString('en-US', {maximumFractionDigits: 8});
            }
        }
        
        // به‌روزرسانی همه سکه‌ها با تأخیر
        function updateAllCoinsWithDelay(coinList) {
            let delay = 0;
            const increment = 500; // 500 میلی‌ثانیه تأخیر بین هر سکه
            
            coinList.forEach(coin => {
                setTimeout(() => {
                    updateCoinPriceDirectly(coin);
                }, delay);
                delay += increment;
            });
        }
        
        // به‌روزرسانی همه دسته‌های سکه‌ها
        updateAllCoinsWithDelay(mainCoins);
        updateAllCoinsWithDelay(memeCoins);
        updateAllCoinsWithDelay(aiCoins);
        updateAllCoinsWithDelay(lowCostCoins);
        
        // به‌روزرسانی دوره‌ای هر 60 ثانیه
        setInterval(() => {
            console.log("Periodic update of all coins");
            updateAllCoinsWithDelay(mainCoins);
            updateAllCoinsWithDelay(memeCoins);
            updateAllCoinsWithDelay(aiCoins);
            updateAllCoinsWithDelay(lowCostCoins);
        }, 60000);
    });
</script>
{% endblock %}
