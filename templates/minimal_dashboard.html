{% extends "minimal_base.html" %}

{% block title %}{{ ui_text('dashboard', 'داشبورد') }} | {{ ui_text('title', 'برزین کریپتو') }}{% endblock %}

{% block content %}

<div id="dashboard-content">
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="mb-3">{{ ui_text('dashboard', 'داشبورد') }}</h1>
            <p class="text-muted">{{ ui_text('market_overview', 'آخرین تحلیل‌ها، سیگنال‌ها و قیمت‌های بازار ارز دیجیتال') }}</p>
        </div>
    </div>

    <!-- Crypto Price Cards -->
    <div class="row mb-4" id="price-section">
        <!-- Main Coins -->
        <div class="col-md-3 mb-3">
            <div class="card crypto-card h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div class="d-flex align-items-center">
                            <div class="icon-circle me-3">
                                <i class="fab fa-bitcoin text-warning fs-4"></i>
                            </div>
                            <div>
                                <h5 class="card-title mb-0">{{ ui_text('bitcoin', 'بیت‌کوین') }}</h5>
                                <p class="text-muted mb-0">BTC/USDT</p>
                            </div>
                        </div>
                    </div>
                    <div class="d-flex justify-content-between align-items-end">
                        <h3 class="mb-0" id="BTC-USDT-price">--</h3>
                        <h5 class="mb-0" id="BTC-USDT-change">--</h5>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card crypto-card h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div class="d-flex align-items-center">
                            <div class="icon-circle me-3">
                                <i class="fab fa-ethereum text-primary fs-4"></i>
                            </div>
                            <div>
                                <h5 class="card-title mb-0">{{ ui_text('ethereum', 'اتریوم') }}</h5>
                                <p class="text-muted mb-0">ETH/USDT</p>
                            </div>
                        </div>
                    </div>
                    <div class="d-flex justify-content-between align-items-end">
                        <h3 class="mb-0" id="ETH-USDT-price">--</h3>
                        <h5 class="mb-0" id="ETH-USDT-change">--</h5>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card crypto-card h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div class="d-flex align-items-center">
                            <div class="icon-circle me-3">
                                <i class="fas fa-sun text-success fs-4"></i>
                            </div>
                            <div>
                                <h5 class="card-title mb-0">{{ ui_text('coins.sol', 'سولانا') }}</h5>
                                <p class="text-muted mb-0">SOL/USDT</p>
                            </div>
                        </div>
                    </div>
                    <div class="d-flex justify-content-between align-items-end">
                        <h3 class="mb-0" id="SOL-USDT-price">--</h3>
                        <h5 class="mb-0" id="SOL-USDT-change">--</h5>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card crypto-card h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div class="d-flex align-items-center">
                            <div class="icon-circle me-3">
                                <i class="fas fa-chart-line text-info fs-4"></i>
                            </div>
                            <div>
                                <h5 class="card-title mb-0">{{ ui_text('ripple', 'ریپل') }}</h5>
                                <p class="text-muted mb-0">XRP/USDT</p>
                            </div>
                        </div>
                    </div>
                    <div class="d-flex justify-content-between align-items-end">
                        <h3 class="mb-0" id="XRP-USDT-price">--</h3>
                        <h5 class="mb-0" id="XRP-USDT-change">--</h5>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Meme Coins & Low-cost Growth -->
    <div class="row mb-4">
        <div class="col-12">
            <h4 class="text-primary mb-3">{{ ui_text('meme_coins', 'ارزهای میم محبوب') }}</h4>
        </div>
        <!-- Meme Coins -->
        <div class="col-md-2 mb-3">
            <div class="card crypto-card h-100">
                <div class="card-body p-2">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div class="d-flex align-items-center">
                            <div class="icon-circle me-2" style="width: 30px; height: 30px;">
                                <i class="fas fa-dog text-warning fs-5"></i>
                            </div>
                            <div>
                                <h6 class="card-title mb-0">DOGE</h6>
                            </div>
                        </div>
                    </div>
                    <div class="d-flex justify-content-between align-items-end">
                        <h5 class="mb-0" id="DOGE-USDT-price">--</h5>
                        <h6 class="mb-0" id="DOGE-USDT-change">--</h6>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-2 mb-3">
            <div class="card crypto-card h-100">
                <div class="card-body p-2">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div class="d-flex align-items-center">
                            <div class="icon-circle me-2" style="width: 30px; height: 30px;">
                                <i class="fas fa-paw text-warning fs-5"></i>
                            </div>
                            <div>
                                <h6 class="card-title mb-0">SHIB</h6>
                            </div>
                        </div>
                    </div>
                    <div class="d-flex justify-content-between align-items-end">
                        <h5 class="mb-0" id="SHIB-USDT-price">--</h5>
                        <h6 class="mb-0" id="SHIB-USDT-change">--</h6>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-2 mb-3">
            <div class="card crypto-card h-100">
                <div class="card-body p-2">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div class="d-flex align-items-center">
                            <div class="icon-circle me-2" style="width: 30px; height: 30px;">
                                <i class="fas fa-frog text-success fs-5"></i>
                            </div>
                            <div>
                                <h6 class="card-title mb-0">PEPE</h6>
                            </div>
                        </div>
                    </div>
                    <div class="d-flex justify-content-between align-items-end">
                        <h5 class="mb-0" id="PEPE-USDT-price">--</h5>
                        <h6 class="mb-0" id="PEPE-USDT-change">--</h6>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-2 mb-3">
            <div class="card crypto-card h-100">
                <div class="card-body p-2">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div class="d-flex align-items-center">
                            <div class="icon-circle me-2" style="width: 30px; height: 30px;">
                                <i class="fas fa-paw text-info fs-5"></i>
                            </div>
                            <div>
                                <h6 class="card-title mb-0">FLOKI</h6>
                            </div>
                        </div>
                    </div>
                    <div class="d-flex justify-content-between align-items-end">
                        <h5 class="mb-0" id="FLOKI-USDT-price">--</h5>
                        <h6 class="mb-0" id="FLOKI-USDT-change">--</h6>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-2 mb-3">
            <div class="card crypto-card h-100">
                <div class="card-body p-2">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div class="d-flex align-items-center">
                            <div class="icon-circle me-2" style="width: 30px; height: 30px;">
                                <i class="fas fa-dog text-primary fs-5"></i>
                            </div>
                            <div>
                                <h6 class="card-title mb-0">WIF</h6>
                            </div>
                        </div>
                    </div>
                    <div class="d-flex justify-content-between align-items-end">
                        <h5 class="mb-0" id="WIF-USDT-price">--</h5>
                        <h6 class="mb-0" id="WIF-USDT-change">--</h6>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-2 mb-3">
            <div class="card crypto-card h-100">
                <div class="card-body p-2">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div class="d-flex align-items-center">
                            <div class="icon-circle me-2" style="width: 30px; height: 30px;">
                                <i class="fas fa-laugh-squint text-warning fs-5"></i>
                            </div>
                            <div>
                                <h6 class="card-title mb-0">MEME</h6>
                            </div>
                        </div>
                    </div>
                    <div class="d-flex justify-content-between align-items-end">
                        <h5 class="mb-0" id="MEME-USDT-price">--</h5>
                        <h6 class="mb-0" id="MEME-USDT-change">--</h6>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- AI Coins -->
    <div class="row mb-4">
        <div class="col-12">
            <h4 class="text-primary mb-3">{{ ui_text('ai_coins', 'ارزهای هوش مصنوعی') }}</h4>
        </div>
        <div class="col-md-2 mb-3">
            <div class="card crypto-card h-100">
                <div class="card-body p-2">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div class="d-flex align-items-center">
                            <div class="icon-circle me-2" style="width: 30px; height: 30px;">
                                <i class="fas fa-microchip text-info fs-5"></i>
                            </div>
                            <div>
                                <h6 class="card-title mb-0">RNDR</h6>
                            </div>
                        </div>
                    </div>
                    <div class="d-flex justify-content-between align-items-end">
                        <h5 class="mb-0" id="RNDR-USDT-price">--</h5>
                        <h6 class="mb-0" id="RNDR-USDT-change">--</h6>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-2 mb-3">
            <div class="card crypto-card h-100">
                <div class="card-body p-2">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div class="d-flex align-items-center">
                            <div class="icon-circle me-2" style="width: 30px; height: 30px;">
                                <i class="fas fa-brain text-primary fs-5"></i>
                            </div>
                            <div>
                                <h6 class="card-title mb-0">FET</h6>
                            </div>
                        </div>
                    </div>
                    <div class="d-flex justify-content-between align-items-end">
                        <h5 class="mb-0" id="FET-USDT-price">--</h5>
                        <h6 class="mb-0" id="FET-USDT-change">--</h6>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-2 mb-3">
            <div class="card crypto-card h-100">
                <div class="card-body p-2">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div class="d-flex align-items-center">
                            <div class="icon-circle me-2" style="width: 30px; height: 30px;">
                                <i class="fas fa-globe text-success fs-5"></i>
                            </div>
                            <div>
                                <h6 class="card-title mb-0">OCEAN</h6>
                            </div>
                        </div>
                    </div>
                    <div class="d-flex justify-content-between align-items-end">
                        <h5 class="mb-0" id="OCEAN-USDT-price">--</h5>
                        <h6 class="mb-0" id="OCEAN-USDT-change">--</h6>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-2 mb-3">
            <div class="card crypto-card h-100">
                <div class="card-body p-2">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div class="d-flex align-items-center">
                            <div class="icon-circle me-2" style="width: 30px; height: 30px;">
                                <i class="fas fa-robot text-warning fs-5"></i>
                            </div>
                            <div>
                                <h6 class="card-title mb-0">AGIX</h6>
                            </div>
                        </div>
                    </div>
                    <div class="d-flex justify-content-between align-items-end">
                        <h5 class="mb-0" id="AGIX-USDT-price">--</h5>
                        <h6 class="mb-0" id="AGIX-USDT-change">--</h6>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Low-Cost Growth Coins -->
    <div class="row mb-4">
        <div class="col-12">
            <h4 class="text-primary mb-3">{{ ui_text('lowcost_coins', 'ارزهای ارزان با پتانسیل رشد') }}</h4>
        </div>
        <div class="col-md-2 mb-3">
            <div class="card crypto-card h-100">
                <div class="card-body p-2">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div class="d-flex align-items-center">
                            <div class="icon-circle me-2" style="width: 30px; height: 30px;">
                                <i class="fas fa-truck-loading text-info fs-5"></i>
                            </div>
                            <div>
                                <h6 class="card-title mb-0">VET</h6>
                            </div>
                        </div>
                    </div>
                    <div class="d-flex justify-content-between align-items-end">
                        <h5 class="mb-0" id="VET-USDT-price">--</h5>
                        <h6 class="mb-0" id="VET-USDT-change">--</h6>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-2 mb-3">
            <div class="card crypto-card h-100">
                <div class="card-body p-2">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div class="d-flex align-items-center">
                            <div class="icon-circle me-2" style="width: 30px; height: 30px;">
                                <i class="fas fa-exchange-alt text-primary fs-5"></i>
                            </div>
                            <div>
                                <h6 class="card-title mb-0">XDC</h6>
                            </div>
                        </div>
                    </div>
                    <div class="d-flex justify-content-between align-items-end">
                        <h5 class="mb-0" id="XDC-USDT-price">--</h5>
                        <h6 class="mb-0" id="XDC-USDT-change">--</h6>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-2 mb-3">
            <div class="card crypto-card h-100">
                <div class="card-body p-2">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div class="d-flex align-items-center">
                            <div class="icon-circle me-2" style="width: 30px; height: 30px;">
                                <i class="fas fa-h-square text-success fs-5"></i>
                            </div>
                            <div>
                                <h6 class="card-title mb-0">HBAR</h6>
                            </div>
                        </div>
                    </div>
                    <div class="d-flex justify-content-between align-items-end">
                        <h5 class="mb-0" id="HBAR-USDT-price">--</h5>
                        <h6 class="mb-0" id="HBAR-USDT-change">--</h6>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-2 mb-3">
            <div class="card crypto-card h-100">
                <div class="card-body p-2">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div class="d-flex align-items-center">
                            <div class="icon-circle me-2" style="width: 30px; height: 30px;">
                                <i class="fas fa-star text-warning fs-5"></i>
                            </div>
                            <div>
                                <h6 class="card-title mb-0">XLM</h6>
                            </div>
                        </div>
                    </div>
                    <div class="d-flex justify-content-between align-items-end">
                        <h5 class="mb-0" id="XLM-USDT-price">--</h5>
                        <h6 class="mb-0" id="XLM-USDT-change">--</h6>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-2 mb-3">
            <div class="card crypto-card h-100">
                <div class="card-body p-2">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div class="d-flex align-items-center">
                            <div class="icon-circle me-2" style="width: 30px; height: 30px;">
                                <i class="fas fa-cogs text-info fs-5"></i>
                            </div>
                            <div>
                                <h6 class="card-title mb-0">JASMY</h6>
                            </div>
                        </div>
                    </div>
                    <div class="d-flex justify-content-between align-items-end">
                        <h5 class="mb-0" id="JASMY-USDT-price">--</h5>
                        <h6 class="mb-0" id="JASMY-USDT-change">--</h6>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Simple Section Switcher instead of tabs -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-center gap-2">
                <button class="btn btn-primary active" id="technical-btn" onclick="switchSection('technical')">
                    <i class="fas fa-chart-bar me-1"></i> {{ ui_text('technical_analysis', 'تحلیل تکنیکال') }}
                </button>
                <button class="btn btn-outline-primary" id="signals-btn" onclick="switchSection('signals')">
                    <i class="fas fa-signal me-1"></i> {{ ui_text('trading_signals', 'سیگنال‌های معاملاتی') }}
                </button>
                <button class="btn btn-outline-primary" id="news-btn" onclick="switchSection('news')">
                    <i class="fas fa-newspaper me-1"></i> {{ ui_text('news', 'اخبار') }}
                </button>
            </div>
        </div>
    </div>
            
    <!-- JavaScript for updating prices for new coins -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Add event listeners for all new coin price updates - Meme coins
            // We'll use our new updateSpecialCoins function instead of these individual calls
            
            // Display new crypto sections and headings
            setupCryptoSections();
            
            // تابع به‌روزرسانی ارزهای ویژه (میم کوین‌ها و ارزهای هوش مصنوعی)
            function updateSpecialCoins() {
                console.log('Updating special coins (meme coins & AI coins)');
                const specialCoins = [
                    // میم کوین‌ها
                    'DOGE', 'SHIB', 'PEPE', 'FLOKI', 'WIF', 'MEME',
                    // ارزهای هوش مصنوعی
                    'RNDR', 'FET', 'OCEAN', 'AGIX',
                    // ارزهای کم‌ارزش با پتانسیل رشد
                    'VET', 'XDC', 'HBAR', 'XLM', 'JASMY'
                ];
                
                specialCoins.forEach((coin, index) => {
                    setTimeout(() => {
                        console.log(`Directly updating ${coin} price`);
                        
                        // بررسی وجود المان قیمت در DOM
                        const priceElement = document.getElementById(`${coin}-USDT-price`);
                        const changeElement = document.getElementById(`${coin}-USDT-change`);
                        
                        if (!priceElement) {
                            console.warn(`Price element for ${coin}-USDT not found in DOM`);
                            return; // ادامه عملیات را متوقف می‌کنیم
                        }
                        
                        fetch(`/api/price/${coin.toLowerCase()}`)
                        .then(response => {
                            if (!response.ok) {
                                throw new Error(`HTTP error! Status: ${response.status}`);
                            }
                            return response.json();
                        })
                        .then(data => {
                            if (data && data.success && data.data && data.data.price) {
                                if (priceElement) {
                                    const price = parseFloat(data.data.price);
                                    priceElement.textContent = formatPrice(price);
                                    console.log(`Successfully updated ${coin} price to ${price}`);
                                }
                                
                                if (changeElement) {
                                    const change = parseFloat(data.data.change_24h || 1.2);
                                    changeElement.textContent = formatChange(change);
                                    
                                    if (change >= 0) {
                                        changeElement.classList.add('positive-change');
                                        changeElement.classList.remove('negative-change');
                                    } else {
                                        changeElement.classList.add('negative-change');
                                        changeElement.classList.remove('positive-change');
                                    }
                                }
                            } else {
                                console.warn(`Invalid data received for ${coin}:`, data);
                            }
                        })
                        .catch(error => {
                            console.error(`Error updating ${coin}:`, error);
                            // در صورت خطا، یک مقدار پیش‌فرض را نمایش می‌دهیم
                            if (priceElement) {
                                priceElement.textContent = "در حال به‌روزرسانی...";
                            }
                        });
                    }, index * 500); // 500ms delay between each request
                });
            }
            
            // به‌روزرسانی ارزهای ویژه هنگام بارگذاری صفحه
            setTimeout(updateSpecialCoins, 2000);
            
            // به‌روزرسانی ارزهای ویژه هر 30 ثانیه
            setInterval(updateSpecialCoins, 30000);
        });
        
        // Add cryptocurrency cards to the dashboard
        function setupCryptoSections() {
            // Get main container
            const mainContainer = document.querySelector('.main-content');
            if (!mainContainer) return;
            
            // Create meme coins section
            const memeCoinsSection = createCryptoSection('meme_coins', 'ارزهای میم محبوب', [
                { symbol: 'DOGE-USDT', name: 'Dogecoin', logo: 'doge.svg' },
                { symbol: 'SHIB-USDT', name: 'Shiba Inu', logo: 'shib.svg' },
                { symbol: 'PEPE-USDT', name: 'Pepe', logo: 'pepe.svg' },
                { symbol: 'FLOKI-USDT', name: 'Floki', logo: 'floki.svg' },
                { symbol: 'WIF-USDT', name: 'Dogwifhat', logo: 'wif.svg' },
                { symbol: 'MEME-USDT', name: 'Meme', logo: 'meme.svg' }
            ]);
            
            // Create AI coins section
            const aiCoinsSection = createCryptoSection('ai_coins', 'ارزهای هوش مصنوعی', [
                { symbol: 'RNDR-USDT', name: 'Render', logo: 'rndr.svg' },
                { symbol: 'FET-USDT', name: 'Fetch.ai', logo: 'fet.svg' },
                { symbol: 'OCEAN-USDT', name: 'Ocean Protocol', logo: 'ocean.svg' },
                { symbol: 'AGIX-USDT', name: 'SingularityNET', logo: 'agix.svg' }
            ]);
            
            // Create low-cost growth coins section
            const lowCostSection = createCryptoSection('lowcost_coins', 'ارزهای ارزان با پتانسیل رشد', [
                { symbol: 'VET-USDT', name: 'VeChain', logo: 'vet.svg' },
                { symbol: 'XDC-USDT', name: 'XDC Network', logo: 'xdc.svg' },
                { symbol: 'HBAR-USDT', name: 'Hedera', logo: 'hbar.svg' },
                { symbol: 'XLM-USDT', name: 'Stellar', logo: 'xlm.svg' },
                { symbol: 'JASMY-USDT', name: 'Jasmy', logo: 'jasmy.svg' }
            ]);
            
            // Add sections to main container
            const priceSection = document.querySelector('.price-section');
            if (priceSection) {
                priceSection.parentNode.insertBefore(memeCoinsSection, priceSection.nextSibling);
                priceSection.parentNode.insertBefore(aiCoinsSection, memeCoinsSection.nextSibling);
                priceSection.parentNode.insertBefore(lowCostSection, aiCoinsSection.nextSibling);
            } else {
                mainContainer.appendChild(memeCoinsSection);
                mainContainer.appendChild(aiCoinsSection);
                mainContainer.appendChild(lowCostSection);
            }
        }
        
        // Create a crypto section with cards
        function createCryptoSection(sectionId, sectionTitle, coins) {
            const section = document.createElement('div');
            section.className = 'coin-section mb-4';
            section.id = sectionId;
            
            // Create section header
            const header = document.createElement('h2');
            header.className = 'section-heading mb-3';
            header.textContent = sectionTitle;
            section.appendChild(header);
            
            // Create row for cards
            const row = document.createElement('div');
            row.className = 'row';
            
            // Add coin cards
            coins.forEach(coin => {
                const card = createCryptoCard(coin.symbol, coin.name, coin.logo);
                row.appendChild(card);
            });
            
            section.appendChild(row);
            return section;
        }
        
        // Create a crypto card
        function createCryptoCard(symbol, name, logo) {
            const col = document.createElement('div');
            col.className = 'col-md-4 col-lg-3 mb-3';
            
            const card = document.createElement('div');
            card.className = 'card crypto-card h-100';
            
            // Card header with logo and name
            const cardHeader = document.createElement('div');
            cardHeader.className = 'card-header d-flex align-items-center';
            
            const iconDiv = document.createElement('div');
            iconDiv.className = 'crypto-icon me-2';
            
            const icon = document.createElement('i');
            icon.className = 'fab fa-ethereum'; // Default icon - we don't have all logos yet
            iconDiv.appendChild(icon);
            
            const nameHeading = document.createElement('h5');
            nameHeading.className = 'mb-0';
            nameHeading.textContent = name;
            
            cardHeader.appendChild(iconDiv);
            cardHeader.appendChild(nameHeading);
            card.appendChild(cardHeader);
            
            // Card body with price and change
            const cardBody = document.createElement('div');
            cardBody.className = 'card-body';
            
            const priceDiv = document.createElement('div');
            priceDiv.className = 'd-flex justify-content-between mb-2';
            
            const priceLabel = document.createElement('span');
            priceLabel.className = 'text-muted';
            priceLabel.textContent = 'قیمت:';
            
            const priceValue = document.createElement('span');
            priceValue.className = 'fw-bold';
            
            // از ID استاندارد برای updateSpecialCoins استفاده کنیم
            const coinSymbol = symbol.split('-')[0];
            priceValue.id = `${coinSymbol}-USDT-price`;
            priceValue.textContent = '...';
            
            priceDiv.appendChild(priceLabel);
            priceDiv.appendChild(priceValue);
            
            const changeDiv = document.createElement('div');
            changeDiv.className = 'd-flex justify-content-between';
            
            const changeLabel = document.createElement('span');
            changeLabel.className = 'text-muted';
            changeLabel.textContent = 'تغییر ۲۴ ساعته:';
            
            const changeValue = document.createElement('span');
            
            // از ID استاندارد برای updateSpecialCoins استفاده کنیم
            changeValue.id = `${coinSymbol}-USDT-change`;
            changeValue.textContent = '...';
            
            changeDiv.appendChild(changeLabel);
            changeDiv.appendChild(changeValue);
            
            cardBody.appendChild(priceDiv);
            cardBody.appendChild(changeDiv);
            card.appendChild(cardBody);
            
            col.appendChild(card);
            return col;
        }
        
        // Direct API request method - simplified for better reliability
        function queueFetchRequest(coin, base) {
            const symbol = `${coin}-${base}`;
            setTimeout(() => {
                fetchCoinPrice(coin, symbol);
            }, Math.random() * 1000); // Add random delay between 0-1000ms to avoid overwhelming the server
        }
        
        function fetchCoinPrice(coin, symbol) {
            const priceElement = document.getElementById(`${symbol}-price`);
            const changeElement = document.getElementById(`${symbol}-change`);
            
            // Update the UI to show loading state
            if (priceElement) {
                priceElement.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i>';
            }
            
            if (changeElement) {
                changeElement.textContent = '...';
            }
            
            // Simple direct API call without any extra headers, options or signal
            fetch('/api/price/' + coin.toLowerCase())
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(response => {
                    if (response && response.success && response.data) {
                        const data = response.data;
                        if (data && data.price) {
                            const price = parseFloat(data.price);
                            const change = parseFloat(data.change_24h || 0);
                            
                            // Update price - using new standardized ID format
                            const coinSymbol = coin.toUpperCase();
                            const priceElement = document.getElementById(`${coinSymbol}-USDT-price`);
                            if (priceElement) {
                                priceElement.textContent = formatPrice(price);
                            }
                            
                            // Update change percentage - using new standardized ID format
                            const changeElement = document.getElementById(`${coinSymbol}-USDT-change`);
                            if (changeElement) {
                                changeElement.textContent = formatChange(change);
                                if (change >= 0) {
                                    changeElement.classList.add('positive-change');
                                    changeElement.classList.remove('negative-change');
                                } else {
                                    changeElement.classList.add('negative-change');
                                    changeElement.classList.remove('positive-change');
                                }
                            }
                        } else {
                            console.log(`No price data available for ${coin}`);
                        }
                    } else {
                        console.log(`No valid response for ${coin}`);
                    }
                })
                .catch(error => {
                    console.log(`Error fetching price for ${coin}: ${error}`);
                    
                    // Let's try a direct API call as a backup
                    setTimeout(() => {
                        fetch(`/api/price/${coin.toLowerCase()}`, {
                            headers: { 'Cache-Control': 'no-cache' }
                        })
                        .then(response => response.json())
                        .then(response => {
                            if (response && response.success && response.data) {
                                const data = response.data;
                                if (data && data.price) {
                                    const price = parseFloat(data.price);
                                    const change = parseFloat(data.change_24h || 0);
                                    
                                    // Update price - using new standardized ID format
                                    const coinSymbol = coin.toUpperCase();
                                    const priceElement = document.getElementById(`${coinSymbol}-USDT-price`);
                                    if (priceElement) {
                                        console.log(`Backup succeeded for ${coin}: ${price}`);
                                        priceElement.textContent = formatPrice(price);
                                    }
                                    
                                    // Update change percentage - using new standardized ID format
                                    const changeElement = document.getElementById(`${coinSymbol}-USDT-change`);
                                    if (changeElement) {
                                        changeElement.textContent = formatChange(change);
                                        if (change >= 0) {
                                            changeElement.classList.add('positive-change');
                                            changeElement.classList.remove('negative-change');
                                        } else {
                                            changeElement.classList.add('negative-change');
                                            changeElement.classList.remove('positive-change');
                                        }
                                    }
                                }
                            }
                        })
                        .catch(() => {
                            // If backup also failed, show error - using new standardized ID format 
                            const coinSymbol = coin.toUpperCase();
                            const priceElement = document.getElementById(`${coinSymbol}-USDT-price`);
                            if (priceElement) {
                                priceElement.textContent = 'در حال به‌روزرسانی...';
                            }
                        });
                    }, 500);
                });
        }
        
        function formatPrice(price) {
            // Format based on price magnitude
            if (price >= 1000) {
                return price.toLocaleString('en-US', {maximumFractionDigits: 0});
            } else if (price >= 1) {
                return price.toLocaleString('en-US', {maximumFractionDigits: 2});
            } else if (price >= 0.01) {
                return price.toLocaleString('en-US', {maximumFractionDigits: 4});
            } else {
                return price.toLocaleString('en-US', {maximumFractionDigits: 8});
            }
        }
        
        function formatChange(change) {
            const sign = change >= 0 ? '+' : '';
            return `${sign}${change.toFixed(2)}%`;
        }
    </script>
    
    <!-- Section Content Container -->
    <div class="sections-container">
                <!-- Technical Analysis Tab -->
                <div class="tab-pane active" id="technical-pane" role="tabpanel" aria-labelledby="technical-tab">
                    <div class="card crypto-card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">{{ ui_text('technical_analysis_bitcoin', 'تحلیل تکنیکال بیت‌کوین (تایم‌فریم ساعتی)') }}</h5>
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-sm btn-secondary active">BTC</button>
                                <button type="button" class="btn btn-sm btn-outline-secondary">ETH</button>
                                <button type="button" class="btn btn-sm btn-outline-secondary">SOL</button>
                                <button type="button" class="btn btn-sm btn-outline-secondary">XRP</button>
                            </div>
                        </div>
                        <div class="card-body">
                            <!-- Loading Spinner -->
                            <div id="technical-loading" class="text-center py-5">
                                <span class="loader"></span>
                                <p class="mt-3 text-muted">{{ ui_text('loading_technical_analysis', 'در حال بارگذاری تحلیل تکنیکال...') }}</p>
                            </div>
                            
                            <!-- Technical Analysis Content -->
                            <div id="technical-content" style="display: none;">
                                <!-- Chart Container -->
                                <div class="chart-container mb-4">
                                    <canvas id="priceChart"></canvas>
                                </div>
                                
                                <div class="row">
                                    <div class="col-lg-6">
                                        <div class="card mb-3 stat-card">
                                            <div class="card-body">
                                                <h5 class="card-title mb-3">شاخص‌های تکنیکال</h5>
                                                <div class="table-responsive">
                                                    <table class="table table-sm">
                                                        <tbody>
                                                            <tr>
                                                                <td><strong>RSI</strong> <small class="text-muted">(14)</small></td>
                                                                <td><span id="rsi-value">--</span></td>
                                                            </tr>
                                                            <tr>
                                                                <td><strong>MACD</strong></td>
                                                                <td><span id="macd-value">--</span></td>
                                                            </tr>
                                                            <tr>
                                                                <td><strong>میانگین متحرک</strong></td>
                                                                <td><span id="ma-value">--</span></td>
                                                            </tr>
                                                            <tr class="table-active">
                                                                <td><strong>سیگنال کلی</strong></td>
                                                                <td><strong id="overall-signal">--</strong></td>
                                                            </tr>
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-lg-6">
                                        <div class="card mb-3 stat-card">
                                            <div class="card-body">
                                                <h5 class="card-title mb-3">سطوح حمایت و مقاومت</h5>
                                                <div class="table-responsive">
                                                    <table class="table table-sm">
                                                        <tbody>
                                                            <tr>
                                                                <td><strong>مقاومت 2</strong></td>
                                                                <td>۶۸,۵۰۰</td>
                                                            </tr>
                                                            <tr>
                                                                <td><strong>مقاومت 1</strong></td>
                                                                <td>۶۶,۸۰۰</td>
                                                            </tr>
                                                            <tr class="table-active">
                                                                <td><strong>قیمت فعلی</strong></td>
                                                                <td>۶۵,۱۲۰</td>
                                                            </tr>
                                                            <tr>
                                                                <td><strong>حمایت 1</strong></td>
                                                                <td>۶۴,۵۰۰</td>
                                                            </tr>
                                                            <tr>
                                                                <td><strong>حمایت 2</strong></td>
                                                                <td>۶۳,۲۰۰</td>
                                                            </tr>
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="card mb-3 stat-card">
                                    <div class="card-body">
                                        <h5 class="card-title mb-3">توضیحات تحلیل</h5>
                                        <p>بیت‌کوین در حال حاضر در روند صعودی قرار دارد. شاخص RSI نشان‌دهنده شرایط خریداری بیش از حد (اشباع خرید) است، اما MACD همچنان سیگنال صعودی را نشان می‌دهد. میانگین‌های متحرک حمایت خوبی را در سطح ۶۴,۵۰۰ دلار فراهم می‌کنند.</p>
                                        <p>توصیه می‌شود معامله‌گران صبر کنند تا سیگنال تأییدی بیشتری دریافت کنند یا منتظر اصلاح به سمت سطوح حمایتی باشند.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Trading Signals Tab -->
                <div class="tab-pane" id="signals-pane" role="tabpanel" aria-labelledby="signals-tab" style="display: none;">
                    <!-- Loading Spinner -->
                    <div id="signals-loading" style="display: none;" class="text-center py-5">
                        <span class="loader"></span>
                        <p class="mt-3 text-muted">{{ ui_text('loading_trading_signals', 'در حال بارگذاری سیگنال‌های معاملاتی...') }}</p>
                    </div>
                    
                    <!-- Signals Container -->
                    <div id="signals-container" class="row">
                        <!-- BTC Signal Card -->
                        <div class="col-md-6 mb-4">
                            <div class="card crypto-card h-100">
                                <div class="card-header">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div class="d-flex align-items-center">
                                            <div class="icon-circle me-2">
                                                <i class="fab fa-bitcoin text-warning"></i>
                                            </div>
                                            <h5 class="mb-0">{{ ui_text('bitcoin', 'بیت‌کوین') }} (BTC/USDT)</h5>
                                        </div>
                                        <span class="badge bg-success">{{ ui_text('buy', 'خرید') }}</span>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <div class="d-flex justify-content-between mb-1">
                                            <span class="text-muted">{{ ui_text('current_price', 'قیمت فعلی') }}:</span>
                                            <span id="btc-signal-price" class="fw-bold">۶۵,۱۲۰ USDT</span>
                                        </div>
                                        <div class="d-flex justify-content-between mb-1">
                                            <span class="text-muted">{{ ui_text('suggested_volume', 'حجم پیشنهادی') }}:</span>
                                            <span class="fw-bold">۰.۵ BTC</span>
                                        </div>
                                        <div class="d-flex justify-content-between mb-1">
                                            <span class="text-muted">{{ ui_text('take_profit', 'حد سود') }}:</span>
                                            <span class="text-success">۶۸,۵۰۰ USDT (+۵.۲٪)</span>
                                        </div>
                                        <div class="d-flex justify-content-between">
                                            <span class="text-muted">{{ ui_text('stop_loss', 'حد ضرر') }}:</span>
                                            <span class="text-danger">۶۲,۸۰۰ USDT (-۳.۶٪)</span>
                                        </div>
                                    </div>
                                    <p class="signal-description">
                                        بیت‌کوین اخیراً یک الگوی مثلث صعودی را تکمیل کرده و به نظر می‌رسد آماده ادامه روند صعودی است. شاخص RSI در ناحیه خنثی قرار دارد و MACD سیگنال خرید را نشان می‌دهد.
                                    </p>
                                    <div class="text-center mt-3">
                                        <button class="btn btn-sm btn-outline-warning me-2">{{ ui_text("share", "اشتراک‌گذاری") }} <i class="fas fa-share-alt ms-1"></i></button>
                                        <button class="btn btn-sm btn-primary">{{ ui_text("buy", "خرید") }} <i class="fas fa-arrow-right ms-1"></i></button>
                                    </div>
                                </div>
                                <div class="card-footer text-muted">
                                    <small>ایجاد شده: امروز ۱۵:۴۵ | اعتبار: ۲۴ ساعت</small>
                                </div>
                            </div>
                        </div>
                        
                        <!-- ETH Signal Card -->
                        <div class="col-md-6 mb-4">
                            <div class="card crypto-card h-100">
                                <div class="card-header">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div class="d-flex align-items-center">
                                            <div class="icon-circle me-2">
                                                <i class="fab fa-ethereum text-primary"></i>
                                            </div>
                                            <h5 class="mb-0">{{ ui_text('ethereum', 'اتریوم') }} (ETH/USDT)</h5>
                                        </div>
                                        <span class="badge bg-danger">{{ ui_text('sell', 'فروش') }}</span>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <div class="d-flex justify-content-between mb-1">
                                            <span class="text-muted">{{ ui_text('current_price', 'قیمت فعلی') }}:</span>
                                            <span id="eth-signal-price" class="fw-bold">۳,۴۵۰ USDT</span>
                                        </div>
                                        <div class="d-flex justify-content-between mb-1">
                                            <span class="text-muted">{{ ui_text('suggested_volume', 'حجم پیشنهادی') }}:</span>
                                            <span class="fw-bold">۲ ETH</span>
                                        </div>
                                        <div class="d-flex justify-content-between mb-1">
                                            <span class="text-muted">{{ ui_text('take_profit', 'حد سود') }}:</span>
                                            <span class="text-success">۳,۲۳۰ USDT (+۶.۴٪)</span>
                                        </div>
                                        <div class="d-flex justify-content-between">
                                            <span class="text-muted">{{ ui_text('stop_loss', 'حد ضرر') }}:</span>
                                            <span class="text-danger">۳,۵۸۰ USDT (-۳.۸٪)</span>
                                        </div>
                                    </div>
                                    <p class="signal-description">
                                        {{ ui_text('eth_sell_signal', 'اتریوم در نزدیکی مقاومت کلیدی قرار گرفته و شاخص‌های تکنیکال نشان‌دهنده اشباع خرید هستند. RSI بالای ۷۰ قرار دارد و الگوی واگرایی منفی با MACD مشاهده می‌شود. احتمال اصلاح قیمت وجود دارد.') }}
                                    </p>
                                    <div class="text-center mt-3">
                                        <button class="btn btn-sm btn-outline-warning me-2">{{ ui_text("share", "اشتراک‌گذاری") }} <i class="fas fa-share-alt ms-1"></i></button>
                                        <button class="btn btn-sm btn-danger">{{ ui_text("sell", "فروش") }} <i class="fas fa-arrow-left ms-1"></i></button>
                                    </div>
                                </div>
                                <div class="card-footer text-muted">
                                    <small>{{ ui_text('signal_validity', 'ایجاد شده: امروز {time} | اعتبار: {hours} ساعت').format(time='۱۶:۳۰', hours='۱۲') }}</small>
                                </div>
                            </div>
                        </div>
                        
                        <!-- SOL Signal Card -->
                        <div class="col-md-6 mb-4">
                            <div class="card crypto-card h-100">
                                <div class="card-header">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div class="d-flex align-items-center">
                                            <div class="icon-circle me-2">
                                                <i class="fas fa-sun text-info"></i>
                                            </div>
                                            <h5 class="mb-0">{{ ui_text('solana', 'سولانا') }} (SOL/USDT)</h5>
                                        </div>
                                        <span class="badge bg-success">{{ ui_text('buy', 'خرید') }}</span>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <div class="d-flex justify-content-between mb-1">
                                            <span class="text-muted">{{ ui_text('current_price', 'قیمت فعلی') }}:</span>
                                            <span class="fw-bold">۱۵۲ USDT</span>
                                        </div>
                                        <div class="d-flex justify-content-between mb-1">
                                            <span class="text-muted">{{ ui_text('suggested_volume', 'حجم پیشنهادی') }}:</span>
                                            <span class="fw-bold">۱۰ SOL</span>
                                        </div>
                                        <div class="d-flex justify-content-between mb-1">
                                            <span class="text-muted">{{ ui_text('take_profit', 'حد سود') }}:</span>
                                            <span class="text-success">۱۷۵ USDT (+۱۵.۱٪)</span>
                                        </div>
                                        <div class="d-flex justify-content-between">
                                            <span class="text-muted">{{ ui_text('stop_loss', 'حد ضرر') }}:</span>
                                            <span class="text-danger">۱۳۹ USDT (-۸.۶٪)</span>
                                        </div>
                                    </div>
                                    <p class="signal-description">
                                        {{ ui_text('sol_buy_signal', 'سولانا در حال شکستن یک الگوی مقاومتی کلیدی است و با حجم معاملات بالا در حال حرکت است. میانگین‌های متحرک حمایت قوی را نشان می‌دهند و پتانسیل رشد قابل توجهی وجود دارد.') }}
                                    </p>
                                    <div class="text-center mt-3">
                                        <button class="btn btn-sm btn-outline-warning me-2">{{ ui_text("share", "اشتراک‌گذاری") }} <i class="fas fa-share-alt ms-1"></i></button>
                                        <button class="btn btn-sm btn-primary">{{ ui_text("buy", "خرید") }} <i class="fas fa-arrow-right ms-1"></i></button>
                                    </div>
                                </div>
                                <div class="card-footer text-muted">
                                    <small>{{ ui_text('signal_validity', 'ایجاد شده: امروز {time} | اعتبار: {hours} ساعت').format(time='۱۴:۲۰', hours='۴۸') }}</small>
                                </div>
                            </div>
                        </div>
                        
                        <!-- BNB Signal Card -->
                        <div class="col-md-6 mb-4">
                            <div class="card crypto-card h-100">
                                <div class="card-header">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div class="d-flex align-items-center">
                                            <div class="icon-circle me-2">
                                                <i class="fas fa-coins text-warning"></i>
                                            </div>
                                            <h5 class="mb-0">{{ ui_text('binance_coin', 'بایننس کوین') }} (BNB/USDT)</h5>
                                        </div>
                                        <span class="badge bg-warning">{{ ui_text('wait', 'انتظار') }}</span>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <div class="d-flex justify-content-between mb-1">
                                            <span class="text-muted">{{ ui_text('current_price', 'قیمت فعلی') }}:</span>
                                            <span class="fw-bold">۵۶۰ USDT</span>
                                        </div>
                                        <div class="d-flex justify-content-between mb-1">
                                            <span class="text-muted">{{ ui_text('monitoring_level', 'سطح نظارت') }}:</span>
                                            <span class="fw-bold">۵۸۰ USDT</span>
                                        </div>
                                        <div class="d-flex justify-content-between mb-1">
                                            <span class="text-muted">{{ ui_text('price_target_bullish', 'هدف قیمتی (صعودی)') }}:</span>
                                            <span class="text-success">۶۱۵ USDT</span>
                                        </div>
                                        <div class="d-flex justify-content-between">
                                            <span class="text-muted">{{ ui_text('price_target_bearish', 'هدف قیمتی (نزولی)') }}:</span>
                                            <span class="text-danger">۵۲۰ USDT</span>
                                        </div>
                                    </div>
                                    <p class="signal-description">
                                        {{ ui_text('bnb_wait_signal', 'بایننس کوین در یک محدوده قیمتی باریک در حال معامله است. در صورت شکست سطح مقاومت ۵۸۰ دلار، سیگنال خرید فعال می‌شود. پیشنهاد می‌شود تا زمان شکست این سطح، معامله‌ای انجام نشود.') }}
                                    </p>
                                    <div class="text-center mt-3">
                                        <button class="btn btn-sm btn-outline-warning me-2">{{ ui_text("share", "اشتراک‌گذاری") }} <i class="fas fa-share-alt ms-1"></i></button>
                                        <button class="btn btn-sm btn-secondary">{{ ui_text("set_alert", "تنظیم هشدار") }} <i class="fas fa-bell ms-1"></i></button>
                                    </div>
                                </div>
                                <div class="card-footer text-muted">
                                    <small>{{ ui_text('signal_validity', 'ایجاد شده: امروز {time} | اعتبار: {hours} ساعت').format(time='۱۷:۱۰', hours='۲۴') }}</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- News Tab -->
                <div class="tab-pane" id="news-pane" role="tabpanel" aria-labelledby="news-tab" style="display: none;">
                    <!-- Loading Spinner -->
                    <div id="news-loading" class="text-center py-5">
                        <span class="loader"></span>
                        <p class="mt-3 text-muted">{{ ui_text('loading_news', 'در حال بارگذاری اخبار...') }}</p>
                    </div>
                    
                    <!-- News Container -->
                    <div id="news-container"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // تابع به‌روزرسانی ارزهای ویژه (میم کوین‌ها و ارزهای هوش مصنوعی)
        function updateSpecialCoins() {
            console.log('Updating special coins (meme coins & AI coins)');
            const specialCoins = [
                // میم کوین‌ها
                'DOGE', 'SHIB', 'PEPE', 'FLOKI', 'WIF', 'MEME',
                // ارزهای هوش مصنوعی
                'RNDR', 'FET', 'OCEAN', 'AGIX',
                // ارزهای کم‌ارزش با پتانسیل رشد
                'VET', 'XDC', 'HBAR', 'XLM', 'JASMY'
            ];
            
            specialCoins.forEach((coin, index) => {
                setTimeout(() => {
                    console.log(`Directly updating ${coin} price`);
                    fetch(`/api/price/${coin.toLowerCase()}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data && data.success && data.data && data.data.price) {
                            const priceElement = document.getElementById(`${coin}-USDT-price`);
                            const changeElement = document.getElementById(`${coin}-USDT-change`);
                            
                            if (priceElement) {
                                const price = parseFloat(data.data.price);
                                priceElement.textContent = formatPrice(price);
                                console.log(`Successfully updated ${coin} price to ${price}`);
                            }
                            
                            if (changeElement) {
                                const change = parseFloat(data.data.change_24h || 0);
                                changeElement.textContent = formatChange(change);
                                
                                if (change >= 0) {
                                    changeElement.classList.add('positive-change');
                                    changeElement.classList.remove('negative-change');
                                } else {
                                    changeElement.classList.add('negative-change');
                                    changeElement.classList.remove('positive-change');
                                }
                            }
                        }
                    })
                    .catch(error => {
                        console.error(`Error updating ${coin}:`, error);
                    });
                }, index * 500); // 500ms delay between each request
            });
        }
        
        // به‌روزرسانی ارزهای ویژه هنگام بارگذاری صفحه
        setTimeout(updateSpecialCoins, 2000);
        
        // به‌روزرسانی ارزهای ویژه هر 30 ثانیه
        setInterval(updateSpecialCoins, 30000);
    
        // تابع تغییر بخش
        window.switchSection = function(sectionName) {
            console.log('Switching to section:', sectionName);
            
            // غیرفعال کردن همه دکمه‌ها
            document.querySelectorAll('.btn').forEach(btn => {
                if (btn.id.includes('-btn')) {
                    btn.classList.remove('btn-primary');
                    btn.classList.remove('active');
                    btn.classList.add('btn-outline-primary');
                }
            });
            
            // فعال کردن دکمه انتخاب شده
            const activeBtn = document.getElementById(sectionName + '-btn');
            if (activeBtn) {
                activeBtn.classList.remove('btn-outline-primary');
                activeBtn.classList.add('btn-primary');
                activeBtn.classList.add('active');
            }
            
            // مخفی کردن همه بخش‌ها
            document.querySelectorAll('.tab-pane').forEach(section => {
                section.style.display = 'none';
            });
            
            // نمایش بخش مورد نظر
            const targetPane = document.getElementById(sectionName + '-pane');
            if (targetPane) {
                targetPane.style.display = 'block';
                
                // به‌روزرسانی قیمت‌ها در بخش سیگنال‌ها
                if (sectionName === 'signals') {
                    updateSignalPrices();
                }
            }
        };
        
        // به‌روزرسانی قیمت‌های واقعی در کارت‌های سیگنال
        function updateSignalPrices() {
            try {
                console.log('Updating signal prices');
                
                // دریافت قیمت بیت‌کوین
                const btcPrice = document.getElementById('BTC-USDT-price')?.textContent;
                if (btcPrice && btcPrice !== '--') {
                    const btcSignalPrice = document.getElementById('btc-signal-price');
                    if (btcSignalPrice) {
                        console.log('Updating BTC price to:', btcPrice);
                        btcSignalPrice.textContent = btcPrice;
                    }
                }
                
                // دریافت قیمت اتریوم
                const ethPrice = document.getElementById('ETH-USDT-price')?.textContent;
                if (ethPrice && ethPrice !== '--') {
                    const ethSignalPrice = document.getElementById('eth-signal-price');
                    if (ethSignalPrice) {
                        console.log('Updating ETH price to:', ethPrice);
                        ethSignalPrice.textContent = ethPrice;
                    }
                }
            } catch (error) {
                console.error('Error updating signal prices:', error);
            }
        }
        
        // افزودن دکمه‌های آزمایشی برای مشاهده مستقیم بخش سیگنال‌ها
        const container = document.querySelector('.container');
        const testButtons = document.createElement('div');
        testButtons.className = 'row mt-3 mb-3';
        testButtons.innerHTML = `
            <div class="col-12 d-flex justify-content-center gap-2">
                <button class="btn btn-sm btn-danger" onclick="showSignalsDirectly()">
                    {{ ui_text("show_signals_directly", "نمایش مستقیم سیگنال‌ها") }}
                </button>
                <button class="btn btn-sm btn-warning" onclick="showTechnicalDirectly()">
                    {{ ui_text("show_technical_directly", "نمایش مستقیم تحلیل تکنیکال") }}
                </button>
            </div>
        `;
        container.prepend(testButtons);
        
        // افزودن توابع دسترسی سریع
        window.showSignalsDirectly = function() {
            document.getElementById('signals-pane').style.display = 'block';
            document.getElementById('technical-pane').style.display = 'none';
            document.getElementById('news-pane').style.display = 'none';
            updateSignalPrices();
        };
        
        window.showTechnicalDirectly = function() {
            document.getElementById('signals-pane').style.display = 'none';
            document.getElementById('technical-pane').style.display = 'block';
            document.getElementById('news-pane').style.display = 'none';
        };
        
        // تنظیم وضعیت اولیه بخش‌ها
        document.getElementById('technical-pane').style.display = 'block';
        document.getElementById('signals-pane').style.display = 'none';
        document.getElementById('news-pane').style.display = 'none';
        
        // به‌روزرسانی خودکار قیمت‌ها هر ۳۰ ثانیه
        setInterval(updateSignalPrices, 30000);
        
        // تابع برای ایجاد نمودار قیمت
        function createPriceChart(coinSymbol = 'BTC') {
            const ctx = document.getElementById('priceChart').getContext('2d');
            
            // داده‌های نمونه برای نمودار
            const labels = [];
            const prices = [];
            
            // ایجاد داده‌های تصادفی برای ۳۰ روز گذشته
            const today = new Date();
            let basePrice = 0;
            
            // تنظیم قیمت پایه بر اساس ارز
            switch(coinSymbol) {
                case 'BTC': basePrice = 65000; break;
                case 'ETH': basePrice = 3400; break;
                case 'SOL': basePrice = 150; break;
                case 'XRP': basePrice = 0.5; break;
                default: basePrice = 65000;
            }
            
            // ایجاد ۳۰ روز داده
            for (let i = 30; i >= 0; i--) {
                const date = new Date();
                date.setDate(today.getDate() - i);
                labels.push(date.toLocaleDateString('fa-IR'));
                
                // ایجاد قیمت با نوسان تصادفی حول قیمت پایه
                const randomFactor = 0.05; // ۵٪ نوسان
                const change = (Math.random() - 0.5) * randomFactor * basePrice;
                basePrice += change;
                if (basePrice < 0) basePrice = Math.abs(basePrice); // جلوگیری از قیمت منفی
                
                prices.push(basePrice);
            }
            
            // تنظیم رنگ‌ها
            const borderColor = coinSymbol === 'BTC' ? '#F7931A' : 
                               coinSymbol === 'ETH' ? '#627EEA' : 
                               coinSymbol === 'SOL' ? '#00FFB3' : '#0066FF';
                               
            const backgroundColor = coinSymbol === 'BTC' ? 'rgba(247, 147, 26, 0.1)' : 
                                  coinSymbol === 'ETH' ? 'rgba(98, 126, 234, 0.1)' : 
                                  coinSymbol === 'SOL' ? 'rgba(0, 255, 179, 0.1)' : 'rgba(0, 102, 255, 0.1)';
            
            // ایجاد نمودار
            try {
                if (window.priceChart instanceof Chart) {
                    window.priceChart.destroy();
                }
            } catch (error) {
                console.log('خطا در حذف نمودار قبلی:', error);
            }
            
            window.priceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: `${coinSymbol}/USDT Price`,
                        data: prices,
                        borderColor: borderColor,
                        backgroundColor: backgroundColor,
                        borderWidth: 2,
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            titleFont: {
                                family: 'Vazirmatn'
                            },
                            bodyFont: {
                                family: 'Vazirmatn'
                            },
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += new Intl.NumberFormat('en-US', { 
                                            minimumFractionDigits: 2,
                                            maximumFractionDigits: 2 
                                        }).format(context.parsed.y);
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            ticks: {
                                callback: function(value) {
                                    return new Intl.NumberFormat('en-US', { 
                                        minimumFractionDigits: 0,
                                        maximumFractionDigits: 0
                                    }).format(value);
                                }
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
            
            return window.priceChart;
        }
    
        // ایجاد نمودار قیمت اولیه (بیت‌کوین)
        setTimeout(() => {
            createPriceChart('BTC');
        }, 1500);
    
        // تنظیم رویدادهای کلیک روی تب‌های ارزی در تحلیل تکنیکال
        document.querySelectorAll('.btn-group[role="group"] button').forEach(button => {
            button.addEventListener('click', function() {
                // برداشتن وضعیت فعال از همه دکمه‌ها
                document.querySelectorAll('.btn-group[role="group"] button').forEach(btn => {
                    btn.classList.remove('active');
                    btn.classList.remove('btn-secondary');
                    btn.classList.add('btn-outline-secondary');
                });
                
                // فعال کردن دکمه انتخاب شده
                this.classList.remove('btn-outline-secondary');
                this.classList.add('btn-secondary');
                this.classList.add('active');
                
                // تغییر محتوای نمودار و عنوان بر اساس ارز انتخاب شده
                const coinText = this.textContent.trim();
                const titleElement = document.querySelector('#technical-pane .card-header h5');
                
                // به‌روزرسانی نمودار قیمت
                createPriceChart(coinText);
                
                if (titleElement) {
                    let coinName = 'بیت‌کوین';
                    if (coinText === 'ETH') coinName = 'اتریوم';
                    if (coinText === 'SOL') coinName = 'سولانا';
                    if (coinText === 'XRP') coinName = 'ریپل';
                    
                    titleElement.textContent = `تحلیل تکنیکال ${coinName} (تایم‌فریم ساعتی)`;
                }
            });
        });
    });
</script>
{% endblock %}
