# راهنمای نصب و راه‌اندازی Crypto Barzin روی سرور خارجی

این راهنما، مراحل نصب و راه‌اندازی سیستم پیام‌رسانی تلگرام Crypto Barzin را روی یک سرور خارجی توضیح می‌دهد.

## مقدمه

برای اجرای پایدار سیستم پیام‌رسانی تلگرام، توصیه می‌کنیم آن را روی یک سرور خارجی میزبانی کنید. در این راهنما از Fly.io به عنوان سرویس میزبانی استفاده می‌کنیم، اما می‌توانید از هر سرویس دیگری نیز استفاده کنید.

## نیازمندی‌ها

- یک سرور لینوکس (Ubuntu پیشنهاد می‌شود)
- Python 3.6 یا بالاتر
- پایتون و pip نصب شده باشند
- دسترسی SSH به سرور

## فایل‌های مورد نیاز

حداقل فایل‌های زیر را باید به سرور منتقل کنید:

1. **فایل‌های اصلی**:
   - `ten_minute_telegram_sender.py` - سرویس گزارش‌دهنده هر 10 دقیقه
   - `telegram_service_watchdog.py` - سیستم نظارت
   - `super_simple_telegram.py` - ماژول ارسال پیام ساده
   - `chart_generator.py` - ماژول ساخت نمودار (اختیاری)

2. **اسکریپت‌های راه‌اندازی و توقف**:
   - `اجرای_خودکار_همه_سرویس_های_تلگرام.sh`
   - `توقف_همه_سرویس_های_تلگرام.sh`
   - `اجرای_گزارش_دهنده_هر_۱۰_دقیقه.sh`
   - `توقف_گزارش_دهنده_هر_۱۰_دقیقه.sh`
   - `اجرای_نظارت_تلگرام.sh`
   - `توقف_نظارت_تلگرام.sh`

3. **فایل‌های راهنما (اختیاری)**:
   - `راهنمای_کامل_تلگرام.md`
   - `راهنمای_گزارش_دهنده_هر_۱۰_دقیقه.md`
   - `راهنمای_نظارت_تلگرام.md`

## مراحل نصب و راه‌اندازی

### 1. آماده‌سازی سرور

1. **نصب بسته‌های لازم**:
   ```bash
   sudo apt update
   sudo apt install -y python3 python3-pip git
   ```

2. **نصب کتابخانه‌های پایتون مورد نیاز**:
   ```bash
   pip3 install requests pandas numpy matplotlib mplfinance
   ```

### 2. انتقال فایل‌ها به سرور

#### روش 1: با استفاده از `scp`

```bash
# در کامپیوتر محلی، فایل‌ها را به سرور منتقل کنید
scp *.py *.sh *.md username@your-server-ip:/path/to/crypto-barzin/
```

#### روش 2: با استفاده از Git

1. **ابتدا کد را در یک مخزن Git قرار دهید (مثلاً GitHub)**

2. **در سرور، مخزن را کلون کنید**:
   ```bash
   git clone https://github.com/yourusername/crypto-barzin.git
   cd crypto-barzin
   ```

#### روش 3: با ایجاد مستقیم فایل‌ها

1. **به سرور وصل شوید**:
   ```bash
   ssh username@your-server-ip
   ```

2. **یک دایرکتوری جدید ایجاد کنید**:
   ```bash
   mkdir -p ~/crypto-barzin
   cd ~/crypto-barzin
   ```

3. **هر فایل را با یک ویرایشگر متن مانند `nano` ایجاد کنید**:
   ```bash
   nano ten_minute_telegram_sender.py
   # محتوای فایل را کپی کنید و با Ctrl+X ذخیره کنید
   ```

### 3. تنظیم دسترسی اجرا برای اسکریپت‌ها

```bash
cd /path/to/crypto-barzin/
chmod +x *.sh
```

### 4. پیکربندی سیستم

1. **تنظیم توکن بات تلگرام و چت آیدی**:
   ```bash
   nano ten_minute_telegram_sender.py
   # متغیرهای TOKEN و CHAT_ID را تغییر دهید
   ```

   ```bash
   nano super_simple_telegram.py
   # متغیرهای TOKEN و CHAT_ID را تغییر دهید
   ```

2. **تغییر فاصله زمانی ارسال گزارش‌ها (اختیاری)**:
   ```bash
   nano ten_minute_telegram_sender.py
   # مقدار time.sleep(600) را تغییر دهید (600 ثانیه = 10 دقیقه)
   ```

3. **تغییر فاصله زمانی نظارت (اختیاری)**:
   ```bash
   nano telegram_service_watchdog.py
   # مقدار time.sleep(3600) را تغییر دهید (3600 ثانیه = 1 ساعت)
   ```

### 5. راه‌اندازی سیستم

```bash
cd /path/to/crypto-barzin/
./اجرای_خودکار_همه_سرویس_های_تلگرام.sh
```

### 6. بررسی وضعیت سیستم

```bash
# بررسی فرآیندهای در حال اجرا
ps aux | grep telegram

# بررسی لاگ‌های سرویس گزارش‌دهنده
cat ten_minute_telegram_sender.log

# بررسی لاگ‌های سیستم نظارت
cat telegram_service_watchdog.log
```

### 7. اجرای خودکار در زمان راه‌اندازی سرور (اختیاری)

برای اجرای خودکار سرویس‌ها در زمان راه‌اندازی سرور، می‌توانید از `crontab` استفاده کنید:

```bash
crontab -e
```

سپس خط زیر را به آن اضافه کنید:

```
@reboot cd /path/to/crypto-barzin/ && ./اجرای_خودکار_همه_سرویس_های_تلگرام.sh
```

## راه‌اندازی روی Fly.io

Fly.io یک پلتفرم ابری است که می‌توانید اپلیکیشن‌های خود را در سراسر جهان میزبانی کنید. مراحل زیر برای راه‌اندازی روی Fly.io است:

### 1. نصب CLI لازم برای Fly.io

```bash
curl -L https://fly.io/install.sh | sh
```

### 2. ورود به حساب کاربری Fly.io

```bash
fly auth login
```

### 3. ایجاد یک برنامه جدید و آپلود کد

1. **ایجاد فایل `Dockerfile`**:
   ```bash
   nano Dockerfile
   ```

2. **محتوای فایل `Dockerfile`**:
   ```dockerfile
   FROM python:3.9-slim

   WORKDIR /app

   # Copy requirements if you have a requirements.txt
   # COPY requirements.txt .
   # RUN pip install -r requirements.txt

   # Alternatively, install packages directly
   RUN pip install requests pandas numpy matplotlib mplfinance

   # Copy application code
   COPY *.py /app/
   COPY *.sh /app/
   COPY *.md /app/

   # Make scripts executable
   RUN chmod +x *.sh

   # Run the application
   CMD ["./اجرای_خودکار_همه_سرویس_های_تلگرام.sh"]
   ```

3. **ایجاد فایل `fly.toml`**:
   ```bash
   nano fly.toml
   ```

4. **محتوای فایل `fly.toml`**:
   ```toml
   app = "crypto-barzin"

   [build]
     dockerfile = "Dockerfile"

   [env]
     TELEGRAM_TOKEN = "YOUR_TELEGRAM_BOT_TOKEN"
     TELEGRAM_CHAT_ID = "YOUR_TELEGRAM_CHAT_ID"

   [[services]]
     internal_port = 8080
     protocol = "tcp"

     [services.concurrency]
       hard_limit = 25
       soft_limit = 20

     [[services.ports]]
       handlers = ["http"]
       port = "80"

     [[services.ports]]
       handlers = ["tls", "http"]
       port = "443"
   ```

5. **دیپلوی برنامه**:
   ```bash
   fly launch
   ```

برای جزئیات بیشتر در مورد راه‌اندازی روی Fly.io، به داکیومنت رسمی مراجعه کنید:
https://fly.io/docs/languages-and-frameworks/python/

## عیب‌یابی

### مشکلات رایج و راه‌حل‌ها

1. **پیام‌ها ارسال نمی‌شوند**:
   - بررسی کنید که توکن بات و چت آیدی صحیح باشند
   - بررسی کنید که بات در چت یا گروه مورد نظر افزوده شده باشد
   - برای چت‌های شخصی، چت را با بات شروع کنید (دستور /start)
   - فایل‌های لاگ را بررسی کنید

2. **سرویس‌ها پس از اجرا سریع متوقف می‌شوند**:
   - بررسی کنید که خطایی در لاگ‌ها ثبت نشده باشد
   - بررسی کنید که همه وابستگی‌های پایتون نصب شده باشند
   - بررسی کنید که سرور محدودیتی برای اجرای فرآیندهای طولانی‌مدت نداشته باشد

3. **خطای دسترسی**:
   - بررسی کنید که اسکریپت‌ها دسترسی اجرا داشته باشند
   - بررسی کنید که کاربر جاری دسترسی نوشتن در دایرکتوری فعلی را داشته باشد

## منابع و اطلاعات بیشتر

- **API تلگرام**: https://core.telegram.org/bots/api
- **داکیومنت Fly.io**: https://fly.io/docs/
- **راهنمای کامل تلگرام Crypto Barzin**: `راهنمای_کامل_تلگرام.md`