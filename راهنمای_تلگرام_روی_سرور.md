# راهنمای اجرای سرویس تلگرام Crypto Barzin روی سرور خارجی

برای اجرای پایدار سرویس تلگرام Crypto Barzin، بهتر است آن را روی یک سرور خارجی مثل Fly.io میزبانی کنید. این راهنما مراحل اصلی را توضیح می‌دهد.

## پیش‌نیازها

1. حساب کاربری Fly.io
2. نصب flyctl روی سیستم 
3. دسترسی به توکن و چت آیدی تلگرام

## مراحل اجرا

### ۱. ساخت فایل اصلی اجرا

ابتدا یک فایل با نام `telegram_service.py` ایجاد کنید:

```python
#!/usr/bin/env python3
"""
سرویس تلگرام Crypto Barzin
"""

import time
import logging
import random
import os
import sys
from datetime import datetime, timedelta

# تنظیم لاگر
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    handlers=[
        logging.StreamHandler(),
        logging.FileHandler("telegram_service.log")
    ]
)
logger = logging.getLogger("telegram_service")

# واردسازی ماژول‌ها
try:
    import simple_telegram_sender as telegram
    import simple_telegram_formatter as formatter
    import chart_generator
    logger.info("ماژول‌های تلگرام با موفقیت بارگذاری شدند")
except ImportError as e:
    logger.error(f"خطا در بارگذاری ماژول‌های تلگرام: {str(e)}")
    sys.exit(1)

def run_telegram_service():
    """
    اجرای سرویس تلگرام
    """
    logger.info("شروع سرویس تلگرام Crypto Barzin")
    
    # ارسال پیام تست اولیه
    logger.info("ارسال پیام تست اولیه")
    test_result = formatter.send_test_message()
    logger.info(f"نتیجه ارسال پیام تست: {test_result}")
    
    # زمان‌های آخرین ارسال
    last_report_time = datetime.now() - timedelta(minutes=10)  # برای ارسال فوری گزارش اولیه
    last_alive_time = datetime.now()
    report_count = 1
    
    try:
        while True:
            # زمان فعلی
            now = datetime.now()
            
            # بررسی زمان ارسال گزارش (هر ۳۰ دقیقه یک بار)
            if now - last_report_time >= timedelta(minutes=30):
                logger.info(f"ارسال گزارش شماره {report_count}")
                
                try:
                    # ارسال گزارش بازار
                    market_result = formatter.send_market_overview()
                    logger.info(f"نتیجه ارسال گزارش بازار: {market_result}")
                    
                    # ارسال تحلیل یک ارز تصادفی
                    symbols = ["BTC/USDT", "ETH/USDT", "BNB/USDT", "XRP/USDT", "SOL/USDT"]
                    symbol = random.choice(symbols)
                    analysis_result = formatter.send_coin_analysis(symbol)
                    logger.info(f"نتیجه ارسال تحلیل {symbol}: {analysis_result}")
                    
                    # ارسال سیگنال‌های معاملاتی
                    signals_result = formatter.send_trading_signals()
                    logger.info(f"نتیجه ارسال سیگنال‌ها: {signals_result}")
                    
                    last_report_time = now
                    report_count += 1
                except Exception as e:
                    logger.error(f"خطا در ارسال گزارش: {str(e)}")
            
            # بررسی زمان ارسال پیام زنده بودن (هر ۶ ساعت)
            if now - last_alive_time >= timedelta(hours=6):
                logger.info("ارسال پیام زنده بودن سیستم")
                
                try:
                    current_time = now.strftime("%Y-%m-%d %H:%M:%S")
                    message = f"""
🤖 <b>Crypto Barzin - وضعیت سیستم</b>
━━━━━━━━━━━━━━━━━━

سیستم گزارش‌دهی روی سرور خارجی در حال اجرا است.
تا کنون {report_count-1} گزارش ارسال شده است.

⏰ <b>زمان کنونی:</b> {current_time}

گزارش‌های اصلی هر ۳۰ دقیقه یکبار ارسال می‌شوند.
                    """
                    
                    alive_result = telegram.send_message(text=message, parse_mode="HTML")
                    logger.info(f"نتیجه ارسال پیام زنده بودن: {alive_result}")
                    
                    last_alive_time = now
                except Exception as e:
                    logger.error(f"خطا در ارسال پیام زنده بودن: {str(e)}")
            
            # انتظار برای یک دقیقه
            time.sleep(60)
            
    except KeyboardInterrupt:
        logger.info("سرویس با دستور کاربر متوقف شد")
    except Exception as e:
        logger.error(f"خطا در اجرای سرویس: {str(e)}")
        raise

if __name__ == "__main__":
    run_telegram_service()
```

### ۲. ساخت Dockerfile

سپس یک فایل `Dockerfile` ایجاد کنید:

```Dockerfile
FROM python:3.11-slim

WORKDIR /app

COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

COPY . .

CMD ["python", "telegram_service.py"]
```

### ۳. ساخت فایل requirements.txt

```
python-telegram-bot>=14.0
matplotlib
mplfinance
numpy
pandas
ccxt
requests
```

### ۴. ساخت فایل متغیرهای محیطی (.env)

```
TELEGRAM_BOT_TOKEN=7429658178:AAFc8hfXeog2Cu8EWOcXQbMc5Nn-q-f1ePk
DEFAULT_CHAT_ID=722627622
```

### ۵. ساخت فایل fly.toml

```toml
app = "crypto-barzin"
primary_region = "yyz"  # Toronto

[env]
  TELEGRAM_BOT_TOKEN = "7429658178:AAFc8hfXeog2Cu8EWOcXQbMc5Nn-q-f1ePk"
  DEFAULT_CHAT_ID = "722627622"

[build]

[http_service]
  internal_port = 8080
  force_https = true
  auto_stop_machines = false
  auto_start_machines = true
  min_machines_running = 1
```

### ۶. دستورات اجرا

```bash
# مرحله ۱: ورود به حساب Fly.io
fly auth login

# مرحله ۲: راه‌اندازی پروژه
fly launch

# مرحله ۳: دیپلوی برنامه
fly deploy

# مرحله ۴: مشاهده لاگ‌ها
fly logs
```

## نکات مهم

1. حتماً توکن تلگرام و چت آیدی را در فایل `.env` و `fly.toml` به مقادیر صحیح تغییر دهید.
2. اطمینان حاصل کنید که تمام فایل‌های مورد نیاز (simple_telegram_sender.py, simple_telegram_formatter.py, chart_generator.py) در مسیر اصلی پروژه کپی شده‌اند.
3. برای جلوگیری از محدودیت‌های API، می‌توانید از API Key مخصوص CoinGecko یا سایر سرویس‌های قیمت استفاده کنید.

## مانیتورینگ

برای اطمینان از پایداری سرویس، می‌توانید از ابزارهای مانیتورینگ Fly.io استفاده کنید:

```bash
# مشاهده وضعیت برنامه
fly status

# مشاهده متریک‌ها
fly metrics
```