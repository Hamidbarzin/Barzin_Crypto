#!/usr/bin/env python
# -*- coding: utf-8 -*-

"""
Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒ Ø³Ø§Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ø§Ø±Ø³Ø§Ù„ Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§ÛŒ Ø¯ÙˆØ±Ù‡â€ŒØ§ÛŒ ØªÙ„Ú¯Ø±Ø§Ù…

Ø§ÛŒÙ† Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ø¨Ù‡ Ø·ÙˆØ± Ø®ÙˆØ¯Ú©Ø§Ø± Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§ÛŒ Ø¯ÙˆØ±Ù‡â€ŒØ§ÛŒØŒ ØªØ­Ù„ÛŒÙ„ ØªÚ©Ù†ÛŒÚ©Ø§Ù„ Ùˆ Ø³ÛŒÚ¯Ù†Ø§Ù„â€ŒÙ‡Ø§ÛŒ Ù…Ø¹Ø§Ù…Ù„Ø§ØªÛŒ Ø±Ø§
Ø¨Ø§ ÙØ§ØµÙ„Ù‡â€ŒÙ‡Ø§ÛŒ Ø²Ù…Ø§Ù†ÛŒ Ù…Ø´Ø®Øµ Ø¨Ù‡ ØªÙ„Ú¯Ø±Ø§Ù… Ø§Ø±Ø³Ø§Ù„ Ù…ÛŒâ€ŒÚ©Ù†Ø¯.
"""

import time
import schedule
import logging
import traceback
import random
from datetime import datetime

# ØªÙ†Ø¸ÛŒÙ… Ù„Ø§Ú¯Ø±
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    handlers=[
        logging.StreamHandler(),
        logging.FileHandler("scheduler.log")
    ]
)
logger = logging.getLogger("simple_scheduler")

# Ù„ÛŒØ³Øª Ø§Ø±Ø²Ù‡Ø§ÛŒ Ù…ÙˆØ±Ø¯ Ù¾Ø§ÛŒØ´
WATCHED_CURRENCIES = ["BTC/USDT", "ETH/USDT", "BNB/USDT", "XRP/USDT", "SOL/USDT"]

def send_price_report():
    """
    Ø§Ø±Ø³Ø§Ù„ Ú¯Ø²Ø§Ø±Ø´ Ù‚ÛŒÙ…Øªâ€ŒÙ‡Ø§ Ù‡Ø± Ø³Ø§Ø¹Øª
    """
    try:
        logger.info("Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„ Ú¯Ø²Ø§Ø±Ø´ Ù‚ÛŒÙ…Øªâ€ŒÙ‡Ø§...")
        import telegram_reporter
        return telegram_reporter.send_periodic_report()
    except Exception as e:
        logger.error(f"Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ú¯Ø²Ø§Ø±Ø´ Ù‚ÛŒÙ…Øªâ€ŒÙ‡Ø§: {str(e)}")
        logger.error(traceback.format_exc())
        return False

def send_technical_analysis():
    """
    Ø§Ø±Ø³Ø§Ù„ ØªØ­Ù„ÛŒÙ„ ØªÚ©Ù†ÛŒÚ©Ø§Ù„ ÛŒÚ© Ø§Ø±Ø² ØªØµØ§Ø¯ÙÛŒ Ù‡Ø± 4 Ø³Ø§Ø¹Øª
    """
    try:
        # Ø§Ù†ØªØ®Ø§Ø¨ ÛŒÚ© Ø§Ø±Ø² ØªØµØ§Ø¯ÙÛŒ
        symbol = random.choice(WATCHED_CURRENCIES)
        
        logger.info(f"Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„ ØªØ­Ù„ÛŒÙ„ ØªÚ©Ù†ÛŒÚ©Ø§Ù„ {symbol}...")
        import telegram_reporter
        return telegram_reporter.send_technical_analysis(symbol)
    except Exception as e:
        logger.error(f"Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ ØªØ­Ù„ÛŒÙ„ ØªÚ©Ù†ÛŒÚ©Ø§Ù„: {str(e)}")
        logger.error(traceback.format_exc())
        return False

def send_market_overview():
    """
    Ø§Ø±Ø³Ø§Ù„ Ú¯Ø²Ø§Ø±Ø´ Ú©Ù„ÛŒ Ø¨Ø§Ø²Ø§Ø± Ù‡Ø± 2 Ø³Ø§Ø¹Øª
    """
    try:
        logger.info("Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„ Ú¯Ø²Ø§Ø±Ø´ Ú©Ù„ÛŒ Ø¨Ø§Ø²Ø§Ø±...")
        import telegram_reporter
        
        # Ø¯Ø±ÛŒØ§ÙØª Ú¯Ø²Ø§Ø±Ø´ Ú©Ù„ÛŒ Ø¨Ø§Ø²Ø§Ø±
        market_report = telegram_reporter.get_market_overview()
        
        # Ø§Ø±Ø³Ø§Ù„ Ú¯Ø²Ø§Ø±Ø´ Ø¨Ù‡ ØªÙ„Ú¯Ø±Ø§Ù…
        chat_id = int(os.environ.get("DEFAULT_CHAT_ID", "722627622"))
        return telegram_reporter.send_telegram_message(chat_id, market_report)
    except Exception as e:
        logger.error(f"Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ú¯Ø²Ø§Ø±Ø´ Ú©Ù„ÛŒ Ø¨Ø§Ø²Ø§Ø±: {str(e)}")
        logger.error(traceback.format_exc())
        return False

def send_alive_message():
    """
    Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø²Ù†Ø¯Ù‡ Ø¨ÙˆØ¯Ù† Ø³ÛŒØ³ØªÙ… Ù‡Ø± 12 Ø³Ø§Ø¹Øª
    """
    try:
        logger.info("Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø²Ù†Ø¯Ù‡ Ø¨ÙˆØ¯Ù† Ø³ÛŒØ³ØªÙ…...")
        import telegram_reporter
        
        message = "ğŸ¤– *ÙˆØ¶Ø¹ÛŒØª Ø³ÛŒØ³ØªÙ…*\n\n"
        message += "Ø³ÛŒØ³ØªÙ… Ø±Ø¨Ø§Øª Ù…Ø¹Ø§Ù…Ù„Ù‡ Ø§Ø±Ø² Ø¯ÛŒØ¬ÛŒØªØ§Ù„ Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§ Ø§Ø³Øª.\n"
        message += f"Ø²Ù…Ø§Ù† Ú©Ù†ÙˆÙ†ÛŒ: {telegram_reporter.get_current_persian_time()}\n"
        message += "Ø§ÛŒÙ† Ù¾ÛŒØ§Ù… Ø¨Ù‡ ØµÙˆØ±Øª Ø®ÙˆØ¯Ú©Ø§Ø± Ù‡Ø± 12 Ø³Ø§Ø¹Øª Ø§Ø±Ø³Ø§Ù„ Ù…ÛŒâ€ŒØ´ÙˆØ¯."
        
        # Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø¨Ù‡ ØªÙ„Ú¯Ø±Ø§Ù…
        chat_id = int(os.environ.get("DEFAULT_CHAT_ID", "722627622"))
        return telegram_reporter.send_telegram_message(chat_id, message)
    except Exception as e:
        logger.error(f"Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø²Ù†Ø¯Ù‡ Ø¨ÙˆØ¯Ù† Ø³ÛŒØ³ØªÙ…: {str(e)}")
        logger.error(traceback.format_exc())
        return False

def setup_schedule():
    """
    ØªÙ†Ø¸ÛŒÙ… Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒ ÙˆØ¸Ø§ÛŒÙ
    """
    logger.info("Ø¯Ø± Ø­Ø§Ù„ ØªÙ†Ø¸ÛŒÙ… Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒ ÙˆØ¸Ø§ÛŒÙ...")
    
    # Ø§Ø±Ø³Ø§Ù„ Ú¯Ø²Ø§Ø±Ø´ Ù‚ÛŒÙ…Øªâ€ŒÙ‡Ø§ Ù‡Ø± 30 Ø¯Ù‚ÛŒÙ‚Ù‡
    schedule.every(30).minutes.do(send_price_report)
    
    # Ø§Ø±Ø³Ø§Ù„ ØªØ­Ù„ÛŒÙ„ ØªÚ©Ù†ÛŒÚ©Ø§Ù„ Ù‡Ø± 4 Ø³Ø§Ø¹Øª
    schedule.every(4).hours.do(send_technical_analysis)
    
    # Ø§Ø±Ø³Ø§Ù„ Ú¯Ø²Ø§Ø±Ø´ Ú©Ù„ÛŒ Ø¨Ø§Ø²Ø§Ø± Ù‡Ø± 2 Ø³Ø§Ø¹Øª
    schedule.every(2).hours.do(send_market_overview)
    
    # Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø²Ù†Ø¯Ù‡ Ø¨ÙˆØ¯Ù† Ø³ÛŒØ³ØªÙ… Ù‡Ø± 12 Ø³Ø§Ø¹Øª
    schedule.every(12).hours.do(send_alive_message)
    
    logger.info("Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒ ÙˆØ¸Ø§ÛŒÙ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ØªÙ†Ø¸ÛŒÙ… Ø´Ø¯")
    
    # Ø§Ø±Ø³Ø§Ù„ Ø§ÙˆÙ„ÛŒÙ† Ú¯Ø²Ø§Ø±Ø´ Ù‚ÛŒÙ…Øªâ€ŒÙ‡Ø§ Ø¨Ù„Ø§ÙØ§ØµÙ„Ù‡
    send_price_report()
    
    # Ø§Ø±Ø³Ø§Ù„ Ø§ÙˆÙ„ÛŒÙ† Ú¯Ø²Ø§Ø±Ø´ Ú©Ù„ÛŒ Ø¨Ø§Ø²Ø§Ø± Ø¨Ù„Ø§ÙØ§ØµÙ„Ù‡
    send_market_overview()

def main():
    """
    ØªØ§Ø¨Ø¹ Ø§ØµÙ„ÛŒ Ø¨Ø±Ù†Ø§Ù…Ù‡
    """
    logger.info("Ø´Ø±ÙˆØ¹ Ø§Ø¬Ø±Ø§ÛŒ Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒ Ø³Ø§Ø¯Ù‡")
    
    # ØªÙ†Ø¸ÛŒÙ… Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒ ÙˆØ¸Ø§ÛŒÙ
    setup_schedule()
    
    # Ø§Ø¬Ø±Ø§ÛŒ Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒ
    try:
        while True:
            schedule.run_pending()
            time.sleep(60)  # Ø¨Ø±Ø±Ø³ÛŒ Ù‡Ø± Ø¯Ù‚ÛŒÙ‚Ù‡
    except KeyboardInterrupt:
        logger.info("Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒ Ø¨Ø§ Ø¯Ø³ØªÙˆØ± Ú©Ø§Ø±Ø¨Ø± Ù…ØªÙˆÙ‚Ù Ø´Ø¯")
    except Exception as e:
        logger.error(f"Ø®Ø·Ø§ Ø¯Ø± Ø§Ø¬Ø±Ø§ÛŒ Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒ: {str(e)}")
        logger.error(traceback.format_exc())
    
    logger.info("Ù¾Ø§ÛŒØ§Ù† Ø§Ø¬Ø±Ø§ÛŒ Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒ Ø³Ø§Ø¯Ù‡")

if __name__ == "__main__":
    import os  # Ø¨Ø±Ø§ÛŒ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ù…Ø­ÛŒØ·ÛŒ
    main()